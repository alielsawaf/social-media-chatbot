from flask import Flask, request, jsonify
from fuzzywuzzy import fuzz

app = Flask(__name__)

# --------------------------------------------------------------------------------
# قاعدة بيانات الأسئلة والأجوبة (FAQ Knowledge Base)
# تم تحديث قسم الأسعار بناءً على مدخلاتك الجديدة
# --------------------------------------------------------------------------------

FAQ = [
    # --------------------------------------------------------------------------------
    # 1. قسم تبرير الأسعار (النية الجديدة: price_justification) - شامل لجميع الصيغ والرد المخصص
    # --------------------------------------------------------------------------------
    {
        'questions': [
            'الأسعار غالية',
            'منتجاتكم سعرها عالي',
            'ليه بتبيعوا أغلى من غيركم؟',
            'السعر مبالغ فيه شوية',
            'الأسعار نار',
            'ما هو سبب ارتفاع أسعار منتجاتكم؟',
            'ليه المنتجات بتاعتكوا غالية؟',
            'اسعاركم غاليه جدا',
            'أسعاركم أعلى من المنافسين بكتير، إيه السبب؟',
            'هل يمكن شرح سبب الفارق في الأسعار عن باقي الشركات؟',
            'الفلوس الكتير دي مقابل إيه في الجودة؟',
            'ما هي القيمة المضافة التي تبرر هذا السعر المرتفع؟',
            'هل منتجاتكم تستاهل السعر ده؟',
            'سعركم في المنتج ده مبالغ فيه أوي',
            'الاسعار مبالغ فيها',
            'هي الاسعار دي بجد',
            'بجد المنتج ده سعره كده؟',
            'السعر ده مش كتير حبتين؟',
            'بصراحة، شايفين إن سعركم عالي شوية',
            'إيه الحكاية في الأسعار دي؟',
            'لماذا تبدو أسعاركم غير تنافسية؟',
            'ليه دايماً في زيادة أسعار؟',
            'ليه الرنجة بتاتكم غاليه',
            'Lih el as3ar de',
            'Are these prices final',
            'I think your prices are inflated',
            'Why is this product so costly',
            "What's the reason for the high cost",
            'Msh 3aref eh sabab en el as3ar keda',
            'As3arko 3alya leih',
            'Leh el montagat bta3tko ghalya'
        ],
        'answer': (
            "لاننا بنضمنلك جودة منتج يا فندم حيث ان طريقة التمليح و التدخين مختلفة. "
            "احنا بنملح سمك الرنجة بمحلول براين و بيتم تدخين السمك علي البارد بنشارة ألماني، "
            "عشان نضمن لحضرتك منتج صحي مدخن بشكل صحيح جاهز علي الأكل."
        )
    },
    
    # --------------------------------------------------------------------------------
    # 2. مثال: قسم الشكوى على وجود الدود أو الطفيليات (كما كان سابقاً)
    # --------------------------------------------------------------------------------
    {
        'questions': [
            'هل يوجد دود في الرنجة؟',
            'ما هي الطفيليات في السمك؟',
            'هل السمك سليم؟',
            'شكوي بخصوص دود الرنجة',
            'الرنجة فيها دود'
        ],
        'answer': (
            "مساء الخير يا فندم، هذا ليس دوداً بل طفيليات. الطفيليات في سمكة الرنجة توجد في التجويف البطني لأنها تدخل في عمليات الامتصاص والتمثيل الغذائي للسمكة وهي لا تصيب الإنسان. "
            "لزيادة الوقاية، يتم تجميد الأسماك عند درجة من 35 إلى 40 تحت الصفر لتصبح الطفيليات جزءاً من الأمعاء ولا تؤثر على آكلها.\n"
            "السمكة تكون غير صالحة للاستهلاك فقط في حال ظهر بها دود حي، ويحدث ذلك عندما تمر السمكة بمراحل الانتفاخ والتعفن. "
            "يمكنك الاطلاع على قرار منظمة سلامة الغذاء للتأكد: [قرار منظمة سلامة الغذاء](https://drive.google.com/file/d/1TMfHL964lcaMxap6H5XruiV9Z3kcIiYX/view?usp=drive_link)"
        )
    },
    
    # --------------------------------------------------------------------------------
    # 3. مثال: قسم معلومات الشكاوى الأخرى (كما كان سابقاً)
    # --------------------------------------------------------------------------------
    {
        'questions': [
            'أين أقدم شكوى؟',
            'لدي شكوى بخصوص المنتج',
            'أريد التحدث مع مسؤول',
            'ازاي اقدم شكوي'
        ],
        'answer': (
            "لتقديم أي شكوى بخصوص المنتج، يُرجى التواصل مباشرة على رقم الفروع لتسجيل الشكوى. "
            "سيتم تحويل شكواك للمسؤول المختص مباشرة.\n"
            "نتأسف لأي إزعاج حدث لك، ونعدك بسرعة حل المشكلة."
        )
    }
    # يمكنك إضافة أقسام أخرى هنا
]

# --------------------------------------------------------------------------------
# الدالة الرئيسية للبحث والمقارنة (باستخدام FuzzyWuzzy)
# --------------------------------------------------------------------------------

def get_answer(user_question):
    """
    يبحث عن الإجابة الأقرب لسؤال المستخدم في قاعدة البيانات FAQ.
    :param user_question: سؤال العميل.
    :return: الإجابة المطابقة أو رسالة عدم وجود تطابق.
    """
    best_match_score = 0
    best_answer = None

    # تطبيع وتحضير سؤال المستخدم للبحث
    normalized_query = user_question.strip().lower()

    for item in FAQ:
        for question_phrase in item['questions']:
            # نحسب درجة التشابه باستخدام fuzzywuzzy.ratio
            score = fuzz.ratio(normalized_query, question_phrase.lower())
            
            # إذا كانت درجة التشابه أعلى من أفضل درجة سابقة، نقوم بتحديثها
            if score > best_match_score:
                best_match_score = score
                best_answer = item['answer']
    
    # تحديد الحد الأدنى لدرجة التشابه المقبولة
    MATCH_THRESHOLD = 75 

    if best_match_score >= MATCH_THRESHOLD:
        return {
            'answer': best_answer,
            'confidence_score': best_match_score
        }
    else:
        # رسالة الرد في حالة عدم وجود تطابق قوي
        return {
            'answer': (
                "عفواً، لم أتمكن من إيجاد إجابة دقيقة لسؤالك حالياً. "
                "الرجاء إعادة صياغة السؤال أو التواصل مع خدمة العملاء لتقديم شكوى أو استفسار."
            ),
            'confidence_score': best_match_score
        }

# --------------------------------------------------------------------------------
# مسار Flask الرئيسي لتلقي الأسئلة
# --------------------------------------------------------------------------------

@app.route('/ask', methods=['POST'])
def ask_chatbot():
    data = request.get_json()
    user_query = data.get('question', '')
    
    if not user_query:
        return jsonify({'error': 'الرجاء إرسال السؤال في حقل "question"'}), 400

    result = get_answer(user_query)
    
    return jsonify(result)

# --------------------------------------------------------------------------------
# تشغيل التطبيق
# --------------------------------------------------------------------------------

if __name__ == '__main__':
    # لتشغيل التطبيق على localhost:5000 
    app.run(debug=True)
