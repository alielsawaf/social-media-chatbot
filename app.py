from flask import Flask, request, jsonify
from fuzzywuzzy import fuzz
import requests
import re # Ù„Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ù„Ù„ØªØ¹Ø¨ÙŠØ±Ø§Øª Ø§Ù„Ù†Ù…Ø·ÙŠØ© (Regular Expressions)

# --------------------------------------------------------------------------------
# Ø¹Ù„Ø§Ù…Ø© ØªØ£ÙƒÙŠØ¯ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
print(">>> CODE VERSION 5.0: FULL FAQ, SYNTAX FIXED, GREETINGS & CLEANING ADDED <<<")
# --------------------------------------------------------------------------------

app = Flask(__name__)

# --------------------------------------------------------------------------------
# âš ï¸âš ï¸ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ù„Ù„Ø±Ø¯ âš ï¸âš ï¸
# ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ø§Ù„Ù€ Access Token Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØµÙØ­Ø© Ù‡Ù†Ø§
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
# --------------------------------------------------------------------------------

# --------------------------------------------------------------------------------
# Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªØ­ÙŠØ© Ø§Ù„Ù…Ù†ÙØµÙ„Ø© (Greetings)
# --------------------------------------------------------------------------------

GREETINGS = {
    'morning': [
        'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±', 'ØµØ¨Ø§Ø­ Ø§Ù„ÙÙ„', 'ØµØ¨Ø§Ø­ Ø§Ù„Ø¬Ù…Ø§Ù„', 'ØµØ¨Ø§Ø­ Ø§Ù„Ø¹Ø³Ù„', 'ØµØ¨Ø§Ø­ Ø§Ù„ÙŠØ§Ø³Ù…ÙŠÙ†', 'ØµØ¨Ø§Ø­ Ø§Ù„Ø¯Ù„Ø¹',
        'ØµØ¨Ø§Ø­ Ø§Ù„Ù†ÙˆØ±' # Ø£Ø¶ÙŠÙØª Ù…Ù† Ø·Ù„Ø¨Ùƒ
    ],
    'evening': [
        'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±', 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ù†ÙˆØ±', 'Ù…Ø³Ø§Ø¡ Ø§Ù„ÙÙ„', 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø¬Ù…Ø§Ù„', 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø¹Ø³Ù„', 'Ù…Ø³Ø§Ø¡ Ø§Ù„ÙŠØ§Ø³Ù…ÙŠÙ†', 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø¯Ù„Ø¹',
    ],
    'greetings': [
        'Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…', 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…', 'Ø³Ù„Ø§Ù†Ùˆ Ø¹Ù„ÙŠÙƒÙˆ', 'Ø³Ù„Ø§Ù…', 'Ø³Ù„Ø§Ù…Ø§Øª',
    ],
}

# --------------------------------------------------------------------------------
# Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø¬ÙˆØ¨Ø© (FAQ Knowledge Base)
# --------------------------------------------------------------------------------

FAQ = [
    # ------------------ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ------------------
    {
        'questions': [
            'Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØºØ§Ù„ÙŠØ©', 'Ù…Ù†ØªØ¬Ø§ØªÙƒÙ… Ø³Ø¹Ø±Ù‡Ø§ Ø¹Ø§Ù„ÙŠ', 'Ù„ÙŠÙ‡ Ø¨ØªØ¨ÙŠØ¹ÙˆØ§ Ø£ØºÙ„Ù‰ Ù…Ù† ØºÙŠØ±ÙƒÙ…ØŸ',
            'Ø§Ù„Ø³Ø¹Ø± Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡ Ø´ÙˆÙŠØ©', 'Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù†Ø§Ø±', 'Ù…Ø§ Ù‡Ùˆ Ø³Ø¨Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø£Ø³Ø¹Ø§Ø± Ù…Ù†ØªØ¬Ø§ØªÙƒÙ…ØŸ',
            'Ù„ÙŠÙ‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨ØªØ§Ø¹ØªÙƒÙˆØ§ ØºØ§Ù„ÙŠØ©ØŸ', 'Ø§Ø³Ø¹Ø§Ø±ÙƒÙ… ØºØ§Ù„ÙŠÙ‡ Ø¬Ø¯Ø§',
            'Ø£Ø³Ø¹Ø§Ø±ÙƒÙ… Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ† Ø¨ÙƒØªÙŠØ±ØŒ Ø¥ÙŠÙ‡ Ø§Ù„Ø³Ø¨Ø¨ØŸ',
            'Ù‡Ù„ ÙŠÙ…ÙƒÙ† Ø´Ø±Ø­ Ø³Ø¨Ø¨ Ø§Ù„ÙØ§Ø±Ù‚ ÙÙŠ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¹Ù† Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø±ÙƒØ§ØªØŸ',
            'Ø§Ù„ÙÙ„ÙˆØ³ Ø§Ù„ÙƒØªÙŠØ± Ø¯ÙŠ Ù…Ù‚Ø§Ø¨Ù„ Ø¥ÙŠÙ‡ ÙÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©ØŸ',
            'Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø§Ù„ØªÙŠ ØªØ¨Ø±Ø± Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø±ØªÙØ¹ØŸ',
            'Ù‡Ù„ Ù…Ù†ØªØ¬Ø§ØªÙƒÙ… ØªØ³ØªØ§Ù‡Ù„ Ø§Ù„Ø³Ø¹Ø± Ø¯Ù‡ØŸ', 'Ø³Ø¹Ø±ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ù‡ Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡ Ø£ÙˆÙŠ',
            'Ø§Ù„Ø§Ø³Ø¹Ø§Ø± Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡Ø§', 'Ù‡ÙŠ Ø§Ù„Ø§Ø³Ø¹Ø§Ø± Ø¯ÙŠ Ø¨Ø¬Ø¯', 'Ø¨Ø¬Ø¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ù‡ Ø³Ø¹Ø±Ù‡ ÙƒØ¯Ù‡ØŸ',
            'Ø§Ù„Ø³Ø¹Ø± Ø¯Ù‡ Ù…Ø´ ÙƒØªÙŠØ± Ø­Ø¨ØªÙŠÙ†ØŸ', 'Ø¨ØµØ±Ø§Ø­Ø©ØŒ Ø´Ø§ÙŠÙÙŠÙ† Ø¥Ù† Ø³Ø¹Ø±ÙƒÙ… Ø¹Ø§Ù„ÙŠ Ø´ÙˆÙŠØ©',
            'Ø¥ÙŠÙ‡ Ø§Ù„Ø­ÙƒØ§ÙŠØ© ÙÙŠ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¯ÙŠØŸ', 'Ù„Ù…Ø§Ø°Ø§ ØªØ¨Ø¯Ùˆ Ø£Ø³Ø¹Ø§Ø±ÙƒÙ… ØºÙŠØ± ØªÙ†Ø§ÙØ³ÙŠØ©ØŸ',
            'Ù„ÙŠÙ‡ Ø¯Ø§ÙŠÙ…Ø§Ù‹ ÙÙŠ Ø²ÙŠØ§Ø¯Ø© Ø£Ø³Ø¹Ø§Ø±ØŸ', 'Ù„ÙŠÙ‡ Ø§Ù„Ø±Ù†Ø¬Ø© Ø¨ØªØ§ØªÙƒÙ… ØºØ§Ù„ÙŠÙ‡',
            'Lih el as3ar de', 'Are these prices final', 'I think your prices are inflated',
            'Why is this product so costly', "What's the reason for the high cost",
            'Msh 3aref eh sabab en el as3ar keda', 'As3arko 3alya leih',
            'Leh el montagat bta3tko ghalya'
        ],
        'answer': (
            "Ø§Ù‡Ù„Ø§ Ø¨Ø­Ø¶Ø±ØªÙƒ Ø³Ø¹Ø¯Ø§Ø¡ Ø¨ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹Ù†Ø§ ÙˆØ¬Ø§Ù‡Ø²ÙŠÙ† Ø¯Ø§ÙŠÙ…Ø§ Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙƒ Ø§Ø­Ù†Ø§ Ø§Ø³Ø¹Ø§Ø±Ù†Ø§ ØºØ§Ù„ÙŠÙ‡ Ù„Ø§Ø§Ù†Ù†Ø§ Ø¨Ù†Ø¶Ù…Ù†Ù„Ùƒ Ø¬ÙˆØ¯Ø© Ù…Ù†ØªØ¬ ÙŠØ§ ÙÙ†Ø¯Ù… Ø­ÙŠØ« Ø§Ù† Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ…Ù„ÙŠØ­ Ùˆ Ø§Ù„ØªØ¯Ø®ÙŠÙ† Ù…Ø®ØªÙ„ÙØ©. "
            "Ø§Ø­Ù†Ø§ Ø¨Ù†Ù…Ù„Ø­ Ø³Ù…Ùƒ Ø§Ù„Ø±Ù†Ø¬Ø© Ø¨Ù…Ø­Ù„ÙˆÙ„ Ø¨Ø±Ø§ÙŠÙ† Ùˆ Ø¨ÙŠØªÙ… ØªØ¯Ø®ÙŠÙ† Ø§Ù„Ø³Ù…Ùƒ Ø¹Ù„ÙŠ Ø§Ù„Ø¨Ø§Ø±Ø¯ Ø¨Ù†Ø´Ø§Ø±Ø© Ø£Ù„Ù…Ø§Ù†ÙŠØŒ "
            "Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† Ù„Ø­Ø¶Ø±ØªÙƒ Ù…Ù†ØªØ¬ ØµØ­ÙŠ Ù…Ø¯Ø®Ù† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¬Ø§Ù‡Ø² Ø¹Ù„ÙŠ Ø§Ù„Ø£ÙƒÙ„."
        )
    },
    # ------------------ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø·ÙÙŠÙ„ÙŠØ§Øª/Ø§Ù„Ø¯ÙˆØ¯ ------------------
    {
        'questions': [
            'Ø§Ù„Ø±Ù†Ø¬Ø© ÙÙŠÙ‡Ø§ Ø¯ÙˆØ¯', 'Ø§Ù„Ø±Ù†Ø¬Ø© Ø¯ÙŠ Ø·ÙÙŠÙ„ÙŠØ§ØªØŸ', 'Feha dud?', 'Is there any worm in the fish?',
            'Ø§Ù„Ø³Ù…Ùƒ Ø¯Ù‡ Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† ÙÙŠÙ‡ Ø¯ÙˆØ¯ Ø­ÙŠØŸ', 'Ù„ÙŠÙ‡ ÙÙŠ Ø­Ø§Ø¬Ø§Øª Ø¨ØªØªØ­Ø±Ùƒ ÙÙŠ Ø§Ù„Ø±Ù†Ø¬Ø©ØŸ',
            'Ù„Ù‚ÙŠØª Ø¯ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ù†Ø¬Ø© Ø¨ØªØ§Ø¹ØªÙƒÙˆØ§!', 'ÙÙŠ Ø­Ø§Ø¬Ø© ØºØ±ÙŠØ¨Ø© Ø¬ÙˆØ§ Ø§Ù„Ø³Ù…ÙƒØ© Ø´ÙƒÙ„Ù‡Ø§ Ø²ÙŠ Ø§Ù„Ø¯ÙˆØ¯.',
            'Ø£Ù†Ø§ Ù‚Ù„Ù‚Ø§Ù† Ù…Ù† Ø´ÙƒÙ„ Ø§Ù„Ù†Ù‚Ø· Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ Ø¯ÙŠ.', 'Ù‡Ù„ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù†Ø¬Ø© Ø¯ÙŠ ÙƒÙˆÙŠØ³Ø© ÙˆÙ„Ø§ ÙÙŠÙ‡Ø§ Ù…Ø´Ø§ÙƒÙ„ØŸ',
            'Ø£Ù†Ø§ Ø®Ø§ÙŠÙ Ø§Ù„Ø³Ù…Ùƒ ÙŠÙƒÙˆÙ† ÙØ§Ø³Ø¯ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø© Ø§Ù„Ù„ÙŠ Ø¬ÙˆØ§ Ø¯ÙŠ.', 'Ø§Ù„Ø¯ÙŠØ¯Ø§Ù† ÙÙŠ Ø³Ù…Ùƒ Ø§Ù„Ø±Ù†Ø¬Ø©ØŸ',
            'Fish has worms?', 'Eih dah elly goh el samaka?', 'Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù†Ù‚Ø· Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡/Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ ÙÙŠ Ø§Ù„Ø³Ù…ÙƒØŸ',
            'Ù‡Ù„ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø·ÙÙŠÙ„ÙŠØ§Øª Ø¹Ø§Ø¯ÙŠ ÙÙŠ Ø§Ù„Ø±Ù†Ø¬Ø©ØŸ', 'Ø§Ù„Ø¯ÙˆØ¯ Ø¯Ù‡ Ø¨ÙŠÙ…ÙˆØª ÙˆÙ„Ø§ Ø­ÙŠØŸ'
        ],
        'answer': (
            "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ÙŠØ§ ÙÙ†Ø¯Ù…ØŒ Ø§Ù„Ù„ÙŠ Ø¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø³Ù…ÙƒØ© Ø¯ÙŠ Ù…Ø´ Ø¯ÙˆØ¯ØŒ Ø¯ÙŠ Ø¨ØªÙƒÙˆÙ† Ø·ÙÙŠÙ„ÙŠØ§Øª. Ø§Ù„Ø·ÙÙŠÙ„ÙŠØ§Øª ÙÙŠ Ø³Ù…ÙƒØ© Ø§Ù„Ø±Ù†Ø¬Ø© ØªÙˆØ¬Ø¯ ÙÙŠ Ø§Ù„ØªØ¬ÙˆÙŠÙ Ø§Ù„Ø¨Ø·Ù†ÙŠ Ù„Ø£Ù†Ù‡Ø§ ØªØ¯Ø®Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ù…ØªØµØ§Øµ ÙˆØ§Ù„ØªÙ…Ø«ÙŠÙ„ Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ù„Ù„Ø³Ù…ÙƒØ©. "
            "Ù„Ø§ ØªØµÙŠØ¨ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ØŒ ÙˆØ²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©ØŒ ÙŠØªÙ… ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ Ø¹Ù†Ø¯ Ø¯Ø±Ø¬Ø© -35 Ø¥Ù„Ù‰ -40 ØªØ­Øª Ø§Ù„ØµÙØ± Ù„ØªØµØ¨Ø­ Ø§Ù„Ø·ÙÙŠÙ„ÙŠØ§Øª Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ù…Ø¹Ø§Ø¡ ÙˆÙ„Ø§ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø¢ÙƒÙ„Ù‡Ø§. Ø§Ù„Ø¯ÙˆØ¯ Ø¯Ù‡ Ù„Ùˆ ÙƒØ§Ù† Ø­ÙŠ Ù‡ÙŠÙƒÙˆÙ† Ø®Ø·Ø± Ø¹Ù„Ù‰ ØµØ­Ø© Ø§Ù„Ø¥Ù†Ø³Ø§Ù†."
        )
    }
]

# --------------------------------------------------------------------------------
# ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù† Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (Ù„Ùˆ Ø³Ù…Ø­ØªØŒ Ù…Ù† ÙØ¶Ù„ÙƒØŒ Ø¥Ù„Ø®)
# --------------------------------------------------------------------------------
CLEANING_PATTERNS = re.compile(
    r'(ÙŠØ§ ÙÙ†Ø¯Ù…|Ù„Ùˆ Ø³Ù…Ø­Øª|Ù…Ù† ÙØ¶Ù„Ùƒ|ÙƒÙ†Øª Ø­Ø§Ø¨Ø¨ Ø§Ø³ØªÙØ³Ø±|Ø§Ø³ØªÙØ³Ø§Ø± ØµØºÙŠØ±|Ø¹Ù†Ø¯ÙŠ Ø³Ø¤Ø§Ù„ Ø¨Ø®ØµÙˆØµ|Ø¹Ù†Ø¯ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±)',
    re.IGNORECASE
)

def clean_query(query):
    """ÙŠØ²ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„ØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© FuzzyWuzzy."""
    # 1. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    cleaned = CLEANING_PATTERNS.sub('', query).strip()
    # 2. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
    cleaned = re.sub(r'\s+', ' ', cleaned).strip()
    return cleaned

# --------------------------------------------------------------------------------
# Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FuzzyWuzzy)
# --------------------------------------------------------------------------------

def get_answer(user_question):
    """
    ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª FAQ.
    """
    # 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
    normalized_query = user_question.strip().lower()
    
    # Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³Ø§Ø¡ ÙˆØ§Ù„ØµØ¨Ø§Ø­
    if any(phrase.lower() in normalized_query for phrase in GREETINGS['evening']):
        return {'answer': "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ÙŠØ§ ÙÙ†Ø¯Ù…", 'confidence_score': 100}
    
    if any(phrase.lower() in normalized_query for phrase in GREETINGS['morning']):
        return {'answer': "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ÙŠØ§ ÙÙ†Ø¯Ù…", 'confidence_score': 100}

    # Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…
    if any(phrase.lower() in normalized_query for phrase in GREETINGS['greetings']):
        return {'answer': "ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù…", 'confidence_score': 100}


    # 2. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ FAQ
    cleaned_query = clean_query(user_question)
    
    best_match_score = 0
    best_answer = None

    for item in FAQ:
        for question_phrase in item['questions']:
            # Ù†Ø­Ø³Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù†Ø¸Ù
            score = fuzz.ratio(cleaned_query.lower(), question_phrase.lower())
            
            if score > best_match_score:
                best_match_score = score
                best_answer = item['answer']
    
    MATCH_THRESHOLD = 75 

    if best_match_score >= MATCH_THRESHOLD:
        return {
            'answer': best_answer,
            'confidence_score': best_match_score
        }
    else:
        return {
            'answer': (
                "Ø£Ù‡Ù„Ø§ Ø¨Ø­Ø¶Ø±Ùƒ. "
                "Ù„Ù‚Ø¯ ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ Ù„Ø£Ø­Ø¯ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ³ÙˆÙ ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙƒÙ…."
            ),
            'confidence_score': best_match_score
        }

# --------------------------------------------------------------------------------
# Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Meta API
# --------------------------------------------------------------------------------
def send_message(recipient_id, message_text):
    """ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± Meta (Messenger/WhatsApp) API."""
    if not PAGE_ACCESS_TOKEN or PAGE_ACCESS_TOKEN == "YOUR_FACEBOOK_PAGE_ACCESS_TOKEN_HERE":
        print("âš ï¸ ERROR: PAGE_ACCESS_TOKEN is not set!")
        return
        
    params = {"access_token": PAGE_ACCESS_TOKEN}
    headers = {"Content-Type": "application/json"}
    data = {
        "messaging_type": "RESPONSE",
        "recipient": {"id": recipient_id},
        "message": {"text": message_text}
    }
    
    url = "https://graph.facebook.com/v19.0/me/messages" 
    
    try:
        response = requests.post(url, params=params, headers=headers, json=data)
        response.raise_for_status() 
        print(f"Message sent successfully to {recipient_id}. Status: {response.status_code}")
    except requests.exceptions.RequestException as e:
        print(f"Failed to send message: {e}")
        if response.text:
            print(f"Meta API Response: {response.text}")


# --------------------------------------------------------------------------------
# ğŸš¨ Ù…Ø³Ø§Ø± Webhook: Ù„Ù„ØªØ­Ù‚Ù‚ (GET) ÙˆØªÙ„Ù‚ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (POST)
# --------------------------------------------------------------------------------
@app.route('/webhook', methods=['GET'])
def webhook_verification():
    VERIFY_TOKEN = "161019" 
    
    mode = request.args.get("hub.mode")
    token = request.args.get("hub.verify_token")
    challenge = request.args.get("hub.challenge")
    
    if mode and token:
        if mode == "subscribe" and token == VERIFY_TOKEN:
            print("Webhook Verified Successfully!")
            return challenge, 200
        else:
            return jsonify({'error': 'Verification token mismatch'}), 403
    
    return jsonify({'error': 'Missing verification parameters'}), 400


@app.route('/webhook', methods=['POST'])
def webhook_inbound():
    data = request.get_json()
    
    try:
        # 1. Ø§Ø³ØªØ®Ù„Ø§Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø§ÙØªØ±Ø§Ø¶Ù‹Ø§ Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø§Ø³Ù†Ø¬Ø± Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©)
        entry = data.get('entry', [])[0]
        messaging = entry.get('messaging', [])[0]
        sender_id = messaging['sender']['id']
        message_text = messaging['message']['text']
        
        if message_text:
            # 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            response_data = get_answer(message_text)
            bot_response = response_data['answer']
            
            # 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„
            send_message(sender_id, bot_response)
            
            print(f"Processed message from {sender_id}: '{message_text}'")
    except Exception as e:
        # ØºØ§Ù„Ø¨Ù‹Ø§ Ù…Ø§ ØªØµÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰ (Ù…Ø«Ù„ Ø±Ø³Ø§Ù„Ø© Ù‚Ø±Ø§Ø¡Ø©) Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ØµØŒ Ù†ØªØ¬Ø§Ù‡Ù„Ù‡Ø§
        print(f"Error processing inbound message: {e}")
        
    return "EVENT_RECEIVED", 200 

# --------------------------------------------------------------------------------
# Ù…Ø³Ø§Ø± /ask Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ 
# --------------------------------------------------------------------------------
@app.route('/ask', methods=['POST'])
def ask_chatbot_manual():
    data = request.get_json()
    user_query = data.get('question', '')
    
    if not user_query:
        return jsonify({'error': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Ø­Ù‚Ù„ "question"'}), 400

    result = get_answer(user_query)
    
    return jsonify(result)

# --------------------------------------------------------------------------------
# ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
# --------------------------------------------------------------------------------

if __name__ == '__main__':
    app.run(debug=True)
