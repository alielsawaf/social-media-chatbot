from flask import Flask, request
import requests
import os
import re

app = Flask(__name__)

# ================== CONFIG ==================
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
VERIFY_TOKEN = "my_secret_token"

user_context = {}

# ================== ุงูุดุงูู (ูู ูููุฉ ุจุนุชูุง ููุฌูุฏุฉ ููุง) ==================
DATA_BANK = {
    # ุงูุฃุณุฆูุฉ ุงูุฅุฏุงุฑูุฉ ูุงููููุฉ
    "ุฏูุฏ": "ูุง ููุฏู ุฏู ูุด ุฏูุฏุ ุฏู ุจูููู ุทููููุงุช. ุงูุทููููุงุช ูู ุณููุฉ ุงูุฑูุฌุฉ ุชูุฌุฏ ูู ุงูุชุฌููู ุงูุจุทูู ูุฃููุง ุชุฏุฎู ูู ุนูููุงุช ุงูุงูุชุตุงุต ูุงูุชูุซูู ุงูุบุฐุงุฆู ููุณููุฉ ููู ูุง ุชุตูุจ ุงูุฅูุณุงู ุชูุงูุงูุ ูุฒูุงุฏุฉ ูู ุงูููุงูุฉ ูุชู ุชุฌููุฏ ุงูุฃุณูุงู ุนูุฏ ุฏุฑุฌุฉ ูู 35 ุฅูู 40 ุชุญุช ุงูุตูุฑ ูุชุตุจุญ ุงูุทููููุงุช ุฌุฒุก ูู ุงูุฃูุนุงุก ููุง ุชุคุซุฑ ุนูู ุขูููุง...",
    "ูููู": "ุฏู ูููู ูููู ุงูููุชุฌุงุช ุจุชุงุนุชูุง: https://heyzine.com/flip-book/31946f16d5.html",
    "ุชุฃูุฏ": "ุญุถุฑุชู ุญุงูู ุดุฑุงุก ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ูู ูุตุงุฏุฑ ููุซููุฉ ูุถูุงู ุญุตููู ุนูู ุงูููุชุฌ ุงูุฃุตูู.",
    "ุฌููู": "ููุงุณุชูุณุงุฑ ูุทูุจ ุงููุณุงุนุฏุฉ ูุฑุฌู ุงูุงุชุตุงู ุนูู ุฃุฑูุงู ุงููุตูุน: 01211113882",
    "ุณูุฏูุชุด": "ูููู ุงูุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ ุบูุฑ ูุชุงุญ ุญุงููุงู ููุง ููุฌุฏ ุชูุตูู ููุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ.",
    "ููุงุนูุฏ": "ููุงุนูุฏ ุงูุนูู ูู ุงูุณุงุนุฉ 10 ุตุจุงุญุงู ุญุชู ุงูุณุงุนุฉ 12 ููุชุตู ุงูููู.",
    "ุชุตุฏูุฑ": "ุญุถุฑุชู ุชูุงุตู ูุงุชุณุงุจ ูุน ุงูุฃุณุชุงุฐ ุฃุญูุฏ ุนูู ุฑูู 01272475555 ููู ููุณุงุนุฏ ุญุถุฑุชู.",
    "ูุดุชุฑูุงุช": "ุฑูู ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช: 01223066445",
    "HR": "ุฑูู ุฅุฏุงุฑุฉ ุงูู HR ูู ุจูุฑุณุนูุฏ: 01200056103",
    "ุดูู": "ูุง ููุฌุฏ ุฑูุฌุฉ ููุดูู ููุง ุชุชุนุฑุถ ูุฃู ุญุฑุงุฑุฉุ ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ุฌุงูุฒุฉ ููุฃูู ูุจุงุดุฑุฉ ููุง ูููู ุฏูููุง ุจุงูุฒูุช.",
    "ุชุฌููุฏ": "ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ุชุญูุธ ูู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ -18 ูุตูุงุญูุชูุง 3 ุดููุฑ. ุงููุฑูุด ุชุญูุธ ูู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ูู 0 ุฅูู 4 ูุตูุงุญูุชูุง ุดูุฑ.",
    "ูุฑุชููู": "ูุฒู ูุฑุชููุฉ ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ุจูููู ูู 7.5 ุฅูู 8 ูููู ูุง ููุฏู.",
    "ุฌููุฏ": "ุงูุฃุญุฌุงู ุงูุตุบูุฑุฉ ุจุชููู ูู ุงูุชุบููู ุงูุฌููุฏ ูุงูููู ุจุญุฏ ุฃูุตู 600 ุฌุฑุงูุ ูุงูุฃูุจุฑ ูู ุงูุชุบููู ุงูุฃุณูุฏ.",
    "24": "ุนูุงุฑ 24 ุนุฏุฏ ุณุงุนุงุช ุงูุชุฏุฎูู ููู ุฃุทููุ ุญุฌู ุงูุณููุฉ ุฃุตุบุฑุ ูุทุนู ุงูุชุฏุฎูู ูุนุฒุฒ ุฃูุซุฑ.",
    "ุญูุธ": "ููุถู ุญูุธ ุงูุฑูุฌุฉ ูู ุงููุฑูุฒุฑ ุจุนุฏ ุงูุดุฑุงุก.",
    "ูุงูููู": "ูุนูู ุฑูุฌุฉ ูุบููุฉ ูู ุนุจูุงุช ููุฑุบุฉ ุงูููุงุก.",
    "ุชูููุญ": "ุงููุณูุฎ ูุชู ุชุตููุนู ูู ุณูู ุงูุจูุฑูุ ูุชู ุชูููุญู ูุฑูุด ูููู ุงูููู ุงูุจูุชูุฑูุ ููุญูุธ ูู ุซูุงุฌุงุช ูู 0 ุฅูู 4.",
    "ูุญู": "ุงููุญู ุงูุฃุจูุถ ุฃูุชุญ ูู ุงูุฃุญูุฑ ูุฃู ุงูููู ุงูุฃุญูุฑ ูุงุชุฌ ุนู ุงูููููุฌููุจููุ ูุงูุฃุญูุฑ ูุญุชูู ุจุฑูุชูู ุฃุนูู ููููู ุทุฑู.",
    "ุฏู": "ุงูุฏู ุจูููู ูุชูุฌุฉ ุงูุชูููุญ ุงููุฑูุด ูุงูุชุฌููุฏุ ูุนูุฏ ูู ุงูุชุฌููุฏ ุจุชุธูุฑ ุงูุณูุงุฆู ูุฏู ุทุจูุนู.",
    "ูุงุดู": "ุงูุฑูุฌุฉ ุงูููููู ุจุชููู ูุฎููุฉ ูุจุชุงุฎุฏ 3 ุทุจูุงุช ุชุฏุฎูู ูุชุนุฒูุฒ ุงูุทุนู ูุฏู ุจูุฎูููุง ุฃูุดู ุดููุฉ.",
    "ุดูุงุน": "ุงูุฃุณุชุงุฐ ูุญูุฏ ุงูุดูุงุน ูุฏูุฑ ุงูุญุณุงุจุงุชุ ุฑูู ุงูุชูุงุตู: 01204464066",
    "ุจูุงู": "ุงูุฃุณุชุงุฐ ุจูุงู ูุณุคูู ุงูุชูุฑูุฏ ููููุงุฏู ูุงููุทุงุนูุ ุฑูู ุงูุชูุงุตู: 01221093951",
    "ุณูููู": "ุงูุงุฎุชูุงู ูู ููู ุงููุญู ุจุณุจุจ ุทุฑููุฉ ุงูุชุฏุฎูู ูุงูุชูููุญ ูุงูุทูู ูุฏู ุจูุฃุซุฑ ุนูู ุงูุทุนู.",
    "ูุตุฑู": "ุงููุงูุฒ ูุณุชูุฑุฏ ููู ุงูุชููุฉ ููุณูุง ูุตุฑูุฉ ููุชู ุตูุฏูุง ูู ุงูุจุญุฑ ุงูุฃุจูุถ ุงููุชูุณุท.",
    "ุบุงูู": "ูุฃููุง ุจูุถูู ุฌูุฏุฉ ุนุงููุฉ ูุทุฑููุฉ ุชูููุญ ูุชุฏุฎูู ูุฎุชููุฉ.",
    "ุชูุงุจู": "ุชูุงุจู ุงููุงูุฑูู ุงูููููู: ูููู ุฃุณูุฏ ููููู ุฃุจูุถ.",

    # ุงูููุชุฌุงุช ูุงูุฃุณุนุงุฑ (ูู ุงูู 33 ุตูู)
    "ุฑูุฌู ูุจุทุฑุฎู": "๐ฐ ุฑูุฌุฉ ูุฏุฎูุฉ ูุจุทุฑุฎุฉ ูุฑููุฉ (1 ูุฌู): 250 EGP",
    "ุฑูุฌู ุณุงุฏู": "๐ฐ ุฑูุฌุฉ ูุฏุฎูุฉ (1 ูุฌู): 200 EGP",
    "ุฑูุฌู 24": "๐ฐ ุฑูุฌุฉ ุนูุงุฑ 24 ููุฑุงุท (1 ูุฌู): 300 EGP",
    "24 ูุฑููู": "๐ฐ ุฑูุฌุฉ 24 ููุฑุงุท ูุจุทุฑุฎุฉ (1 ูุฌู): 320 EGP",
    "ููููู": "๐ฐ ุฑูุฌุฉ ููููู ุจุฏูู ุฒูุช (1 ูุฌู): 600 EGP",
    "ูููู ูุงููุงุฑ": "๐ฐ ุฑูุฌุฉ ููููู ุตูุต ูููู ููุงููุงุฑ (200ุฌู): 150 EGP",
    "ุณุจุฑูุฏ": "๐ฐ ุฑูุฌุฉ ูุน ูุงููุงุฑ ุณุจุฑูุฏ: 70 EGP",
    "ูุณูุฎ": "๐ฐ ูุณูุฎ ุจุฏูู ุจูุชูุฑูุง (1 ูุฌู): 460 EGP",
    "ูุณูุฎ ูุจุทุฑุฎ": "๐ฐ ูุณูุฎ ูุจุทุฑุฎ ุจุฏูู ุจูุชูุฑูุง (1 ูุฌู): 560 EGP",
    "ูุงูุฑูู": "๐ฐ ูุงูุฑูู ูุฏุฎู ูููุญ (1 ูุฌู): 410 EGP",
    "ูุงูุฑูู ููููู": "๐ฐ ูุงูุฑูู ููููู ุณุงุฏุฉ ูุงูููู (1 ูุฌู): 800 EGP",
    "ุจูุฑู ุฒูุช": "๐ฐ ููููู ุจูุฑู ูููุญ ุฒูุช ูุจุงุชู (250ุฌู): 250 EGP"
}

def normalize(text):
    if not text: return ""
    arabic_digits = "ููกูขูฃูคูฅูฆูงูจูฉ"
    english_digits = "0123456789"
    text = text.translate(str.maketrans(arabic_digits, english_digits))
    text = text.lower()
    text = re.sub(r"[ุฅุฃุขุง]", "ุง", text)
    text = re.sub(r"ุฉ", "ู", text)
    text = re.sub(r"ู", "ู", text)
    return text

def get_answer(user_id, text):
    q = normalize(text)
    
    # 1. ุชุญุฏูุซ ุงูุฐุงูุฑุฉ ุจุงูููุชุฌ
    for key in DATA_BANK:
        if key in q:
            user_context[user_id] = key

    # 2. ูู ุณุฃู ุจูุงู
    if any(word in q for word in ["ุจูุงู", "ุณุนุฑ", "ุณุนุฑู", "ูุงู"]):
        last_item = user_context.get(user_id)
        if last_item:
            return f"ุจุฎุตูุต {last_item}:\n{DATA_BANK[last_item]}"
        return "ุญุงุจุจ ุชุนุฑู ุณุนุฑ ุฃููู ููุชุฌุ (ุฑูุฌุฉุ ูุณูุฎุ ูุงูุฑูู..)"

    # 3. ุงูุจุญุซ ุงูุนุงู ูู ูู ุงูุฏุงุชุง
    for key, val in DATA_BANK.items():
        if key in q:
            return val

    # 4. ุงูุชุฑุญูุจ
    if any(w in q for w in ["ุงููุง", "ุณูุงู", "ุงุฒูู", "ูุงู"]):
        return "ุฃููุงู ุจู ูู ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ๐ ุชุญุจ ุฃุจุนุชูู ุงููููู ููุง ุชุณุฃู ุนู ุณุนุฑ ุตูู ูุนููุ"

    return "ุจุนุชุฐุฑ ูุญุถุฑุชูุ ูููู ุชูุถุญ ุณุคุงููุ (ูุซูุงู: ุณุนุฑ ุงูุฑูุฌุฉุ ุงูููููุ ุฃู ููุงุนูุฏ ุงููุฑูุน)."

# ================== ุงููุชุจูู ูู ุงูููุฏ (ุงูููุจ ููู) ููุง ูู ==================
@app.route("/webhook", methods=["GET", "POST"])
def webhook():
    if request.method == "GET":
        if request.args.get("hub.verify_token") == VERIFY_TOKEN:
            return request.args.get("hub.challenge")
        return "failed", 403
    
    data = request.get_json()
    if data.get("object") == "page":
        for entry in data.get("entry", []):
            for ev in entry.get("messaging", []):
                sender_id = ev["sender"]["id"]
                if "message" in ev and "text" in ev["message"]:
                    if ev["message"].get("is_echo"): continue
                    reply = get_answer(sender_id, ev["message"]["text"])
                    send_message(sender_id, reply)
    return "ok", 200

def send_message(user_id, text):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    requests.post(url, json={"recipient": {"id": user_id}, "message": {"text": text}})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))
