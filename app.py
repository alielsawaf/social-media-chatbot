from flask import Flask, request
from fuzzywuzzy import fuzz
import requests
import re
import os

app = Flask(__name__)

# ================== CONFIG ==================
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
VERIFY_TOKEN = "my_secret_token"

# ================== MEMORY ==================
USER_CONTEXT = {} 

# ================== PRODUCTS ==================
PRODUCTS = [
    # Ø§Ù„Ø±Ù†Ø¬Ø©
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ø¯Ø®Ù†Ù‡ Ù…Ø¨Ø·Ø±Ø®Ù‡ Ù…Ø±Ù…Ù„Ù‡', 'Ø±Ù†Ø¬Ù‡ Ù…Ø¨Ø·Ø±Ø®Ù‡', 'Ø±Ù†Ø¬Ù‡ Ù…Ø±Ù…Ù„Ù‡'], 'price': '250 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ø¯Ø®Ù†Ù‡', 'Ø±Ù†Ø¬Ù‡ Ø¹Ø§Ø¯ÙŠÙ‡'], 'price': '200 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ø¯Ø®Ù†Ù‡ 24 Ù‚ÙŠØ±Ø§Ø·', 'Ø±Ù†Ø¬Ù‡ 24', 'Ø±Ù†Ø¬Ù‡ Ø¹ÙŠØ§Ø± 24'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ 24 Ù…Ø¨Ø·Ø±Ø®Ù‡', 'Ø±Ù†Ø¬Ù‡ 24 Ù…Ø±Ù…Ù„Ù‡'], 'price': '320 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ù†Ø²ÙˆØ¹Ù‡ Ø§Ù„Ø§Ø­Ø´Ø§Ø¡ ÙØ§ÙƒÙŠÙˆÙ…', 'Ø±Ù†Ø¬Ù‡ ÙØ§ÙƒÙŠÙˆÙ…'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø¨Ø¯ÙˆÙ† Ø²ÙŠØª', 'Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø³Ø§Ø¯Ù‡'], 'price': '600 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ ØµÙˆØµ ÙÙ„ÙÙ„ ÙˆÙƒØ§ÙÙŠØ§Ø±'], 'price': '150 EGP', 'w': '200 G'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ ÙƒØ§Ø±ÙŠ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø²ÙŠØª'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ù…Ø¯Ø®Ù†Ù‡'], 'price': '85 EGP', 'w': '125 G'},
    {'kw': ['ÙƒØ§ÙÙŠØ§Ø± Ø³Ø¨Ø±ÙŠØ¯', 'Ø±Ù†Ø¬Ù‡ ÙƒØ§ÙÙŠØ§Ø± Ø³Ø¨Ø±ÙŠØ¯'], 'price': '70 EGP', 'w': '200 G/130 G'},
    {'kw': ['Ø¨Ø·Ø§Ø±Ø® Ø±Ù†Ø¬Ù‡ Ø²ÙŠØª ÙƒØ§Ù…Ù„Ø©'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['Ø¨Ø·Ø§Ø±Ø® Ø±Ù†Ø¬Ù‡ Ø¨Ø±ØªÙ‚Ø§Ù„', 'Ø¨Ø·Ø§Ø±Ø® Ù…Ù‡Ø±ÙˆØ³Ù‡'], 'price': '250 EGP', 'w': '250 G'},
    # Ø§Ù„Ù…Ø§ÙƒØ±ÙŠÙ„
    {'kw': ['Ù…Ø§ÙƒØ±ÙŠÙ„ Ù…Ø¯Ø®Ù† Ù…Ù…Ù„Ø­', 'Ù…Ø§ÙƒØ±ÙŠÙ„'], 'price': '410 EGP', 'w': '1 KG'},
    {'kw': ['Ù…Ø§ÙƒØ±ÙŠÙ„ ÙØ§ÙƒÙŠÙˆÙ…'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['Ù…Ø§ÙƒØ±ÙŠÙ„ ÙÙŠÙ„ÙŠÙ‡'], 'price': '800 EGP', 'w': '1 KG'},
    # Ø§Ù„ÙØ³ÙŠØ®
    {'kw': ['ÙØ³ÙŠØ® ÙÙŠÙ„ÙŠÙ‡ Ø²ÙŠØª', 'ÙØ³ÙŠØ® Ø²ÙŠØª'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ÙØ³ÙŠØ® ÙÙŠÙ„ÙŠÙ‡ Ø¯Ø®Ø§Ù†', 'ÙØ³ÙŠØ® Ù…Ø¯Ø®Ù†'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ÙØ³ÙŠØ® Ø³Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ø¬Ø±'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ÙØ³ÙŠØ® Ø¨Ø¯ÙˆÙ† Ø¨ÙƒØªÙŠØ±ÙŠØ§', 'ÙØ³ÙŠØ® Ø·Ø¨ÙŠ'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ÙØ³ÙŠØ® Ù…Ø¨Ø·Ø±Ø®'], 'price': '560 EGP', 'w': '1 KG'},
    {'kw': ['Ø´Ø±Ø§Ø¦Ø­ Ø¨ÙˆØ±ÙŠ Ù…Ø¯Ø®Ù†Ù‡', 'ÙÙŠÙ„ÙŠÙ‡ Ø¨ÙˆØ±ÙŠ Ù…Ø¯Ø®Ù†'], 'price': '810 EGP', 'w': '1 KG'},
    # Ø§Ù„Ø³Ù„Ù…ÙˆÙ†
    {'kw': ['Ø³Ù„Ù…ÙˆÙ† Ø­Ø§Ø±', 'spicy salmon'], 'price': '150 EGP', 'w': '125 G'},
    {'kw': ['Ø´Ø±Ø§Ø¦Ø­ Ø³Ù„Ù…ÙˆÙ† Ù…Ø¯Ø®Ù†Ù‡', 'Ø³Ù„Ù…ÙˆÙ† ÙÙŠÙ„ÙŠÙ‡'], 'price': '3000 EGP', 'w': '1 KG'},
    {'kw': ['Ø³ØªÙŠÙƒ Ø³Ù„Ù…ÙˆÙ†'], 'price': '1810 EGP', 'w': '1 KG'},
    {'kw': ['Ø´ÙˆØ±Ø¨Ù‡ Ø³Ù„Ù…ÙˆÙ†'], 'price': '90 EGP', 'w': '160 G'},
    # Ø§Ù„Ø¨Ø·Ø§Ø±Ø® ÙˆØ§Ù„ØªÙˆÙ†Ø©
    {'kw': ['Ø¨Ø·Ø§Ø±Ø® Ø¨ÙˆØ±ÙŠ Ù…Ù…Ù„Ø­Ù‡', 'Ø¨Ø·Ø§Ø±Ø® Ø¨ÙˆØ±ÙŠ'], 'price': '2850 EGP', 'w': '1 KG'},
    {'kw': ['ØªÙˆÙ†Ù‡ Ø­Ù…Ø±Ø§Ø¡ ÙÙŠÙ„ÙŠÙ‡', 'ØªÙˆÙ†Ù‡ Ø­Ù…Ø±Ø§'], 'price': '155 EGP', 'w': '230 G'},
    {'kw': ['ØªÙˆÙ†Ù‡ Ù‚Ø·Ø¹', ' chunks tuna'], 'price': '70 EGP', 'w': '125 G'},
    {'kw': ['ØªÙˆÙ†Ù‡ Ù…Ø·Ù‡ÙŠÙ‡'], 'price': '710 EGP', 'w': '1 KG'},
    # Ø£Ø®Ø±Ù‰
    {'kw': ['Ø§Ù†Ø´ÙˆØ¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø²ÙŠØª', 'Ø§Ù†Ø´ÙˆØ¬Ù‡'], 'price': '110 EGP', 'w': '125 G'},
    {'kw': ['Ø³Ø±Ø¯ÙŠÙ† Ù…Ù…Ù„Ø­'], 'price': '200 EGP', 'w': '250 G'},
    {'kw': ['Ø­Ù†Ø´Ø§Ù† Ù…Ø¯Ø®Ù†', 'ØªØ¹Ø¨Ø§Ù† Ù…Ø¯Ø®Ù†'], 'price': '810 EGP', 'w': '1 KG'}
]

# ================== FAQ ==================
FAQ = [
    {
        "keywords": [
            "Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙØ±ÙˆØ¹ÙƒÙ…","Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙØ±ÙˆØ¹","Ø§Ù„ÙØ±ÙˆØ¹ Ø´ØºØ§Ù„Ù‡ Ù„Ù„Ø³Ø§Ø¹Ù‡ ÙƒØ§Ù…","Ù…Ù† ÙƒØ§Ù… Ù„ÙƒØ§Ù…"
        ],
        "answer": "Ø£Ù‡Ù„Ø§ Ø¨Ø­Ø¶Ø±ØªÙƒ ğŸŒ¹\nÙ…ÙˆØ§Ø¹ÙŠØ¯ ÙØ±ÙˆØ¹Ù†Ø§ Ù…Ù† 10 ØµØ¨Ø§Ø­Ø§Ù‹ Ø­ØªÙ‰ 12 Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„"
    },
    {
        "keywords": [
            "ØªØµØ¯ÙŠØ±","Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„ØªØµØ¯ÙŠØ±","Ø±Ù‚Ù… Ø§Ù„ØªØµØ¯ÙŠØ±","Ø§Ø¯Ø§Ø±Ù‡ Ø§Ù„ØªØµØ¯ÙŠØ±"
        ],
        "answer": "Ø£Ù‡Ù„Ø§ Ø¨Ø­Ø¶Ø±ØªÙƒ ğŸŒ¹\nØ±Ù‚Ù… Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯ Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„ØªØµØ¯ÙŠØ± (ÙˆØ§ØªØ³Ø§Ø¨): 01272475555"
    },
    {
        "keywords": [
            "Ù…Ø´ØªØ±ÙŠØ§Øª","Ø§Ø¯Ø§Ø±Ù‡ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª","Ø±Ù‚Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª"
        ],
        "answer": "Ø£Ù‡Ù„Ø§ Ø¨Ø­Ø¶Ø±ØªÙƒ ğŸŒ¹\nØ±Ù‚Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: 01223066445"
    },
    {
        "keywords": [
            "hr","Ø§ØªØ´ Ø§Ø±","ÙˆØ¸Ø§Ø¦Ù","ØªØ¹ÙŠÙŠÙ†Ø§Øª","Ø§Ù„ØªÙˆØ¸ÙŠÙ"
        ],
        "answer": "Ø£Ù‡Ù„Ø§ Ø¨Ø­Ø¶Ø±ØªÙƒ ğŸŒ¹\nØ±Ù‚Ù… Ø¥Ø¯Ø§Ø±Ø© HR Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯: 01200056103"
    },
    {
        "keywords": [
            "Ø±Ù†Ø¬Ù‡ 24","Ø¹ÙŠØ§Ø± 24","ÙØ±Ù‚ Ø§Ù„Ø±Ù†Ø¬Ù‡"
        ],
        "answer": (
            "Ø£Ù‡Ù„Ø§ Ø¨Ø­Ø¶Ø±ØªÙƒ ğŸŒ¹\n"
            "Ø±Ù†Ø¬Ø© Ø¹ÙŠØ§Ø± 24:\n"
            "âœ”ï¸ Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø®ÙŠÙ† Ø£Ø·ÙˆÙ„\n"
            "âœ”ï¸ Ø­Ø¬Ù… Ø§Ù„Ø³Ù…ÙƒØ© Ø£ØµØºØ±\n"
            "âœ”ï¸ Ø·Ø¹Ù… Ø§Ù„ØªØ¯Ø®ÙŠÙ† Ø£Ù‚ÙˆÙ‰"
        )
    },
    {
        "keywords": [
            "Ø§Ø­ÙØ¸ Ø§Ù„Ø±Ù†Ø¬Ù‡","ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ù†Ø¬Ù‡","Ø§Ù„ÙØ±ÙŠØ²Ø± ÙˆÙ„Ø§ Ø§Ù„Ø«Ù„Ø§Ø¬Ù‡"
        ],
        "answer": "ÙŠÙØ¶Ù„ Ø­ÙØ¸ Ø§Ù„Ø±Ù†Ø¬Ø© ÙÙŠ Ø§Ù„ÙØ±ÙŠØ²Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡"
    },
    {
        "keywords": [
            "Ø±Ù†Ø¬Ù‡ Ù…Ø´ÙˆÙŠÙ‡","Ø§Ø´ÙˆÙŠ Ø§Ù„Ø±Ù†Ø¬Ù‡","Ø§Ø³Ø®Ù† Ø§Ù„Ø±Ù†Ø¬Ù‡"
        ],
        "answer": "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù†Ø¬Ø© Ù„Ù„Ø´ÙˆÙŠØŒ Ø§Ù„Ø±Ù†Ø¬Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø£ÙƒÙ„ ÙˆÙ„Ø§ ØªØªØ¹Ø±Ø¶ Ù„Ø£ÙŠ Ø­Ø±Ø§Ø±Ø©"
    },
    {
        "keywords": [
            "ÙØ±Ù‚ Ø§Ù„Ù…Ø¬Ù…Ø¯ ÙˆØ§Ù„ÙØ±ÙŠØ´","Ø±Ù†Ø¬Ù‡ Ù…Ø¬Ù…Ø¯Ù‡","Ø±Ù†Ø¬Ù‡ ÙØ±ÙŠØ´"
        ],
        "answer": (
            "Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø±Ù†Ø¬Ø© Ø§Ù„Ù…Ø¬Ù…Ø¯Ø© ÙˆØ§Ù„ÙØ±ÙŠØ´:\n"
            "ğŸ”¹ Ø§Ù„Ù…Ø¬Ù…Ø¯Ø©: -18 Ø¯Ø±Ø¬Ø© â€“ ØµÙ„Ø§Ø­ÙŠØ© 3 Ø´Ù‡ÙˆØ±\n"
            "ğŸ”¹ Ø§Ù„ÙØ±ÙŠØ´: 0 Ø¥Ù„Ù‰ 4 Ø¯Ø±Ø¬Ø© â€“ ØµÙ„Ø§Ø­ÙŠØ© Ø´Ù‡Ø±"
        )
    },
    {
        "keywords": [
            "ÙˆØ²Ù† ÙƒØ±ØªÙˆÙ†Ù‡","ÙƒØ±ØªÙˆÙ†Ù‡ Ø§Ù„Ø±Ù†Ø¬Ù‡"
        ],
        "answer": "ÙˆØ²Ù† ÙƒØ±ØªÙˆÙ†Ø© Ø§Ù„Ø±Ù†Ø¬Ø© Ø§Ù„Ù…Ø¬Ù…Ø¯Ø© Ù…Ù† 7.5 Ø¥Ù„Ù‰ 8 ÙƒÙŠÙ„Ùˆ"
    },
    {
        "keywords": [
            "Ø¯Ù… ÙÙŠ Ø§Ù„ÙØ³ÙŠØ®","Ø§Ù„ÙØ³ÙŠØ® ÙÙŠ Ø¯Ù…"
        ],
        "answer": (
            "Ø§Ù„ÙØ³ÙŠØ® Ø¬Ø§Ù‡Ø² Ù„Ù„Ø£ÙƒÙ„ ğŸŒ¹\n"
            "Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØªÙ…Ù„ÙŠØ­ Ø§Ù„ÙØ±ÙŠØ´ ÙˆØ§Ù„ØªØ¬Ù…ÙŠØ¯"
        )
    }
]

# ================== UTILS ==================
def clean(text):
    if not text: return ""
    text = text.lower().strip()
    # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
    text = text.translate(str.maketrans("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©", "0123456789"))
    # ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„ØªÙŠ ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§ (Ù„Ø§ ØªØ¶Ø¹ "Ø³Ø¹Ø±" Ø£Ùˆ "Ø¨ÙƒØ§Ù…" Ù‡Ù†Ø§)
    stop_words = ['Ø¹Ø§ÙŠØ²', 'Ø¹Ø§ÙŠØ²Ù‡', 'Ø§Ø¹Ø±Ù', 'Ø§Ø³ØªÙØ³Ø±', 'Ù„Ùˆ Ø³Ù…Ø­Øª', 'Ø¹Ù†Ø¯ÙƒÙ…', 'Ø¹Ù†Ø¯ÙƒÙˆ', 'Ù…Ù…ÙƒÙ†', 'ÙŠØ§ ÙÙ†Ø¯Ù…', 'Ø­Ø¶Ø±ØªÙƒ']
    for word in stop_words:
        text = text.replace(word, "")
    # ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø­Ø±ÙˆÙ ÙˆÙØµÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    text = re.sub(r"(\d+)", r" \1 ", text)
    text = re.sub(r"[Ø¥Ø£Ø¢Ø§]", "Ø§", text); text = re.sub(r"Ø©", "Ù‡", text); text = re.sub(r"Ù‰", "ÙŠ", text)
    return re.sub(r"[^\w\s]", "", text).strip()

def detect_product(text):
    q = clean(text)
    if not q: return None
    for p in PRODUCTS:
        for k in p["kw"]:
            target = clean(k)
            # ÙØ­Øµ Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø§Ù„Ø¬Ø²Ø¦ÙŠ Ø£Ùˆ ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒÙ„Ù…Ø©
            if fuzz.partial_ratio(q, target) > 85 or target in q:
                return p
    return None

# ================== LOGIC ==================
def get_answer(user_id, text):
    raw_q = text.lower()
    q_cleaned = clean(text)
    
    # 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙˆØ±Ø§Ù‹ Ù„Ùˆ Ù„Ù‚Ù‰ Ø£ÙŠ Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø¬Ù…Ù„Ø©
    product = detect_product(text)
    if product:
        USER_CONTEXT[user_id] = product

    # 2. ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ù…
    if any(w in raw_q for w in ['Ø§Ù‡Ù„Ø§', 'Ø³Ù„Ø§Ù…', 'ØµØ¨Ø§Ø­', 'Ù…Ø³Ø§Ø¡', 'Ø§Ø²ÙŠÙƒ']):
        return "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±Ù†Ø¬Ø© Ø£Ø¨Ùˆ Ø§Ù„Ø³ÙŠØ¯ ğŸ‘‹ Ø­Ø§Ø¨Ø¨ ØªØ¹Ø±Ù Ø£Ø³Ø¹Ø§Ø±Ù†Ø§ ÙˆÙ„Ø§ Ø¹Ù†Ø¯Ùƒ Ø§Ø³ØªÙØ³Ø§Ø±ØŸ"

    # 3. ÙØ­Øµ "Ø§Ù„Ø³Ø¹Ø±" (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰ Ù„Ùˆ Ø§Ù„Ø¬Ù…Ù„Ø© ÙÙŠÙ‡Ø§ Ø¨ÙƒØ§Ù…/Ø³Ø¹Ø±)
    if any(x in raw_q for x in ["Ø³Ø¹Ø±", "Ø¨ÙƒØ§Ù…", "ÙƒØ§Ù…", "Ø¨Ù‚Ø¯ Ø§ÙŠÙ‡", "Ø¬Ù†ÙŠÙ‡"]):
        p = product or USER_CONTEXT.get(user_id)
        if p:
            return f"ğŸ’° Ø³Ø¹Ø± {p['kw'][0]}:\nØ§Ù„ÙˆØ²Ù†: {p['w']}\nØ§Ù„Ø³Ø¹Ø±: {p['price']} âœ¨"
        return "ØªØ­Ø¨ ØªØ¹Ø±Ù Ø³Ø¹Ø± Ø£Ù†Ù‡ÙŠ ØµÙ†ÙØŸ ğŸ˜Š"

    # 4. ÙØ­Øµ Ø§Ù„Ù€ FAQ (ÙÙ‚Ø· Ù„Ùˆ Ù…ÙÙŠØ´ Ø·Ù„Ø¨ Ø³Ø¹Ø± ÙˆØ§Ø¶Ø­)
    for f in FAQ:
        for kw in f["keywords"]:
            if fuzz.partial_ratio(q_cleaned, clean(kw)) > 85:
                return f["answer"]

    # 5. Ù„Ùˆ Ø°ÙƒØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø³ (Ø²ÙŠ Ù…Ø§ Ø¹Ù…Ù„Øª ÙÙŠ "ÙˆØ§Ù„ÙØ³ÙŠØ®")
    if product:
        return f"ğŸ“Œ {product['kw'][0]} Ù…ØªØ§Ø­ ÙŠØ§ ÙÙ†Ø¯Ù…. ØªØ­Ø¨ ØªØ¹Ø±Ù Ø§Ù„Ø³Ø¹Ø±ØŸ"

    return "Ø¨Ø¹ØªØ°Ø± Ù…Ù†Ùƒ ÙŠØ§ÙÙ†Ø¯Ù…ØŒ. Ù…Ù…ÙƒÙ† ØªÙˆØ¶Ø­ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ Ø§ÙƒØªØ± âœ¨"

# ================== WEBHOOK ==================
@app.route("/webhook", methods=["GET"])
def verify():
    if request.args.get("hub.verify_token") == VERIFY_TOKEN:
        return request.args.get("hub.challenge")
    return "failed", 403

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()
    if data.get("object") == "page":
        for entry in data.get("entry", []):
            for ev in entry.get("messaging", []):
                sender = ev["sender"]["id"]
                if "message" in ev and "text" in ev["message"]:
                    reply = get_answer(sender, ev["message"]["text"])
                    send_message(sender, reply)
    return "ok", 200

def send_message(user_id, text):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    payload = {"recipient": {"id": user_id}, "message": {"text": text}}
    try:
        requests.post(url, json=payload)
    except:
        pass

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))

