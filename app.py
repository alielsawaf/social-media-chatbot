from flask import Flask, request
from fuzzywuzzy import fuzz
import requests
import re
import os

app = Flask(__name__)

# ================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ==================
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
VERIFY_TOKEN = "my_secret_token"
WHATSAPP_NUMBER = "201090636076"
MENU_LINK = "https://heyzine.com/flip-book/31946f16d5.html"

# ================== Ø°Ø§ÙƒØ±Ø© Ù…Ø­Ø§Ø¯Ø«Ø© ==================
USER_CONTEXT = {}  # user_id -> last_products_list OR last_product

# ================== Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù„ØºØ© ==================
def clean_arabic_text(text):
    if not text:
        return ""
    text = text.lower().strip()
    text = re.sub(r"[Ø¥Ø£Ø¢Ø§]", "Ø§", text)
    text = re.sub(r"Ø©", "Ù‡", text)
    text = re.sub(r"Ù‰", "ÙŠ", text)
    text = re.sub(r"[^\w\s]", "", text)
    return re.sub(r"\s+", " ", text)

def smart_similarity(a, b):
    return max(
        fuzz.token_set_ratio(a, b),
        fuzz.partial_ratio(a, b)
    )

# ================== Ø³Ù„Ø§Ù… Ø°ÙƒÙŠ ==================
SMART_GREETINGS = {
    "ØµØ¨Ø§Ø­": "ØµØ¨Ø§Ø­ Ø§Ù„Ù†ÙˆØ± ÙŠØ§ ÙÙ†Ø¯Ù… ğŸŒ",
    "Ù…Ø³Ø§Ø¡": "Ù…Ø³Ø§Ø¡ Ø§Ù„Ù†ÙˆØ± ÙŠØ§ ÙÙ†Ø¯Ù… ğŸŒ™",
    "Ø§Ù„Ø³Ù„Ø§Ù…": "ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ğŸ¤",
    "Ø§Ø²ÙŠÙƒ": "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø­Ø¶Ø±ØªÙƒ ğŸŒ¹ Ø¹Ø§Ù…Ù„ Ø§ÙŠÙ‡ØŸ",
    "Ø§Ù‡Ù„Ø§": "Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ø­Ø¶Ø±ØªÙƒ ğŸ‘‹",
    "Ù‡Ø§ÙŠ": "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ğŸ‘‹"
}

# ================== Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ==================
PRODUCTS = [
      # Ø§Ù„Ø±Ù†Ø¬Ø©
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ø¯Ø®Ù†Ù‡ Ù…Ø¨Ø·Ø±Ø®Ù‡ Ù…Ø±Ù…Ù„Ù‡', 'Ø±Ù†Ø¬Ù‡ Ù…Ø¨Ø·Ø±Ø®Ù‡', 'Ø±Ù†Ø¬Ù‡ Ù…Ø±Ù…Ù„Ù‡'], 'price': '250 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ø¯Ø®Ù†Ù‡', 'Ø±Ù†Ø¬Ù‡ Ø¹Ø§Ø¯ÙŠÙ‡'], 'price': '200 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ø¯Ø®Ù†Ù‡ 24 Ù‚ÙŠØ±Ø§Ø·', 'Ø±Ù†Ø¬Ù‡ 24', 'Ø±Ù†Ø¬Ù‡ Ø¹ÙŠØ§Ø± 24'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ 24 Ù…Ø¨Ø·Ø±Ø®Ù‡', 'Ø±Ù†Ø¬Ù‡ 24 Ù…Ø±Ù…Ù„Ù‡'], 'price': '320 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ù†Ø²ÙˆØ¹Ù‡ Ø§Ù„Ø§Ø­Ø´Ø§Ø¡ ÙØ§ÙƒÙŠÙˆÙ…', 'Ø±Ù†Ø¬Ù‡ ÙØ§ÙƒÙŠÙˆÙ…'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø¨Ø¯ÙˆÙ† Ø²ÙŠØª', 'Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø³Ø§Ø¯Ù‡'], 'price': '600 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ ØµÙˆØµ ÙÙ„ÙÙ„ ÙˆÙƒØ§ÙÙŠØ§Ø±'], 'price': '150 EGP', 'w': '200 G'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ ÙƒØ§Ø±ÙŠ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø²ÙŠØª'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ù…Ø¯Ø®Ù†Ù‡'], 'price': '85 EGP', 'w': '125 G'},
    {'kw': ['ÙƒØ§ÙÙŠØ§Ø± Ø³Ø¨Ø±ÙŠØ¯', 'Ø±Ù†Ø¬Ù‡ ÙƒØ§ÙÙŠØ§Ø± Ø³Ø¨Ø±ÙŠØ¯'], 'price': '70 EGP', 'w': '200 G/130 G'},
    {'kw': ['Ø¨Ø·Ø§Ø±Ø® Ø±Ù†Ø¬Ù‡ Ø²ÙŠØª ÙƒØ§Ù…Ù„Ø©'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['Ø¨Ø·Ø§Ø±Ø® Ø±Ù†Ø¬Ù‡ Ø¨Ø±ØªÙ‚Ø§Ù„', 'Ø¨Ø·Ø§Ø±Ø® Ù…Ù‡Ø±ÙˆØ³Ù‡'], 'price': '250 EGP', 'w': '250 G'},
    # Ø§Ù„Ù…Ø§ÙƒØ±ÙŠÙ„
    {'kw': ['Ù…Ø§ÙƒØ±ÙŠÙ„ Ù…Ø¯Ø®Ù† Ù…Ù…Ù„Ø­', 'Ù…Ø§ÙƒØ±ÙŠÙ„'], 'price': '410 EGP', 'w': '1 KG'},
    {'kw': ['Ù…Ø§ÙƒØ±ÙŠÙ„ ÙØ§ÙƒÙŠÙˆÙ…'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['Ù…Ø§ÙƒØ±ÙŠÙ„ ÙÙŠÙ„ÙŠÙ‡'], 'price': '800 EGP', 'w': '1 KG'},
    # Ø§Ù„ÙØ³ÙŠØ®
    {'kw': ['ÙØ³ÙŠØ® ÙÙŠÙ„ÙŠÙ‡ Ø²ÙŠØª', 'ÙØ³ÙŠØ® Ø²ÙŠØª'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ÙØ³ÙŠØ® ÙÙŠÙ„ÙŠÙ‡ Ø¯Ø®Ø§Ù†', 'ÙØ³ÙŠØ® Ù…Ø¯Ø®Ù†'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ÙØ³ÙŠØ® Ø³Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ø¬Ø±'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ÙØ³ÙŠØ® Ø¨Ø¯ÙˆÙ† Ø¨ÙƒØªÙŠØ±ÙŠØ§', 'ÙØ³ÙŠØ® Ø·Ø¨ÙŠ'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ÙØ³ÙŠØ® Ù…Ø¨Ø·Ø±Ø®'], 'price': '560 EGP', 'w': '1 KG'},
    {'kw': ['Ø´Ø±Ø§Ø¦Ø­ Ø¨ÙˆØ±ÙŠ Ù…Ø¯Ø®Ù†Ù‡', 'ÙÙŠÙ„ÙŠÙ‡ Ø¨ÙˆØ±ÙŠ Ù…Ø¯Ø®Ù†'], 'price': '810 EGP', 'w': '1 KG'},
    # Ø§Ù„Ø³Ù„Ù…ÙˆÙ†
    {'kw': ['Ø³Ù„Ù…ÙˆÙ† Ø­Ø§Ø±', 'spicy salmon'], 'price': '150 EGP', 'w': '125 G'},
    {'kw': ['Ø´Ø±Ø§Ø¦Ø­ Ø³Ù„Ù…ÙˆÙ† Ù…Ø¯Ø®Ù†Ù‡', 'Ø³Ù„Ù…ÙˆÙ† ÙÙŠÙ„ÙŠÙ‡'], 'price': '3000 EGP', 'w': '1 KG'},
    {'kw': ['Ø³ØªÙŠÙƒ Ø³Ù„Ù…ÙˆÙ†'], 'price': '1810 EGP', 'w': '1 KG'},
    {'kw': ['Ø´ÙˆØ±Ø¨Ù‡ Ø³Ù„Ù…ÙˆÙ†'], 'price': '90 EGP', 'w': '160 G'},
    # Ø§Ù„Ø¨Ø·Ø§Ø±Ø® ÙˆØ§Ù„ØªÙˆÙ†Ø©
    {'kw': ['Ø¨Ø·Ø§Ø±Ø® Ø¨ÙˆØ±ÙŠ Ù…Ù…Ù„Ø­Ù‡', 'Ø¨Ø·Ø§Ø±Ø® Ø¨ÙˆØ±ÙŠ'], 'price': '2850 EGP', 'w': '1 KG'},
    {'kw': ['ØªÙˆÙ†Ù‡ Ø­Ù…Ø±Ø§Ø¡ ÙÙŠÙ„ÙŠÙ‡', 'ØªÙˆÙ†Ù‡ Ø­Ù…Ø±Ø§'], 'price': '155 EGP', 'w': '230 G'},
    {'kw': ['ØªÙˆÙ†Ù‡ Ù‚Ø·Ø¹', ' chunks tuna'], 'price': '70 EGP', 'w': '125 G'},
    {'kw': ['ØªÙˆÙ†Ù‡ Ù…Ø·Ù‡ÙŠÙ‡'], 'price': '710 EGP', 'w': '1 KG'},
    # Ø£Ø®Ø±Ù‰
    {'kw': ['Ø§Ù†Ø´ÙˆØ¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø²ÙŠØª', 'Ø§Ù†Ø´ÙˆØ¬Ù‡'], 'price': '110 EGP', 'w': '125 G'},
    {'kw': ['Ø³Ø±Ø¯ÙŠÙ† Ù…Ù…Ù„Ø­'], 'price': '200 EGP', 'w': '250 G'},
    {'kw': ['Ø­Ù†Ø´Ø§Ù† Ù…Ø¯Ø®Ù†', 'ØªØ¹Ø¨Ø§Ù† Ù…Ø¯Ø®Ù†'], 'price': '810 EGP', 'w': '1 KG'}
]

# ================== FAQ ==================
FAQ = [
     # ------------------ 2: Ø§Ù„Ø·ÙÙŠÙ„ÙŠØ§Øª/Ø§Ù„Ø¯ÙˆØ¯ ------------------
    {
        'keywords': ['Ø¯ÙˆØ¯', 'Ø·ÙÙŠÙ„ÙŠØ§Øª', 'Ø­Ø§Ø¬Ø© ØºØ±ÙŠØ¨Ø©', 'Ù…Ø¯ÙˆØ¯Ø©', 'Ø¨Ø§ÙŠØ¸Ø©'],
        'answer': (
            "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ÙŠØ§ ÙÙ†Ø¯Ù…ØŒ Ø§Ù„Ù„ÙŠ Ø¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø³Ù…ÙƒØ© Ø¯ÙŠ Ù…Ø´ Ø¯ÙˆØ¯ØŒ Ø¯ÙŠ Ø¨ØªÙƒÙˆÙ† Ø·ÙÙŠÙ„ÙŠØ§Øª ØªÙˆØ¬Ø¯ ÙÙŠ Ø§Ù„ØªØ¬ÙˆÙŠÙ Ø§Ù„Ø¨Ø·Ù†ÙŠ Ù„Ù„Ø±Ù†Ø¬Ø©. "
            "ÙˆÙ‡ÙŠ Ù„Ø§ ØªØµÙŠØ¨ Ø§Ù„Ø¥Ù†Ø³Ø§Ù† ØªÙ…Ø§Ù…Ø§Ù‹ØŒ ÙˆØ²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©ØŒ Ø¨Ù†Ø¬Ù…Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ Ø¹Ù†Ø¯ Ø¯Ø±Ø¬Ø© -40 ØªØ­Øª Ø§Ù„ØµÙØ± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªØ§Ù… "
            "ÙˆØªØµØ¨Ø­ Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ù…Ø¹Ø§Ø¡ ÙˆÙ„Ø§ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµØ­Ø©."
        )
    },
    # ------------------ 3: ÙŠØ¹Ù†ÙŠ Ø§ÙŠÙ‡ ÙØ§ÙƒÙŠÙˆÙ… ------------------
    {
        'keywords': ['ÙŠØ¹Ù†ÙŠ Ø§ÙŠÙ‡ ÙØ§ÙƒÙŠÙˆÙ…', 'ÙØ§ÙƒÙŠÙˆÙ…', 'vacuum', 'ØªØºÙ„ÙŠÙ'],
        'answer': "ÙØ§ÙƒÙŠÙˆÙ… ÙŠØ¹Ù†ÙŠ Ù…ØºÙ„Ù ÙÙŠ Ø¹Ø¨ÙˆØ§Øª Ù…ÙØ±ØºØ© Ø§Ù„Ù‡ÙˆØ§Ø¡ ØªÙ…Ø§Ù…Ø§Ù‹ØŒ ÙˆØ¯Ù‡ Ø¨ÙŠØ³Ø§Ø¹Ø¯ Ø¥Ù† Ø§Ù„Ù…Ù†ØªØ¬ ÙŠÙØ¶Ù„ Ø·Ø§Ø²Ø¬ ÙˆØµØ­ÙŠ Ù„Ø£Ø·ÙˆÙ„ ÙØªØ±Ø© Ù…Ù…ÙƒÙ†Ø©."
    },
    # ------------------ 4 & 5: Ø§Ù„Ù…Ù†Ø´Ø£ (Ù…ØµØ±ÙŠ ÙˆÙ„Ø§ Ù…Ø³ØªÙˆØ±Ø¯) ------------------
    {
        'keywords': ['Ù…ØµØ±ÙŠ ÙˆÙ„Ø§ Ù…Ø³ØªÙˆØ±Ø¯', 'Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£', 'Ø¨ØªØµÙ†Ø¹Ùˆ ÙÙŠÙ†', 'Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ Ø³ØªØ§Ø±', 'ØµÙ†Ø§Ø¹Ø©'],
        'answer': (
            "Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§ Ù…ØµØ±ÙŠØ© 100% Ø¨ÙŠØªÙ… ØªØµÙ†ÙŠØ¹Ù‡Ø§ ÙˆØªØ¹Ø¨Ø¦ØªÙ‡Ø§ ÙÙŠ Ù…ØµÙ†Ø¹Ù†Ø§ Ø¨Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ (Ù…ØµÙ†Ø¹ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ Ø³ØªØ§Ø±). "
            "ÙˆØ¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ØªÙˆÙ†Ø© Ø¨Ù†ØµØ·Ø§Ø¯Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·ØŒ Ù„ÙƒÙ† Ø§Ù„ÙƒØ§Ù†Ø² (Ø§Ù„Ø¹Ù„Ø¨Ø© Ø§Ù„ØµÙÙŠØ­) Ù†ÙØ³Ù‡Ø§ Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªØ³ØªÙˆØ±Ø¯."
        )
    },
    # ------------------ 6 & 7: Ù†ÙˆØ¹ Ø§Ù„ØªÙˆÙ†Ø© ÙˆØ§Ù„Ø²ÙŠØª ------------------
    {
        'keywords': ['Ù†ÙˆØ¹ Ø§Ù„ØªÙˆÙ†Ø©', 'ÙŠÙ„ÙˆÙÙŠÙ†', 'yellowfin', 'Ø²ÙŠØª ÙˆÙ„Ø§ Ù…ÙŠØ§Ù‡', 'Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØª'],
        'answer': "Ø¨Ù†Ø³ØªØ®Ø¯Ù… ØªÙˆÙ†Ø© ÙŠÙ„ÙˆÙÙŠÙ† (Yellowfin Tuna) Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ ÙˆÙƒÙ„ Ø§Ù„ØªÙˆÙ†Ø© Ø¹Ù†Ø¯Ù†Ø§ Ù…Ø¹Ø¨Ø£Ø© ÙÙŠ Ø²ÙŠØª Ù†Ø¨Ø§ØªÙŠ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ù…ÙŠØ§Ù‡."
    },
    # ------------------ 8: Ù…ÙˆØ§Ø¯ Ø­Ø§ÙØ¸Ø© ------------------
    {
        'keywords': ['Ù…ÙˆØ§Ø¯ Ø­Ø§ÙØ¸Ù‡', 'Ø·Ø¨ÙŠØ¹ÙŠ', 'ÙƒÙŠÙ…Ø§ÙˆÙŠØ§Øª'],
        'answer': "ÙƒÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø£Ø¨Ùˆ Ø§Ù„Ø³ÙŠØ¯ (Ø±Ù†Ø¬Ø©ØŒ ÙØ³ÙŠØ®ØŒ ØªÙˆÙ†Ø©ØŒ Ø³Ù„Ù…ÙˆÙ†) Ø·Ø¨ÙŠØ¹ÙŠØ© 100% ÙˆØ¨Ø¯ÙˆÙ† Ø£ÙŠ Ù…ÙˆØ§Ø¯ Ø­Ø§ÙØ¸Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹."
    },
    # ------------------ 9 & 50 & 51: Ø§Ù„ØªÙˆÙ†Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© ÙˆØ§Ù„ØµØ§Ù„Ø© ------------------
    {
        'keywords': ['ØªÙˆÙ†Ø© Ù…Ø·Ù‡ÙŠØ©', 'Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§ÙƒÙ„', 'ØµØ§Ù„Ø© Ø§ÙƒÙ„', 'Ø³Ù†Ø¯ÙˆØªØ´Ø§Øª', 'Ø³Ù„Ø·Ø©'],
        'answer': (
            "Ø§Ù„ØªÙˆÙ†Ø© Ø§Ù„Ù…Ø·Ù‡ÙŠØ© (Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ ÙˆØ§Ù„Ø­Ù…Ø±Ø§Ø¡) Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø£ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙ…ÙØ±ØºØ© Ø§Ù„Ù‡ÙˆØ§Ø¡. "
            "Ù„ÙƒÙ† Ù„Ù„Ø¹Ù„Ù…: Ù…Ù†ÙŠÙˆ Ø§Ù„Ø³Ø§Ù†Ø¯ÙˆØªØ´Ø§Øª ÙˆØµØ§Ù„Ø© Ø§Ù„Ø£ÙƒÙ„ Ø¨Ø§Ù„ÙØ±ÙˆØ¹ ØºÙŠØ± Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙ‚Ø·."
        )
    },
    # ------------------ 10: Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„ØªÙˆÙ†Ø© Ø§Ù„Ø£Ø¨ÙŠØ¶ ÙˆØ§Ù„Ø£Ø­Ù…Ø± ------------------
    {
        'keywords': ['Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„ØªÙˆÙ†Ø©', 'Ø§Ù„Ù„Ø­Ù… Ø§Ù„Ø§Ø¨ÙŠØ¶', 'Ø§Ù„Ù„Ø­Ù… Ø§Ù„Ø§Ø­Ù…Ø±', 'Ø¨Ø±ÙˆØªÙŠÙ†'],
        'answer': (
            "Ø§Ù„Ù„Ø­Ù… Ø§Ù„Ø£Ø­Ù…Ø± Ø¨Ø±ÙˆØªÙŠÙ†Ù‡ Ø£Ø¹Ù„Ù‰ ÙˆØ·Ø±ÙŠ Ø£ÙƒØªØ± Ø¨Ø³Ø¨Ø¨ Ù…Ø§Ø¯Ø© Ø§Ù„Ù…ÙŠÙˆØºÙ„ÙˆØ¨ÙŠÙ†. "
            "Ø§Ù„Ù„Ø­Ù… Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø¨ÙŠÙƒÙˆÙ† Ø£ÙØªØ­ ÙÙŠ Ø§Ù„Ù„ÙˆÙ† ÙˆÙ‚ÙˆØ§Ù…Ù‡ Ù…Ø®ØªÙ„ÙØŒ ÙˆØ§Ù„Ø§Ø«Ù†ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø³Ø¨ Ø±ØºØ¨Ø© Ø­Ø¶Ø±ØªÙƒ."
        )
    },
    # ------------------ 14 & 26: Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØ§Ù„Ø·Ù„Ø¨ ------------------
    {
        'keywords': ['ØªÙˆØµÙŠÙ„', 'Ø¯Ù„ÙŠÙØ±ÙŠ', 'Ø´Ø­Ù†', 'Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'],
        'answer': (
            f"Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…ØªØ§Ø­ ÙÙŠ (Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©ØŒ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ØŒ Ø§Ù„ØºØ±Ø¯Ù‚Ø©). "
            f"Ù„Ù„Ø·Ù„Ø¨Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ­Ø¯: {WHATSAPP_NUMBER} Ø£Ùˆ 01212166660."
        )
    },
    # ------------------ 15 & 17 & 18 & 19 & 35 & 37: Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¬Ù…Ù„Ø© ------------------
    {
        'keywords': ['Ø¬Ù…Ù„Ø©', 'ØªØµØ¯ÙŠØ±', 'Ù…Ø´ØªØ±ÙŠØ§Øª', 'hr', 'ØªÙˆØ¸ÙŠÙ', 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', 'ØªÙˆØ±ÙŠØ¯'],
        'answer': (
            "Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª:\n"
            "- Ø§Ù„Ø¬Ù…Ù„Ø©: 01211113882\n"
            "- Ø§Ù„ØªØµØ¯ÙŠØ± (Ø£/ Ø£Ø­Ù…Ø¯): 01272475555\n"
            "- Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© HR: 01200056103\n"
            "- Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: 01223066445\n"
            "- Ø§Ù„ØªÙˆØ±ÙŠØ¯ (Ø£/ Ø¨Ù„Ø§Ù„): 01221093951"
        )
    },
    # ------------------ 20 & 33 & 34: Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø±Ù†Ø¬Ø© ÙˆØ§Ù„ØªØ¯Ø®ÙŠÙ† ------------------
    {
        'keywords': ['Ø¹ÙŠØ§Ø± 24', 'Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø±Ù†Ø¬Ø©', 'ØªØ¯Ø®ÙŠÙ†', 'Ù†Ø§Ø´ÙØ©', 'ÙÙŠÙ„ÙŠÙ‡'],
        'answer': (
            "Ø±Ù†Ø¬Ø© Ø¹ÙŠØ§Ø± 24 Ø­Ø¬Ù…Ù‡Ø§ Ø£ØµØºØ± ÙˆØªØ¯Ø®ÙŠÙ†Ù‡Ø§ Ø£Ø·ÙˆÙ„ ÙˆØ·Ø¹Ù…Ù‡Ø§ Ø£Ù‚ÙˆÙ‰. "
            "Ø£Ù…Ø§ Ø§Ù„ÙÙŠÙ„ÙŠÙ‡ ÙØ¨ØªØ§Ø®Ø¯ 3 Ø·Ø¨Ù‚Ø§Øª ØªØ¯Ø®ÙŠÙ† Ø¹Ø´Ø§Ù† ÙƒØ¯Ù‡ Ø¨ØªÙƒÙˆÙ† Ø£Ù†Ø´Ù Ø´ÙˆÙŠØ© ÙˆØ·Ø¹Ù…Ù‡Ø§ Ù…Ø±ÙƒØ² Ø£ÙƒØªØ±."
        )
    },
    # ------------------ 22 & 30 & 42: Ø§Ù„ØªØ³Ø®ÙŠÙ† ÙˆØ§Ù„Ù†Ø§Ø± ------------------
    {
        'keywords': ['ØªØ³Ø®ÙŠÙ†', 'Ù†Ø§Ø±', 'Ø§Ø´ÙˆÙŠ', 'Ø§Ù„Ø¨ÙˆØªØ§Ø¬Ø§Ø²', 'ÙÙƒ ØªØ¬Ù…ÙŠØ¯'],
        'answer': "Ù…Ù…Ù†ÙˆØ¹ ØªØ¹Ø±Ø¶ Ø§Ù„Ø±Ù†Ø¬Ø© Ù„Ù„Ù†Ø§Ø± Ø£Ùˆ Ø§Ù„ØªØ³Ø®ÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹Ø› Ø§Ù„Ù…Ù†ØªØ¬ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø£ÙƒÙ„. Ù„Ùˆ Ù…Ø¬Ù…Ø¯Ø© Ø³ÙŠØ¨Ù‡Ø§ ØªÙÙƒ Ø¨Ø±Ø§Ø­ØªÙ‡Ø§ ÙˆÙƒÙÙ„ Ø¨Ø§Ù„Ù‡Ù†Ø§ ÙˆØ§Ù„Ø´ÙØ§."
    },
    # ------------------ 23 & 49: Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ------------------
    {
        'keywords': ['ØµÙ„Ø§Ø­ÙŠØ©', 'ÙØ±ÙŠØ´', 'Ù…Ø¬Ù…Ø¯Ø©', 'Ù…ÙˆØ§Ø¹ÙŠØ¯', 'Ø¨ÙŠÙØªØ­Ùˆ Ø§Ù…ØªÙ‰'],
        'answer': (
            "Ø§Ù„ÙØ±ÙˆØ¹ Ø´ØºØ§Ù„Ø© Ù…Ù† 10 ØµØ¨Ø§Ø­Ø§Ù‹ Ù„Ù€ 12 Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„. "
            "Ø§Ù„Ø±Ù†Ø¬Ø© Ø§Ù„ÙØ±ÙŠØ´ ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§ Ø´Ù‡Ø± (ØªØ¨Ø±ÙŠØ¯)ØŒ ÙˆØ§Ù„Ù…Ø¬Ù…Ø¯Ø© 3 Ø´Ù‡ÙˆØ± (ØªØ¬Ù…ÙŠØ¯ -18)."
        )
    },
    # ------------------ 27 & 28: Ø§Ù„ÙØ³ÙŠØ® ÙˆØ§Ù„Ø¯Ù… ------------------
    {
        'keywords': ['Ø¯Ù… ÙÙŠ Ø§Ù„ÙØ³ÙŠØ®', 'ÙØ³ÙŠØ® Ø¨ÙˆØ±ÙŠ', 'Ù†ÙˆØ¹ Ø§Ù„Ø³Ù…Ùƒ', 'ØªÙ…Ù„ÙŠØ­'],
        'answer': (
            "Ø§Ù„ÙØ³ÙŠØ® Ø¨ÙˆØ±ÙŠ ÙØ±ÙŠØ´ØŒ ÙˆØ§Ù„Ø¯Ù… Ø§Ù„Ù„ÙŠ Ø¨ØªØ´ÙˆÙÙ‡ Ø¯Ù‡ Ø·Ø¨ÙŠØ¹ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ø£Ù†Ù‡ Ø¨ÙŠØªÙ…Ù„Ø­ ÙØ±ÙŠØ´ ÙˆÙŠØªØ¬Ù…Ø¯ ÙÙˆØ±Ø§Ù‹ØŒ "
            "ÙˆÙ„Ù…Ø§ Ø¨ÙŠÙÙƒ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø¯ÙŠ Ø¨ØªØ¸Ù‡Ø±ØŒ ÙˆØ¯Ù‡ Ø¯Ù„ÙŠÙ„ Ø¥Ù† Ø§Ù„Ø³Ù…ÙƒØ© Ø·Ø§Ø²Ø© Ù…Ø´ Ù…Ø±ÙƒÙˆÙ†Ø©."
        )
    },
    # ------------------ 39 & 48 & 54: Ø§Ù„Ø¨Ø·Ø§Ø±Ø® ------------------
    {
        'keywords': ['Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø·Ø§Ø±Ø®', 'Ù…Ø±Ù…Ù„Ø©', 'Ø®Ø±Ø²', 'Ù†Ø´Ùˆ', 'Ù…Ù‡Ø±ÙˆØ³Ø©'],
        'answer': "Ø¹Ù†Ø¯Ù†Ø§ Ù†ÙˆØ¹ÙŠÙ† Ø¨Ø·Ø§Ø±Ø®: Ù†Ø§Ø´ÙØ© (Ù…Ø±Ù…Ù„Ø©/Ø®Ø±Ø²) ÙˆØ·Ø±ÙŠÙ‚Ø© (Ù†Ø´Ùˆ). ÙˆÙ…ØªØ§Ø­ Ù…Ù†Ù‡Ø§ Ù…Ù‡Ø±ÙˆØ³Ø© ÙÙŠ Ø²ÙŠØª Ø£Ùˆ Ø¨Ø±Ø·Ù…Ø§Ù†Ø§Øª Ø¹Ø³Ù„ ÙˆØ¨Ø±ØªÙ‚Ø§Ù„."
    },
    # ------------------ Ø§Ù„Ù…Ù†ÙŠÙˆ ------------------
    {
        'keywords': ['Ø§Ù„Ù…Ù†ÙŠÙˆ ', 'Ø§Ù„Ø§Ø³Ø¹Ø§Ø±', 'Ù…Ù†ÙŠÙˆ Ø§Ù„Ø±Ù†Ø¬Ø©', 'Ù…Ù…ÙƒÙ† Ø§Ù„Ù…Ù†ÙŠÙˆ', 'Ø§Ù„Ù…Ù†ÙŠÙˆ Ù„Ùˆ Ø³Ù…Ø­Øª','Ù…Ù†ÙŠÙˆ','menue'],
        'answer': "Ø§Ù„Ù…ÙŠÙ†ÙŠÙˆ ÙƒØ§Ù…Ù„ ÙŠØ§ÙÙ†Ø¯Ù…\n{MENU_LINK}."
    }
]

# ================== Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© ==================
def get_related_products(user_text):
    related = []
    for p in PRODUCTS:
        for kw in p['kw']:
            if smart_similarity(clean_arabic_text(user_text), clean_arabic_text(kw)) >= 70:
                related.append(p)
                break
    return related

# ================== Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒÙŠ ==================
def get_answer(user_id, text):
    q = clean_arabic_text(text)

    # 1ï¸âƒ£ Ø§Ù„Ø³Ù„Ø§Ù…
    for k, v in SMART_GREETINGS.items():
        if k in q:
            return {"text": v, "qr": None}

    # 2ï¸âƒ£ Ø³Ø¤Ø§Ù„ Ø³Ø¹Ø±
    if any(x in q for x in ['Ø¨ÙƒØ§Ù…', 'Ø³Ø¹Ø±', 'Ù‚Ø¯ Ø§ÙŠÙ‡', 'Ø¹Ø§Ù…Ù„ ÙƒØ§Ù…']):

        related = get_related_products(q)

        # Ù„Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ø§ØªØ³Ø£Ù„ Ø¹Ù†Ù‡ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡
        if not related and user_id in USER_CONTEXT:
            p = USER_CONTEXT[user_id]
            return {
                "text": f"ğŸ“Œ {p['kw'][0]}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: {p['price']}\nâš–ï¸ Ø§Ù„ÙˆØ²Ù†: {p['w']}",
                "qr": None
            }

        # Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ ÙˆØ§Ø¶Ø­
        if len(related) == 1:
            USER_CONTEXT[user_id] = related[0]
            return {
                "text": f"ğŸ“Œ {related[0]['kw'][0]}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: {related[0]['price']}\nâš–ï¸ Ø§Ù„ÙˆØ²Ù†: {related[0]['w']}",
                "qr": None
            }

        # Ø£ÙƒØªØ± Ù…Ù† Ù…Ù†ØªØ¬ (Ø²ÙŠ Ø¨Ø·Ø§Ø±Ø® / Ø±Ù†Ø¬Ø©)
        if len(related) > 1:
            quick_replies = []
            for p in related[:10]:
                quick_replies.append({
                    "content_type": "text",
                    "title": p['kw'][0][:20],
                    "payload": f"PRICE|{PRODUCTS.index(p)}"
                })
            return {
                "text": "ØªÙ…Ø§Ù… ğŸ‘ Ø­Ø¶Ø±ØªÙƒ ØªÙ‚ØµØ¯ Ø£Ù†Ù‡ÙŠ Ù†ÙˆØ¹ Ø¨Ø§Ù„Ø¸Ø¨Ø·ØŸ",
                "qr": quick_replies
            }

        return {"text": "ØªØ­Ø¨ ØªØ¹Ø±Ù Ø³Ø¹Ø± Ø£Ù†Ù‡ÙŠ ØµÙ†Ù Ø¨Ø§Ù„Ø¸Ø¨Ø·ØŸ ğŸ˜Š", "qr": None}

    # 3ï¸âƒ£ FAQ
    for f in FAQ:
        for kw in f['keywords']:
            if smart_similarity(q, kw) > 80:
                return {"text": f['answer'], "qr": None}

    # 4ï¸âƒ£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø³Ø¹Ø±
    related = get_related_products(q)
    if len(related) == 1:
        USER_CONTEXT[user_id] = related[0]
        return {
            "text": f"ØªÙ…Ø§Ù… ğŸ‘ ØªØ­Ø¨ ØªØ¹Ø±Ù Ø§Ù„Ø³Ø¹Ø± ÙˆÙ„Ø§ Ø¹Ù†Ø¯Ùƒ Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù†:\nğŸ“Œ {related[0]['kw'][0]}",
            "qr": None
        }

    if len(related) > 1:
        return {
            "text": "ØªØ­Ø¨ ØªØ¹Ø±Ù Ø§Ù„Ø³Ø¹Ø± ÙˆÙ„Ø§ ØªÙ‚ØµØ¯ Ù†ÙˆØ¹ Ù…Ø¹ÙŠÙ†ØŸ ğŸ˜Š",
            "qr": None
        }

    # 5ï¸âƒ£ ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ…
    return {
        "text": (
            "ØªØ­Ø¨ Ø£ÙˆØ¶Ø­ Ù„Ø­Ø¶Ø±ØªÙƒ ğŸ‘\n"
            "Ù‡Ù„ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù†:\n"
            "ğŸ’° Ø§Ù„Ø³Ø¹Ø±ØŸ\n"
            "â“ ÙˆÙ„Ø§ Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ù…Ù†ØªØ¬ØŸ\n\n"
            f"ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: {WHATSAPP_NUMBER}"
        ),
        "qr": None
    }

# ================== Webhook ==================
@app.route('/webhook', methods=['GET'])
def verify():
    if request.args.get("hub.verify_token") == VERIFY_TOKEN:
        return request.args.get("hub.challenge")
    return "failed", 403

@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.get_json()
    for entry in data.get("entry", []):
        for msg_event in entry.get("messaging", []):
            sender = msg_event["sender"]["id"]

            if "message" in msg_event:
                msg = msg_event["message"]

                # Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø¹Ø±
                if "quick_reply" in msg:
                    payload = msg["quick_reply"]["payload"]
                    if payload.startswith("PRICE"):
                        idx = int(payload.split("|")[1])
                        p = PRODUCTS[idx]
                        USER_CONTEXT[sender] = p
                        send_message(
                            sender,
                            f"ğŸ“Œ {p['kw'][0]}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: {p['price']}\nâš–ï¸ Ø§Ù„ÙˆØ²Ù†: {p['w']}"
                        )

                # Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
                elif "text" in msg:
                    res = get_answer(sender, msg["text"])
                    send_message(sender, res["text"], res.get("qr"))

    return "ok", 200

def send_message(user_id, text, quick_replies=None):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    payload = {
        "recipient": {"id": user_id},
        "message": {"text": text}
    }
    if quick_replies:
        payload["message"]["quick_replies"] = quick_replies

    requests.post(url, json=payload)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))


