from flask import Flask, request
from fuzzywuzzy import fuzz
import requests
import re

app = Flask(__name__)

# ุงูุฐุงูุฑุฉ ููุงุฆูุฉ ุงูููุชุฌุงุช (ููุง ูู ูู ููุฏู)
USER_CONTEXT = {} 
PRODUCTS = [
    # ุงูุฑูุฌุฉ
    {'kw': ['ุฑูุฌู ูุฏุฎูู ูุจุทุฑุฎู ูุฑููู', 'ุฑูุฌู ูุจุทุฑุฎู', 'ุฑูุฌู ูุฑููู'], 'price': '250 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ูุฏุฎูู', 'ุฑูุฌู ุนุงุฏูู'], 'price': '200 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ูุฏุฎูู 24 ููุฑุงุท', 'ุฑูุฌู 24', 'ุฑูุฌู ุนูุงุฑ 24'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู 24 ูุจุทุฑุฎู', 'ุฑูุฌู 24 ูุฑููู'], 'price': '320 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููุฒูุนู ุงูุงุญุดุงุก ูุงูููู', 'ุฑูุฌู ูุงูููู'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููููู ุจุฏูู ุฒูุช', 'ุฑูุฌู ููููู ุณุงุฏู'], 'price': '600 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููููู ุตูุต ูููู ููุงููุงุฑ'], 'price': '150 EGP', 'w': '200 G'},
    {'kw': ['ุฑูุฌู ููููู ูุงุฑู'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุฑูุฌู ููููู ุฒูุช'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุฑูุฌู ููููู ูุฏุฎูู'], 'price': '85 EGP', 'w': '125 G'},
    {'kw': ['ูุงููุงุฑ ุณุจุฑูุฏ', 'ุฑูุฌู ูุงููุงุฑ ุณุจุฑูุฏ'], 'price': '70 EGP', 'w': '200 G/130 G'},
    {'kw': ['ุจุทุงุฑุฎ ุฑูุฌู ุฒูุช ูุงููุฉ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุจุทุงุฑุฎ ุฑูุฌู ุจุฑุชูุงู', 'ุจุทุงุฑุฎ ููุฑูุณู'], 'price': '250 EGP', 'w': '250 G'},
    # ุงููุงูุฑูู
    {'kw': ['ูุงูุฑูู ูุฏุฎู ูููุญ', 'ูุงูุฑูู'], 'price': '410 EGP', 'w': '1 KG'},
    {'kw': ['ูุงูุฑูู ูุงูููู'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ูุงูุฑูู ููููู'], 'price': '800 EGP', 'w': '1 KG'},
    # ุงููุณูุฎ
    {'kw': ['ูุณูุฎ ููููู ุฒูุช', 'ูุณูุฎ ุฒูุช'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ููููู ุฏุฎุงู', 'ูุณูุฎ ูุฏุฎู'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ุณุจุฑูุฏ ุจูุฌุฑ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ุจุฏูู ุจูุชูุฑูุง', 'ูุณูุฎ ุทุจู'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ูุณูุฎ ูุจุทุฑุฎ'], 'price': '560 EGP', 'w': '1 KG'},
    {'kw': ['ุดุฑุงุฆุญ ุจูุฑู ูุฏุฎูู', 'ููููู ุจูุฑู ูุฏุฎู'], 'price': '810 EGP', 'w': '1 KG'},
    # ุงูุณูููู
    {'kw': ['ุณูููู ุญุงุฑ', 'spicy salmon'], 'price': '150 EGP', 'w': '125 G'},
    {'kw': ['ุดุฑุงุฆุญ ุณูููู ูุฏุฎูู', 'ุณูููู ููููู'], 'price': '3000 EGP', 'w': '1 KG'},
    {'kw': ['ุณุชูู ุณูููู'], 'price': '1810 EGP', 'w': '1 KG'},
    {'kw': ['ุดูุฑุจู ุณูููู'], 'price': '90 EGP', 'w': '160 G'},
    # ุงูุจุทุงุฑุฎ ูุงูุชููุฉ
    {'kw': ['ุจุทุงุฑุฎ ุจูุฑู ูููุญู', 'ุจุทุงุฑุฎ ุจูุฑู'], 'price': '2850 EGP', 'w': '1 KG'},
    {'kw': ['ุชููู ุญูุฑุงุก ููููู', 'ุชููู ุญูุฑุง'], 'price': '155 EGP', 'w': '230 G'},
    {'kw': ['ุชููู ูุทุน', ' chunks tuna'], 'price': '70 EGP', 'w': '125 G'},
    {'kw': ['ุชููู ูุทููู'], 'price': '710 EGP', 'w': '1 KG'},
    # ุฃุฎุฑู
    {'kw': ['ุงูุดูุฌู ููููู ุฒูุช', 'ุงูุดูุฌู'], 'price': '110 EGP', 'w': '125 G'},
    {'kw': ['ุณุฑุฏูู ูููุญ'], 'price': '200 EGP', 'w': '250 G'},
    {'kw': ['ุญูุดุงู ูุฏุฎู', 'ุชุนุจุงู ูุฏุฎู'], 'price': '810 EGP', 'w': '1 KG'}
]

# ================== FAQ ==================
FAQ = [
    {
        "keywords": [
            "ููุงุนูุฏ ูุฑูุนูู","ููุงุนูุฏ ุงููุฑูุน","ุงููุฑูุน ุดุบุงูู ููุณุงุนู ูุงู","ูู ูุงู ููุงู"
        ],
        "answer": "ุฃููุง ุจุญุถุฑุชู ๐น\nููุงุนูุฏ ูุฑูุนูุง ูู 10 ุตุจุงุญุงู ุญุชู 12 ููุชุตู ุงูููู"
    },
    {
        "keywords": [
            "ุชุตุฏูุฑ","ูุณุฆูู ุงูุชุตุฏูุฑ","ุฑูู ุงูุชุตุฏูุฑ","ุงุฏุงุฑู ุงูุชุตุฏูุฑ"
        ],
        "answer": "ุฃููุง ุจุญุถุฑุชู ๐น\nุฑูู ุฃุณุชุงุฐ ุฃุญูุฏ ูุณุฆูู ุงูุชุตุฏูุฑ (ูุงุชุณุงุจ): 01272475555"
    },
    {
        "keywords": [
            "ูุดุชุฑูุงุช","ุงุฏุงุฑู ุงููุดุชุฑูุงุช","ุฑูู ุงููุดุชุฑูุงุช"
        ],
        "answer": "ุฃููุง ุจุญุถุฑุชู ๐น\nุฑูู ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช: 01223066445"
    },
    {
        "keywords": [
            "hr","ุงุชุด ุงุฑ","ูุธุงุฆู","ุชุนูููุงุช","ุงูุชูุธูู"
        ],
        "answer": "ุฃููุง ุจุญุถุฑุชู ๐น\nุฑูู ุฅุฏุงุฑุฉ HR ุจูุฑุณุนูุฏ: 01200056103"
    },
    {
        "keywords": [
            "ุฑูุฌู 24","ุนูุงุฑ 24","ูุฑู ุงูุฑูุฌู"
        ],
        "answer": (
            "ุฃููุง ุจุญุถุฑุชู ๐น\n"
            "ุฑูุฌุฉ ุนูุงุฑ 24:\n"
            "โ๏ธ ุนุฏุฏ ุณุงุนุงุช ุงูุชุฏุฎูู ุฃุทูู\n"
            "โ๏ธ ุญุฌู ุงูุณููุฉ ุฃุตุบุฑ\n"
            "โ๏ธ ุทุนู ุงูุชุฏุฎูู ุฃููู"
        )
    },
    {
        "keywords": [
            "ุงุญูุธ ุงูุฑูุฌู","ุชุฎุฒูู ุงูุฑูุฌู","ุงููุฑูุฒุฑ ููุง ุงูุซูุงุฌู"
        ],
        "answer": "ููุถู ุญูุธ ุงูุฑูุฌุฉ ูู ุงููุฑูุฒุฑ ุจุนุฏ ุงูุดุฑุงุก"
    },
    {
        "keywords": [
            "ุฑูุฌู ูุดููู","ุงุดูู ุงูุฑูุฌู","ุงุณุฎู ุงูุฑูุฌู"
        ],
        "answer": "ูุง ููุฌุฏ ุฑูุฌุฉ ููุดููุ ุงูุฑูุฌุฉ ุฌุงูุฒุฉ ููุฃูู ููุง ุชุชุนุฑุถ ูุฃู ุญุฑุงุฑุฉ"
    },
    {
        "keywords": [
            "ูุฑู ุงููุฌูุฏ ูุงููุฑูุด","ุฑูุฌู ูุฌูุฏู","ุฑูุฌู ูุฑูุด"
        ],
        "answer": (
            "ุงููุฑู ุจูู ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ูุงููุฑูุด:\n"
            "๐น ุงููุฌูุฏุฉ: -18 ุฏุฑุฌุฉ โ ุตูุงุญูุฉ 3 ุดููุฑ\n"
            "๐น ุงููุฑูุด: 0 ุฅูู 4 ุฏุฑุฌุฉ โ ุตูุงุญูุฉ ุดูุฑ"
        )
    },
    {
        "keywords": [
            "ูุฒู ูุฑุชููู","ูุฑุชููู ุงูุฑูุฌู"
        ],
        "answer": "ูุฒู ูุฑุชููุฉ ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ูู 7.5 ุฅูู 8 ูููู"
    },
    {
        "keywords": [
            "ุฏู ูู ุงููุณูุฎ","ุงููุณูุฎ ูู ุฏู"
        ],
        "answer": (
            "ุงููุณูุฎ ุฌุงูุฒ ููุฃูู ๐น\n"
            "ุงูุณูุงุฆู ุจุณุจุจ ุงูุชูููุญ ุงููุฑูุด ูุงูุชุฌููุฏ"
        )
    }
]


def clean(text):
    if not text: return ""
    text = text.lower().strip()
    # ุชุญููู ุงูุฃุฑูุงู
    text = text.translate(str.maketrans("ููกูขูฃูคูฅูฆูงูจูฉ", "0123456789"))
    # ุญุฐู ุงูุญุดู
    stop_words = ['ุนุงูุฒ', 'ุงุนุฑู', 'ูู ุณูุญุช', 'ุนูุฏูู', 'ุนูุฏูู', 'ูููู', 'ูุง ููุฏู', 'ุญุถุฑุชู', 'ุจูุงู']
    for word in stop_words: text = text.replace(word, "")
    # ุชูุญูุฏ ุงูุญุฑูู
    text = re.sub(r"(\d+)", r" \1 ", text)
    text = re.sub(r"[ุฅุฃุขุง]", "ุง", text); text = re.sub(r"ุฉ", "ู", text); text = re.sub(r"ู", "ู", text)
    return re.sub(r"[^\w\s]", "", text).strip()

def detect_product(text):
    q = clean(text)
    for p in PRODUCTS:
        for k in p["kw"]:
            # ุงุณุชุฎุฏุงู ratio ุนุงูู ููุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ
            if fuzz.partial_ratio(q, clean(k)) > 80 or clean(k) in q:
                return p
    return None

def get_answer(user_id, text):
    raw_q = text.lower()
    q_cleaned = clean(text)
    
    # 1. ูุญุต ุงูุณูุงู (ุดุงูู)
    if any(w in raw_q for w in ['ุงููุง', 'ุณูุงู', 'ุตุจุงุญ', 'ูุณุงุก', 'ุงุฒูู']):
        return "ุฃููุงู ุจู ูู ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ๐ ุญุงุจุจ ุชุนุฑู ุฃุณุนุงุฑูุง ุฅูู ุงูููุงุฑุฏุฉุ"

    # 2. ุชุญุฏูุฏ ุงูููุชุฌ (ุชุญุฏูุซ ุงูุฐุงูุฑุฉ)
    product = detect_product(text)
    if product: USER_CONTEXT[user_id] = product

    # 3. ูู ุงูุณุคุงู ุนู ุณุนุฑุ
    if any(x in raw_q for x in ["ุณุนุฑ", "ุจูุงู", "ูุงู", "ูุฏ ุงูู", "ุฌููู", "ุจูู"]):
        p = product or USER_CONTEXT.get(user_id)
        if p:
            return f"๐ฐ ุณุนุฑ {p['kw'][0]}:\nุงููุฒู: {p['w']}\nุงูุณุนุฑ: {p['price']} โจ"
        return "ุชุญุจ ุชุนุฑู ุณุนุฑ ุฃููู ุตููุ ๐"

    # 4. ุงูู FAQ
    for f in FAQ:
        for kw in f["keywords"]:
            if fuzz.partial_ratio(q_cleaned, clean(kw)) > 85:
                return f["answer"]

    # 5. ุฑุฏ ุฐูู ูู ููู ุตูู ุจุณ ูููุงุด ุณุคุงู
    if product:
        return f"๐ {product['kw'][0]} ูุชุงุญ ูุง ููุฏู. ุชุญุจ ุชุนุฑู ุณุนุฑูุ"

    return "ูุนุชุฐุฑ ูููุ ูู ุฃููู ุงุณุชูุณุงุฑู. ููููู ุงูุณุคุงู ุนู ุงูุฃุณุนุงุฑ ุฃู ุงูุชูุตูู ๐๏ธ"

# (ุจุงูู ููุฏ ุงูู Webhook ู send_message ููุง ูู)
