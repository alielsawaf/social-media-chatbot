from flask import Flask, request, send_file, abort
from fuzzywuzzy import fuzz
import requests
import re
import os
from datetime import datetime
import csv

app = Flask(__name__)

# ================== ุงูุฅุนุฏุงุฏุงุช ==================
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
VERIFY_TOKEN = "my_secret_token"
WHATSAPP_NUMBER = "201090636076"
MENU_LINK = "https://heyzine.com/flip-book/31946f16d5.html"
FUZZY_THRESHOLD = 70
CSV_FILE = os.path.join(os.path.dirname(__file__), "failed_questions.csv")

# ูููุงุช ูุณุงุนุฏุฉ ูุฒูุงุฏุฉ ุฏูุฉ ุงูููู
PRICE_WORDS = ['ุณุนุฑ','ุจูุงู','ูุงู','ุนุงูู','ุชูููู','ุซูู','ูููุฉ','ุณุนุฑู','ุงูุงุณุนุงุฑ','ุจูุฏ ุงูู']
GREETINGS = ['ุงููุง','ุณูุงู','ูุงู','ููุง','ูุฑุญุจุง','ุตุจุงุญ','ูุณุงุก','ุงุฒูู','ูุง ููุฏู','ูุง ุงุณุชุงุฐ']

# ================== ุฃุฏูุงุช ูุณุงุนุฏุฉ ==================
def normalize_numbers(text):
    return text.translate(str.maketrans("ููกูขูฃูคูฅูฆูงูจูฉ", "0123456789"))

def clean_arabic_text(text):
    if not text: return ""
    text = normalize_numbers(text.lower().strip())
    text = re.sub(r"[ุฅุฃุขุง]", "ุง", text)
    text = re.sub(r"ุฉ", "ู", text)
    text = re.sub(r"ู", "ู", text)
    text = re.sub(r"[^\w\s]", "", text)
    return re.sub(r"\s+", " ", text)

def smart_match(user_text, target_text):
    """ุฏูุฌ ุฃูุซุฑ ูู ููุน ููููุฒู ูุฒูุงุฏุฉ ุงูููู"""
    # 1. ุชุทุงุจู ุงููุฌููุนุงุช (ุจูููู ูู ุงููููุงุช ูุชูุฎุจุทุฉ)
    score1 = fuzz.token_set_ratio(user_text, target_text)
    # 2. ุชุทุงุจู ุฌุฒุฆู (ูู ุงุณู ุงูููุชุฌ ูุณุท ุฌููุฉ ุทูููุฉ)
    score2 = fuzz.partial_ratio(user_text, target_text)
    return max(score1, score2)

def log_failed(question):
    file_exists = os.path.isfile(CSV_FILE)
    with open(CSV_FILE, "a", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        if not file_exists:
            writer.writerow(["question", "created_at"])
        writer.writerow([question, datetime.now().strftime("%Y-%m-%d %H:%M:%S")])

# ================== ุงูููุชุฌุงุช ูุงูุฃุณุฆูุฉ (ููุณ ุจูุงูุงุชู) ==================
# ... (ุถุน ูุงุฆูุฉ PRODUCTS ู FAQ ุงูุฎุงุตุฉ ุจู ููุง ููุง ูู ูู ูุณุฎุชู ุงููุณุชูุฑุฉ) ...
PRODUCTS = [
      # ุงูุฑูุฌุฉ
    {'kw': ['ุฑูุฌู ูุฏุฎูู ูุจุทุฑุฎู ูุฑููู', 'ุฑูุฌู ูุจุทุฑุฎู', 'ุฑูุฌู ูุฑููู'], 'price': '250 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ูุฏุฎูู', 'ุฑูุฌู ุนุงุฏูู'], 'price': '200 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ูุฏุฎูู 24 ููุฑุงุท', 'ุฑูุฌู 24', 'ุฑูุฌู ุนูุงุฑ 24'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู 24 ูุจุทุฑุฎู', 'ุฑูุฌู 24 ูุฑููู'], 'price': '320 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููุฒูุนู ุงูุงุญุดุงุก ูุงูููู', 'ุฑูุฌู ูุงูููู'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููููู ุจุฏูู ุฒูุช', 'ุฑูุฌู ููููู ุณุงุฏู'], 'price': '600 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููููู ุตูุต ูููู ููุงููุงุฑ'], 'price': '150 EGP', 'w': '200 G'},
    {'kw': ['ุฑูุฌู ููููู ูุงุฑู'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุฑูุฌู ููููู ุฒูุช'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุฑูุฌู ููููู ูุฏุฎูู'], 'price': '85 EGP', 'w': '125 G'},
    {'kw': ['ูุงููุงุฑ ุณุจุฑูุฏ', 'ุฑูุฌู ูุงููุงุฑ ุณุจุฑูุฏ'], 'price': '70 EGP', 'w': '200 G/130 G'},
    {'kw': ['ุจุทุงุฑุฎ ุฑูุฌู ุฒูุช ูุงููุฉ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุจุทุงุฑุฎ ุฑูุฌู ุจุฑุชูุงู', 'ุจุทุงุฑุฎ ููุฑูุณู'], 'price': '250 EGP', 'w': '250 G'},
    # ุงููุงูุฑูู
    {'kw': ['ูุงูุฑูู ูุฏุฎู ูููุญ', 'ูุงูุฑูู'], 'price': '410 EGP', 'w': '1 KG'},
    {'kw': ['ูุงูุฑูู ูุงูููู'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ูุงูุฑูู ููููู'], 'price': '800 EGP', 'w': '1 KG'},
    # ุงููุณูุฎ
    {'kw': ['ูุณูุฎ ููููู ุฒูุช', 'ูุณูุฎ ุฒูุช'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ููููู ุฏุฎุงู', 'ูุณูุฎ ูุฏุฎู'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ุณุจุฑูุฏ ุจูุฌุฑ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ุจุฏูู ุจูุชูุฑูุง', 'ูุณูุฎ ุทุจู'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ูุณูุฎ ูุจุทุฑุฎ'], 'price': '560 EGP', 'w': '1 KG'},
    {'kw': ['ุดุฑุงุฆุญ ุจูุฑู ูุฏุฎูู', 'ููููู ุจูุฑู ูุฏุฎู'], 'price': '810 EGP', 'w': '1 KG'},
    # ุงูุณูููู
    {'kw': ['ุณูููู ุญุงุฑ', 'spicy salmon'], 'price': '150 EGP', 'w': '125 G'},
    {'kw': ['ุดุฑุงุฆุญ ุณูููู ูุฏุฎูู', 'ุณูููู ููููู'], 'price': '3000 EGP', 'w': '1 KG'},
    {'kw': ['ุณุชูู ุณูููู'], 'price': '1810 EGP', 'w': '1 KG'},
    {'kw': ['ุดูุฑุจู ุณูููู'], 'price': '90 EGP', 'w': '160 G'},
    # ุงูุจุทุงุฑุฎ ูุงูุชููุฉ
    {'kw': ['ุจุทุงุฑุฎ ุจูุฑู ูููุญู', 'ุจุทุงุฑุฎ ุจูุฑู'], 'price': '2850 EGP', 'w': '1 KG'},
    {'kw': ['ุชููู ุญูุฑุงุก ููููู', 'ุชููู ุญูุฑุง'], 'price': '155 EGP', 'w': '230 G'},
    {'kw': ['ุชููู ูุทุน', ' chunks tuna'], 'price': '70 EGP', 'w': '125 G'},
    {'kw': ['ุชููู ูุทููู'], 'price': '710 EGP', 'w': '1 KG'},
    # ุฃุฎุฑู
    {'kw': ['ุงูุดูุฌู ููููู ุฒูุช', 'ุงูุดูุฌู'], 'price': '110 EGP', 'w': '125 G'},
    {'kw': ['ุณุฑุฏูู ูููุญ'], 'price': '200 EGP', 'w': '250 G'},
    {'kw': ['ุญูุดุงู ูุฏุฎู', 'ุชุนุจุงู ูุฏุฎู'], 'price': '810 EGP', 'w': '1 KG'}
]

FAQ = [
    # ------------------ 2: ุงูุทููููุงุช/ุงูุฏูุฏ ------------------
    {
        'keywords': ['ุฏูุฏ', 'ุทููููุงุช', 'ุญุงุฌุฉ ุบุฑูุจุฉ', 'ูุฏูุฏุฉ', 'ุจุงูุธุฉ'],
        'answer': (
            "ุฃููุง ุจุญุถุฑุชู ูุง ููุฏูุ ุงููู ุธูุฑ ูู ุงูุณููุฉ ุฏู ูุด ุฏูุฏุ ุฏู ุจุชููู ุทููููุงุช ุชูุฌุฏ ูู ุงูุชุฌููู ุงูุจุทูู ููุฑูุฌุฉ. "
            "ููู ูุง ุชุตูุจ ุงูุฅูุณุงู ุชูุงูุงูุ ูุฒูุงุฏุฉ ูู ุงูููุงูุฉุ ุจูุฌูุฏ ุงูุฃุณูุงู ุนูุฏ ุฏุฑุฌุฉ -40 ุชุญุช ุงูุตูุฑ ูุถูุงู ุงูุฃูุงู ุงูุชุงู "
            "ูุชุตุจุญ ุฌุฒุกุงู ูู ุงูุฃูุนุงุก ููุง ุชุคุซุฑ ุนูู ุงูุตุญุฉ."
        )
    },
    # ------------------ 3: ูุนูู ุงูู ูุงูููู ------------------
    {
        'keywords': ['ูุนูู ุงูู ูุงูููู', 'ูุงูููู', 'vacuum', 'ุชุบููู'],
        'answer': "ูุงูููู ูุนูู ูุบูู ูู ุนุจูุงุช ููุฑุบุฉ ุงูููุงุก ุชูุงูุงูุ ูุฏู ุจูุณุงุนุฏ ุฅู ุงูููุชุฌ ููุถู ุทุงุฒุฌ ูุตุญู ูุฃุทูู ูุชุฑุฉ ููููุฉ."
    },
    # ------------------ 4 & 5: ุงูููุดุฃ (ูุตุฑู ููุง ูุณุชูุฑุฏ) ------------------
    {
        'keywords': ['ูุตุฑู ููุง ูุณุชูุฑุฏ', 'ุจูุฏ ุงูููุดุฃ', 'ุจุชุตูุนู ููู', 'ุจูุฑุณุนูุฏ ุณุชุงุฑ', 'ุตูุงุนุฉ'],
        'answer': (
            "ููุชุฌุงุชูุง ูุตุฑูุฉ 100% ุจูุชู ุชุตููุนูุง ูุชุนุจุฆุชูุง ูู ูุตูุนูุง ุจุจูุฑุณุนูุฏ (ูุตูุน ุจูุฑุณุนูุฏ ุณุชุงุฑ). "
            "ูุจุงููุณุจุฉ ููุชููุฉ ุจูุตุทุงุฏูุง ูู ุงูุจุญุฑ ุงููุชูุณุทุ ููู ุงููุงูุฒ (ุงูุนูุจุฉ ุงูุตููุญ) ููุณูุง ูู ุงููู ุจุชุณุชูุฑุฏ."
        )
    },
    # ------------------ 6 & 7: ููุน ุงูุชููุฉ ูุงูุฒูุช ------------------
    {
        'keywords': ['ููุน ุงูุชููุฉ', 'ูููููู', 'yellowfin', 'ุฒูุช ููุง ููุงู', 'ููุน ุงูุฒูุช'],
        'answer': "ุจูุณุชุฎุฏู ุชููุฉ ูููููู (Yellowfin Tuna) ุนุงููุฉ ุงูุฌูุฏุฉุ ููู ุงูุชููุฉ ุนูุฏูุง ูุนุจุฃุฉ ูู ุฒูุช ูุจุงุชู ููุท ุจุฏูู ููุงู."
    },
    # ------------------ 8: ููุงุฏ ุญุงูุธุฉ ------------------
    {
        'keywords': ['ููุงุฏ ุญุงูุธู', 'ุทุจูุนู', 'ูููุงููุงุช'],
        'answer': "ูู ููุชุฌุงุช ุฃุจู ุงูุณูุฏ (ุฑูุฌุฉุ ูุณูุฎุ ุชููุฉุ ุณูููู) ุทุจูุนูุฉ 100% ูุจุฏูู ุฃู ููุงุฏ ุญุงูุธุฉ ููุงุฆูุงู."
    },
    # ------------------ 9 & 50 & 51: ุงูุชููุฉ ุงูุฌุงูุฒุฉ ูุงูุตุงูุฉ ------------------
    {
        'keywords': ['ุชููุฉ ูุทููุฉ', 'ุฌุงูุฒุฉ ููุงูู', 'ุตุงูุฉ ุงูู', 'ุณูุฏูุชุดุงุช', 'ุณูุทุฉ'],
        'answer': (
            "ุงูุชููุฉ ุงููุทููุฉ (ุงูุจูุถุงุก ูุงูุญูุฑุงุก) ุฌุงูุฒุฉ ููุฃูู ูุจุงุดุฑุฉ ูููุฑุบุฉ ุงูููุงุก. "
            "ููู ููุนูู: ูููู ุงูุณุงูุฏูุชุดุงุช ูุตุงูุฉ ุงูุฃูู ุจุงููุฑูุน ุบูุฑ ูุชุงุญูู ุญุงููุงูุ ุงูุจูุน ููููุชุฌุงุช ููุท."
        )
    },
    # ------------------ 10: ุงููุฑู ุจูู ุงูุชููุฉ ุงูุฃุจูุถ ูุงูุฃุญูุฑ ------------------
    {
        'keywords': ['ุงููุฑู ุจูู ุงูุชููุฉ', 'ุงููุญู ุงูุงุจูุถ', 'ุงููุญู ุงูุงุญูุฑ', 'ุจุฑูุชูู'],
        'answer': (
            "ุงููุญู ุงูุฃุญูุฑ ุจุฑูุชููู ุฃุนูู ูุทุฑู ุฃูุชุฑ ุจุณุจุจ ูุงุฏุฉ ุงููููุบููุจูู. "
            "ุงููุญู ุงูุฃุจูุถ ุจูููู ุฃูุชุญ ูู ุงูููู ูููุงูู ูุฎุชููุ ูุงูุงุซููู ูุชุงุญูู ุญุณุจ ุฑุบุจุฉ ุญุถุฑุชู."
        )
    },
    # ------------------ 14 & 26: ุงูุชูุตูู ูุงูุทูุจ ------------------
    {
        'keywords': ['ุชูุตูู', 'ุฏูููุฑู', 'ุดุญู', 'ุงูููุงูู', 'ุฑูู ุงูุทูุจ'],
        'answer': (
            f"ุงูุชูุตูู ูุชุงุญ ูู (ุงููุงูุฑุฉุ ุงูุฅุณููุฏุฑูุฉุ ุจูุฑุณุนูุฏุ ุงูุบุฑุฏูุฉ). "
            f"ููุทูุจุงุช ุชูุงุตู ูุนูุง ุนูู ุงูุฑูู ุงูููุญุฏ: {WHATSAPP_NUMBER} ุฃู 01212166660."
        )
    },
    # ------------------ 15 & 17 & 18 & 19 & 35 & 37: ุงูุฅุฏุงุฑุงุช ูุงูุฌููุฉ ------------------
    {
        'keywords': ['ุฌููุฉ', 'ุชุตุฏูุฑ', 'ูุดุชุฑูุงุช', 'hr', 'ุชูุธูู', 'ูุฏูุฑ ุงูุญุณุงุจุงุช', 'ุชูุฑูุฏ'],
        'answer': (
            "ููุชูุงุตู ูุน ุงูุฅุฏุงุฑุงุช:\n"
            "- ุงูุฌููุฉ: 01211113882\n"
            "- ุงูุชุตุฏูุฑ (ุฃ/ ุฃุญูุฏ): 01272475555\n"
            "- ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ HR: 01200056103\n"
            "- ุงููุดุชุฑูุงุช: 01223066445\n"
            "- ุงูุชูุฑูุฏ (ุฃ/ ุจูุงู): 01221093951"
        )
    },
    # ------------------ 20 & 33 & 34: ุฃููุงุน ุงูุฑูุฌุฉ ูุงูุชุฏุฎูู ------------------
    {
        'keywords': ['ุนูุงุฑ 24', 'ุงููุฑู ุจูู ุงูุฑูุฌุฉ', 'ุชุฏุฎูู', 'ูุงุดูุฉ', 'ููููู'],
        'answer': (
            "ุฑูุฌุฉ ุนูุงุฑ 24 ุญุฌููุง ุฃุตุบุฑ ูุชุฏุฎูููุง ุฃุทูู ูุทุนููุง ุฃููู. "
            "ุฃูุง ุงูููููู ูุจุชุงุฎุฏ 3 ุทุจูุงุช ุชุฏุฎูู ุนุดุงู ูุฏู ุจุชููู ุฃูุดู ุดููุฉ ูุทุนููุง ูุฑูุฒ ุฃูุชุฑ."
        )
    },
    # ------------------ 22 & 30 & 42: ุงูุชุณุฎูู ูุงููุงุฑ ------------------
    {
        'keywords': ['ุชุณุฎูู', 'ูุงุฑ', 'ุงุดูู', 'ุงูุจูุชุงุฌุงุฒ', 'ูู ุชุฌููุฏ'],
        'answer': "ููููุน ุชุนุฑุถ ุงูุฑูุฌุฉ ูููุงุฑ ุฃู ุงูุชุณุฎูู ููุงุฆูุงูุ ุงูููุชุฌ ุฌุงูุฒ ููุฃูู. ูู ูุฌูุฏุฉ ุณูุจูุง ุชูู ุจุฑุงุญุชูุง ูููู ุจุงูููุง ูุงูุดูุง."
    },
    # ------------------ 23 & 49: ุงูุตูุงุญูุฉ ูุงูููุงุนูุฏ ------------------
    {
        'keywords': ['ุตูุงุญูุฉ', 'ูุฑูุด', 'ูุฌูุฏุฉ', 'ููุงุนูุฏ', 'ุจููุชุญู ุงูุชู'],
        'answer': (
            "ุงููุฑูุน ุดุบุงูุฉ ูู 10 ุตุจุงุญุงู ูู 12 ููุชุตู ุงูููู. "
            "ุงูุฑูุฌุฉ ุงููุฑูุด ุตูุงุญูุชูุง ุดูุฑ (ุชุจุฑูุฏ)ุ ูุงููุฌูุฏุฉ 3 ุดููุฑ (ุชุฌููุฏ -18)."
        )
    },
    # ------------------ 27 & 28: ุงููุณูุฎ ูุงูุฏู ------------------
    {
        'keywords': ['ุฏู ูู ุงููุณูุฎ', 'ูุณูุฎ ุจูุฑู', 'ููุน ุงูุณูู', 'ุชูููุญ'],
        'answer': (
            "ุงููุณูุฎ ุจูุฑู ูุฑูุดุ ูุงูุฏู ุงููู ุจุชุดููู ุฏู ุทุจูุนู ุฌุฏุงู ูุฃูู ุจูุชููุญ ูุฑูุด ููุชุฌูุฏ ููุฑุงูุ "
            "ูููุง ุจููู ุงูุณูุงุฆู ุฏู ุจุชุธูุฑุ ูุฏู ุฏููู ุฅู ุงูุณููุฉ ุทุงุฒุฉ ูุด ูุฑูููุฉ."
        )
    },
    # ------------------ 39 & 48 & 54: ุงูุจุทุงุฑุฎ ------------------
    {
        'keywords': ['ููุน ุงูุจุทุงุฑุฎ', 'ูุฑููุฉ', 'ุฎุฑุฒ', 'ูุดู', 'ููุฑูุณุฉ'],
        'answer': "ุนูุฏูุง ููุนูู ุจุทุงุฑุฎ: ูุงุดูุฉ (ูุฑููุฉ/ุฎุฑุฒ) ูุทุฑููุฉ (ูุดู). ููุชุงุญ ูููุง ููุฑูุณุฉ ูู ุฒูุช ุฃู ุจุฑุทูุงูุงุช ุนุณู ูุจุฑุชูุงู."
    }
]

# ================== ููุทู ุงูุฑุฏ (ุงููุญุณู) ==================
def get_answer(user_text):
    q_clean = clean_arabic_text(user_text)
    
    # 1. ุฃููุงู: ูุญุต ุงูุณูุงู ูุงูุชุฑุญูุจ
    if any(w in q_clean for w in GREETINGS):
        if len(q_clean.split()) < 3:
            return {"text": f"ุฃููุงู ุจู ูู ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ๐ ููุฑุชูุง.. ููุทูุจุงุช ูุงุชุณุงุจ: {WHATSAPP_NUMBER}\nุญุงุจุจ ุชุนุฑู ุณุนุฑ ุตูู ูุนูู ููุง ุนูุฏู ุงุณุชูุณุงุฑุ", "quick_replies": None}

    # 2. ุซุงููุงู: ูุญุต ุงูู FAQ (ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ) - ุนุทููุงูุง ุฃููููุฉ
    # ูู ุงูุนููู ุจูุณุฃู ุนู (ุชูุตููุ ุฏูุฏุ ูุงููููุ ุฌููุฉ.. ุฅูุฎ) ููุฑุฏ ูู ููุง ุงูุฃูู
    for item in FAQ:
        for kw in item['keywords']:
            if smart_similarity(q_clean, clean_arabic_text(kw)) >= 85: # ุฏูุฉ ุนุงููุฉ ููู FAQ
                return {"text": item['answer'], "quick_replies": None}

    # 3. ุซุงูุซุงู: ูุญุต ุทูุจุงุช "ุงูุณุนุฑ" (ูู ุงูุฌููุฉ ูููุง ูููุฉ ุณุนุฑ ุฃู ุจูุงู ุฃู ุฌููู)
    PRICE_KEYWORDS = ['ุณุนุฑ', 'ุจูุงู', 'ุฌููู', 'ุจูุฏ ุงูู', 'ุงููููุฉ', 'ูุงู']
    is_price_query = any(p_kw in q_clean for p_kw in PRICE_KEYWORDS)

    # 4. ุฑุงุจุนุงู: ุงูุจุญุซ ูู ุงูููุชุฌุงุช
    matches = []
    for p in PRODUCTS:
        for kw in p['kw']:
            score = smart_similarity(q_clean, clean_arabic_text(kw))
            # ูู ุณุงุฆู ุนู ุงูุณุนุฑ ุตุฑุงุญุฉ ุจูููู ุงููููุฏุ ูู ููุงู ุนุงุฏู ุจูุนูู ุงููููุฏ
            threshold = 70 if is_price_query else 90 
            if score >= threshold:
                matches.append(p)
                break

    if len(matches) > 1:
        qr = [{"content_type": "text", "title": m['kw'][0][:20], "payload": f"PRODUCT_INDEX|{PRODUCTS.index(m)}"} for m in matches[:10]]
        return {"text": "ุญุถุฑุชู ุชูุตุฏ ุฃู ููุน ุจุงูุธุจุทุ (ุงุฎุชุฑ ูู ุงููุงุฆูุฉ)", "quick_replies": qr}

    if len(matches) == 1:
        p = matches[0]
        return {"text": f"๐ {p['kw'][0]}\n๐ฐ ุงูุณุนุฑ: {p['price']}\nโ๏ธ ุงููุฒู: {p['w']}", "quick_replies": None}

    # 5. ุฎุงูุณุงู: ูู ูููุด ุฑุฏ ุฎุงูุต (ุฑุฏ ุงูุชุฑุงุถู ุฐูู)
    return {
        "text": (
            f" ูููู ุชูุถุญ ุงูุณุคุงู ุฃูุชุฑ ูุงููุฏู. "
            # f"๐น ููุทูุจุงุช ูุงูุชูุตูู: {WHATSAPP_NUMBER}\n"
            # f"๐น ููุดุงูุฏุฉ ุงููููู ุงููุงูู: {MENU_LINK}\n"
            # f"ุฃู ุงุณุฃููู ุนู (ุฃุณุนุงุฑ ุงูุฑูุฌุฉุ ุงููุณูุฎุ ุงูุชููุฉุ ุฃู ููุงุนูุฏ ุงููุฑูุน)."
        ),
        "quick_replies": None
    }
# ================== Webhook ==================
@app.route('/webhook', methods=['GET'])
def verify():
    if request.args.get("hub.verify_token") == VERIFY_TOKEN:
        return request.args.get("hub.challenge")
    return "failed", 403

@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.get_json()
    if data.get("object") == "page":
        for entry in data.get("entry", []):
            for msg_event in entry.get("messaging", []):
                sender = msg_event["sender"]["id"]
                if "message" in msg_event:
                    msg = msg_event["message"]
                    if "quick_reply" in msg:
                        p = PRODUCTS[int(msg["quick_reply"]["payload"].split("|")[1])]
                        send_message(sender, f"๐ {p['kw'][0]}\n๐ฐ ุงูุณุนุฑ: {p['price']}\nโ๏ธ ุงููุฒู: {p['w']}")
                    elif "text" in msg:
                        res = get_answer(msg["text"])
                        send_message(sender, res["text"], res.get("quick_replies"))
    return "ok", 200

def send_message(user_id, text, quick_replies=None):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    payload = {"recipient": {"id": user_id}, "message": {"text": text}}
    if quick_replies: payload["message"]["quick_replies"] = quick_replies
    requests.post(url, json=payload)
# ================== ุชุญููู CSV ==================
CSV_PASSWORD = "123321"
@app.route('/download_csv')
def download_csv():
    if request.args.get("password") != CSV_PASSWORD:
        return abort(403)
    if not os.path.isfile(CSV_FILE):
        return "ูุง ููุฌุฏ ููู ุจุนุฏ"
    return send_file(CSV_FILE, as_attachment=True)
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))



