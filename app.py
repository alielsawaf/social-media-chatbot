from flask import Flask, request
import requests
import os

app = Flask(__name__)

# ================== CONFIG ==================
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
VERIFY_TOKEN = "my_secret_token"

# ================== DATA ==================
FAQ_MAP = {
  "ุงูุฑูุฌุฉ ูููุง ุฏูุฏ": "ูุง ููุฏู ุฏู ูุด ุฏูุฏุ ุฏู ุจูููู ุทููููุงุช... (ููุณ ุงููุต ุงูุฃุตูู)",
  "ูููู": "ุฏู ูููู ูููู ุงูููุชุฌุงุช ุจุชุงุนุชูุง: https://heyzine.com/flip-book/31946f16d5.html",
  "ุงุฒุงู ุงุชุฃูุฏ ุงู ุงูุฑูุฌุฉ ุฏู ุฑูุฌุฉ ุงุจู ุงูุณูุฏ": "ุญุถุฑุชู ุญุงูู ุดุฑุงุก ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ูู ูุตุงุฏุฑ ููุซููุฉ ูุถูุงู ุญุตููู ุนูู ุงูููุชุฌ ุงูุฃุตูู.",
  "ุงูุฌููุฉ ุงู ุงุณุนุงุฑ ุงูุฌููุฉ": "ููุงุณุชูุณุงุฑ ูุทูุจ ุงููุณุงุนุฏุฉ ูุฑุฌู ุงูุงุชุตุงู ุนูู ุฃุฑูุงู ุงููุตูุน: 01211113882",
  "ุงูุณูุฏูุชุดุงู|ุงูุณุงูุฏูุชุดุงู": "ูููู ุงูุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ ุบูุฑ ูุชุงุญ ุญุงููุงู ููุง ููุฌุฏ ุชูุตูู ููุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ.",
  "ุงูุณูุทุฉ": "ูููู ุงูุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ ุบูุฑ ูุชุงุญ ุญุงููุงู ููุง ููุฌุฏ ุชูุตูู ููุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ.",
  "ููุงุนูุฏ ุงููุฑูุน": "ููุงุนูุฏ ุงูุนูู ูู ุงูุณุงุนุฉ 10 ุตุจุงุญุงู ุญุชู ุงูุณุงุนุฉ 12 ููุชุตู ุงูููู.",
  "ุงูุชุตุฏูุฑ": "ุญุถุฑุชู ุชูุงุตู ูุงุชุณุงุจ ูุน ุงูุฃุณุชุงุฐ ุฃุญูุฏ ุนูู ุฑูู 01272475555 ููู ููุณุงุนุฏ ุญุถุฑุชู.",
  "ุฑูู ุงุฏุงุฑุฉ ุงููุดุชุฑูุงุช": "ุฑูู ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช: 01223066445",
  "ุงูุชูุธูู": "ุฑูู ุฅุฏุงุฑุฉ ุงูู HR ูู ุจูุฑุณุนูุฏ: 01200056103",
  "ูููู ุงุดูู ุงูุฑูุฌุฉ": "ูุง ููุฌุฏ ุฑูุฌุฉ ููุดูู ููุง ุชุชุนุฑุถ ูุฃู ุญุฑุงุฑุฉ...",
  "ุงููุฑู ุจูู ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ูุงููุฑูุด": "ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ุชุญูุธ ูู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ -18 ูุตูุงุญูุชูุง 3 ุดููุฑ...",
  "ูุฒู ูุฑุชููุฉ ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ": "ูุฒู ูุฑุชููุฉ ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ุจูููู ูู 7.5 ุฅูู 8 ูููู ูุง ููุฏู.",
  "ุงููุฑู ุจูู ุงูููุณ ุงูุงุณูุฏ ูุงูุฌููุฏ ูุงูููู ูู ุงููุณูุฎ": "ุงูุฃุญุฌุงู ุงูุตุบูุฑุฉ ุจุชููู ูู ุงูุชุบููู ุงูุฌููุฏ ูุงูููู...",
  "ุงููุฑู ุจูู ุงูุฑูุฌุฉ ุงูุนุงุฏูุฉ ูุนูุงุฑ 24": "ุนูุงุฑ 24 ุนุฏุฏ ุณุงุนุงุช ุงูุชุฏุฎูู ููู ุฃุทูู...",
  "ููููุฉ ุงูุงุญุชูุงุธ ุจุงูุฑูุฌุฉ ุจุนุฏ ุงูุดุฑุงุก": "ููุถู ุญูุธ ุงูุฑูุฌุฉ ูู ุงููุฑูุฒุฑ ุจุนุฏ ุงูุดุฑุงุก.",
  "ูุนูู ุงูู ุฑูุฌุฉ ูุงูููู": "ุฑูุฌุฉ ูุบููุฉ ูู ุนุจูุงุช ููุฑุบุฉ ุงูููุงุก.",
  "ุงููุณูุฎ ุจูุชููุญ ุงุฒุงู": "ุงููุณูุฎ ูุชู ุชุตููุนู ูู ุณูู ุงูุจูุฑู...",
  "ุงููุฑู ุจูู ูุญู ุงูุชููุฉ ุงูุงุจูุถ ูุงูุงุญูุฑ": "ุงููุญู ุงูุฃุจูุถ ุฃูุชุญ ูู ุงูุฃุญูุฑ...",
  "ููู ุงููุณูุฎ ุจูููู ูู ุฏู": "ุงูุณููุฉ ุฌุงูุฒุฉ ููุฃููุ ูุงูุฏู ุจูููู ูุชูุฌุฉ ุงูุชูููุญ ุงููุฑูุด ูุงูุชุฌููุฏ...",
  "ููู ุงูุฑูุฌุฉ ุงูููููู ูุงุดูุฉ": "ุงูุฑูุฌุฉ ุงูููููู ุจุชููู ูุฎููุฉ ูุจุชุงุฎุฏ 3 ุทุจูุงุช ุชุฏุฎูู...",
  "ุงููุฑู ุจูู ุงูุฑูุฌุฉ ุงูููููู ูุงูุนุงุฏูุฉ": "ุงูููููู ูุฎููุฉ ูุชูุฑ ุจูุฑุงุญู ุชูููุญ ูุชุฏุฎูู ููุซู...",
  "ูุฏูุฑ ุงูุญุณุงุจุงุช": "ุงูุฃุณุชุงุฐ ูุญูุฏ ุงูุดูุงุน ูุฏูุฑ ุงูุญุณุงุจุงุชุ ุฑูู ุงูุชูุงุตู: 01204464066",
  "ุชูุฑูุฏ ููููุงุฏู ูุงููุทุงุนู": "ุงูุฃุณุชุงุฐ ุจูุงู ูุณุคูู ุงูุชูุฑูุฏุ ุฑูู ุงูุชูุงุตู: 01221093951",
  "ุงููุฑู ุจูู ุงูุณูููู ุงููุงูููู ูุงูููุณ ุงูุงุณูุฏ": "ุงูุงุฎุชูุงู ูู ููู ุงููุญู ุจุณุจุจ ุทุฑููุฉ ุงูุชุฏุฎูู...",
  "ุงูุชููุฉ ุฒูุช ููุง ููุงู": "ูู ุงูุชููุฉ ูุนุจุฃุฉ ูู ุฒูุช ูุจุงุชู ููุท.",
  "ููุน ุงูุชููุฉ": "ุชููุฉ ูููููู.",
  "ุจุชุตุทุงุฏูุง ุงูุชููุฉ ูููู": "ูู ูุตุฑ ูู ุงูุจุญุฑ ุงูุฃุจูุถ ุงููุชูุณุท.",
  "ููู ุงูููุชุฌุงุช ุบุงููุฉ": "ูุฃููุง ุจูุถูู ุฌูุฏุฉ ุนุงููุฉ ูุทุฑููุฉ ุชูููุญ ูุชุฏุฎูู ูุฎุชููุฉ.",
  "ูู ูู ููุงุฏ ุญุงูุธุฉ": "ูู ููุชุฌุงุชูุง ุจุฏูู ููุงุฏ ุญุงูุธุฉ.",
  "ูู ูููู ุงุณุฎู ุงูุฑูุฌุฉ": "ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ูุง ูููู ุชุณุฎูููุง ุฃู ุทูููุงุ ูู ุฌุงูุฒุฉ ููุฃูู.",
}

PRODUCT_MAP = {
  "Smoked Herring with Roe": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุฏุฎูุฉ ูุจุทุฑุฎุฉ ูุฑููุฉ: 1 KG โ 250 EGP โจ",
  "Smoked Herring": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุฏุฎูุฉ: 1 KG โ 200 EGP โจ",
  "Smoked Herring 24 Kerat": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุฏุฎูุฉ 24 ููุฑุงุท: 1 KG โ 300 EGP โจ",
  "Smoked Herring 24 Kerat with Roe": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุฏุฎูุฉ ูุจุทุฑุฎุฉ ูุฑููุฉ 24 ููุฑุงุท: 1 KG โ 320 EGP โจ",
  "Gutted Smoked Vacuumed Herring": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุฏุฎูุฉ ููุฒูุนุฉ ุงูุฃุญุดุงุก ูุงูููู: 1 KG โ 300 EGP โจ",
  "Smoked Vacuumed Herring with Roe": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุจุทุฑุฎุฉ ูุฑููุฉ ูุงูููู: 1 KG โ 300 EGP โจ",
  "Smoked Herring in Vacuum Packing": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุฏุฎูุฉ ูุงูููู: 1 KG โ 275 EGP โจ",
  "Herring Fillets without Oil": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ููููู ุจุฏูู ุฒูุช: 1 KG โ 600 EGP โจ",
  "Herring Fillets with Pepper Sauce and Caviar": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ููููู ุจุตูุต ุงููููู ูุงููุงููุงุฑ: 200 G โ 150 EGP โจ",
  "Herring Fillets with Sweet Sauce": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ููููู ุจุตูุต ุงูุณูุฑ: 230 G โ 180 EGP โจ",
  "Herring Fillets with Curry Sauce": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ููููู ุจุตูุต ุงููุงุฑู: 250 G โ 250 EGP โจ",
  "Herring Fillets with Pepper Sauce": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ููููู ุจุตูุต ุงููููู: 250 G โ 250 EGP โจ",
  "Herring Fillets with Vegetable Oil": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ููููู ุจุงูุฒูุช ุงููุจุงุชู: 250 G โ 250 EGP โจ",
  "Smoked Herring Fillets": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ููููู ูุฏุฎูุฉ: 125 G โ 85 EGP โจ",
  "Herring with Caviar Spread 200": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุน ูุงููุงุฑ ุณุจุฑูุฏ: 200 G โ 70 EGP โจ",
  "Herring with Caviar Spread 130": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุน ูุงููุงุฑ ุณุจุฑูุฏ: 130 G โ 70 EGP โจ",
  "Herring with Caviar Spread Tube": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุน ูุงููุงุฑ ุณุจุฑูุฏ ุชููุจ: 100 G โ 70 EGP โจ",
  "Herring Roe with Vegetable Oil": "๐ฐ ุณุนุฑ ุจุทุงุฑุฎ ุฑูุฌุฉ ุจุงูุฒูุช ุงููุจุงุชู ูุฑููุฉ ูุงููุฉ: 250 G โ 250 EGP โจ",
  "Herring Roe with Orange Sauce": "๐ฐ ุณุนุฑ ุจุทุงุฑุฎ ุฑูุฌุฉ ุจุตูุต ุงูุจุฑุชูุงู ูุฑููุฉ ููุฑูุณุฉ: 250 G โ 250 EGP โจ",
  "Herring Roe with Honey Sauce": "๐ฐ ุณุนุฑ ุจุทุงุฑุฎ ุฑูุฌุฉ ุจุตูุต ุงูุนุณู ูุฑููุฉ ููุฑูุณุฉ: 250 G โ 250 EGP โจ",
  "Herring Roe White": "๐ฐ ุณุนุฑ ูุดู ุจุทุงุฑุฎ ุฑูุฌุฉ ุจุงูุฒูุช ุงููุจุงุชู: 250 G โ 250 EGP โจ",
  "Gutted Smoked Mackerel Salted": "๐ฐ ุณุนุฑ ูุงูุฑูู ูุฏุฎู ูููุญ ููุฒูุน ุงูุฃุญุดุงุก: 1 KG โ 410 EGP โจ",
  "Smoked Salted Mackerel Vacuumed": "๐ฐ ุณุนุฑ ูุงูุฑูู ูุฏุฎู ูููุญ ููุฒูุน ุงูุฃุญุดุงุก ูุงูููู: 1 KG โ 460 EGP โจ",
  "Mackerel Fillets with Spices Vacuumed": "๐ฐ ุณุนุฑ ูุงูุฑูู ููููู ุจุงูุชูุงุจู ูุงูููู: 1 KG โ 800 EGP โจ",
  "Mackerel Fillets Vacuumed": "๐ฐ ุณุนุฑ ูุงูุฑูู ููููู ุณุงุฏุฉ ูุงูููู: 1 KG โ 800 EGP โจ",
  "Salted Grey Mullet with Vegetable Oil": "๐ฐ ุณุนุฑ ููููู ุจูุฑู ูููุญ ุฒูุช ูุจุงุชู: 250 G โ 250 EGP โจ",
  "Salted Grey Mullet with Smoked Oil": "๐ฐ ุณุนุฑ ููููู ุจูุฑู ูููุญ ุฒูุช ุฏุฎุงู: 250 G โ 250 EGP โจ",
  "Salted Grey Mullet with Beet Sauce": "๐ฐ ุณุนุฑ ูุณูุฎ ุณุจุฑูุฏ ุจุตูุต ุงูุจูุฌุฑ: 250 G โ 250 EGP โจ",
  "Salted Grey Mullet with Curry Sauce": "๐ฐ ุณุนุฑ ูุณูุฎ ุณุจุฑูุฏ ุจุตูุต ุงููุงุฑู: 250 G โ 250 EGP โจ",
  "Salted Grey Mullet with Pepper Sauce": "๐ฐ ุณุนุฑ ูุณูุฎ ุณุจุฑูุฏ ุจุตูุต ุงููููู: 250 G โ 250 EGP โจ",
  "Smoked Salted Mullet": "๐ฐ ุณุนุฑ ุจูุฑู ูููุญ ูุฏุฎู ูุณูุฎ: 230 G โ 150 EGP โจ",
  "Salted Mullet without Bacteria": "๐ฐ ุณุนุฑ ูุณูุฎ ุจุฏูู ุจูุชูุฑูุง: 1 KG โ 460 EGP โจ",
  "Salted Mullet with Roe": "๐ฐ ุณุนุฑ ูุณูุฎ ูุจุทุฑุฎ ุจุฏูู ุจูุชูุฑูุง: 1 KG โ 560 EGP โจ"
}

# ================== CONTEXT ==================
USER_CONTEXT = {}

def normalize(text):
    arabic_digits = "ููกูขูฃูคูฅูฆูงูจูฉ"
    english_digits = "0123456789"
    for a, e in zip(arabic_digits, english_digits):
        text = text.replace(a, e)
    return text.lower().replace("ุฉ", "ู").replace("ุฃ", "ุง").replace("ุฅ", "ุง").replace("ุข", "ุง").strip()

def expand_question(q):
    SYNONYMS = {
        "ุฑูุฌู": ["ุฑูุฌุฉ", "ุงูุฑูุฌู", "ุฑูู"],
        "ูุณูุฎ": ["ูุณูุฎ", "ูุณุฎ"],
        "ููููู": ["ููููู", "ููููุฉ", "fillet", "filet"],
        "ูุงูููู": ["ูุงูููู", "vacuum"],
        "24": ["24", "ุนูุงุฑ", "ููุฑุงุท"],
        "ุณุนุฑ": ["ุณุนุฑ", "ุจูุงู", "ูุงู"]
    }
    expanded = q
    for key, words in SYNONYMS.items():
        for w in words:
            if w in q:
                expanded += f" {key}"
    return expanded

def get_context(user_id):
    return USER_CONTEXT.get(user_id, {"last_product": None, "last_category": None})

def set_context(user_id, product=None, category=None):
    ctx = USER_CONTEXT.get(user_id, {"last_product": None, "last_category": None})
    if product: ctx["last_product"] = product
    if category: ctx["last_category"] = category
    USER_CONTEXT[user_id] = ctx

# ================== BOT LOGIC ==================
def get_answer(user_id, text):
    q = expand_question(normalize(text))
    ctx = get_context(user_id)

    greetings = ["ุงููุง", "ุณูุงู", "ูุณุงุก", "ุตุจุงุญ", "ูุฑุญุจุง", "ูุงู", "ุงุฒูู"]
    thanks = ["ุดูุฑุง", "ุดูุฑ", "ุชูุงู", "ููุฑุณู", "ุชุณูู", "ุฌุฒุงู", "ูุงุดู"]
    if any(w in q for w in thanks):
        return "ุชุญุช ุฃูุฑู ูุง ููุฏู ๐น ูู ุงุญุชุงุฌุช ุฃู ุญุงุฌุฉ ุงุจุนุชููุง ูู ุฃู ููุช."
    if any(w in q for w in greetings):
        return "ุฃููุงู ุจู ูู ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ๐ ููุฑุชูุง.. ุฃุณุงุนุฏ ุญุถุฑุชู ุงุฒุงูุ"

    # ุชุญูู ูู ูุฌูุฏ ุงูููุชุฌ ูู ุงูุณุคุงู
    selected_product = None
    for prod in PRODUCT_MAP.keys():
        if normalize(prod) in q:
            selected_product = prod
            set_context(user_id, product=prod)
            break

    # ุชุญูู ูู ุงููุฆุฉ
    categories = ["ุฑูุฌ", "ููููู", "ูุณูุฎ", "ุจูุฑู", "ูุงูุฑูู", "ุจุทุงุฑุฎ", "ุณุจุฑูุฏ", "ุชูู", "ุชููู", "ุณูููู"]
    selected_category = None
    for cat in categories:
        if cat in q:
            selected_category = cat
            set_context(user_id, category=cat)
            break

    # ูู ุงูุนููู ุทูุจ ุณุนุฑ ููุท
    if any(w in q for w in ["ุณุนุฑ", "ูุงู", "ุจูุงู"]):
        if ctx.get("last_product"):
            return PRODUCT_MAP.get(ctx["last_product"], f"๐ฐ ุณุนุฑ ุงูููุชุฌ {ctx['last_product']} ูุด ูุชููุฑ.")
        if ctx.get("last_category"):
            cat = ctx["last_category"]
            prices = [v for k, v in PRODUCT_MAP.items() if cat in normalize(k)]
            if prices:
                return f"๐ฐ ุชุดูููุฉ {cat}:\n" + "\n".join(prices)
            else:
                return f"ูุง ุชูุฌุฏ ููุชุฌุงุช ูุชุงุญุฉ ุถูู {cat} ุญุงููุงู."

    # ุงูุฑุฏ ุนูู ุงูุฃุณุฆูุฉ ุงูุนุงูุฉ ูู FAQ_MAP
    for key, val in FAQ_MAP.items():
        if all(word in q for word in key.split("|")):
            return val

    # ุงูุฑุฏ ุนูู ููุชุฌ ูุญุฏุฏ ุฃู ูุฆุฉ
    if selected_product:
        return PRODUCT_MAP[selected_product]
    if selected_category:
        prices = [v for k, v in PRODUCT_MAP.items() if selected_category in normalize(k)]
        if prices:
            return f"๐ฐ ุชุดูููุฉ {selected_category}:\n" + "\n".join(prices)

    return "ุจุนุชุฐุฑ ูุญุถุฑุชู ูุงููุฏู.. ูููู ุชูุถุญ ุงูุณุคุงู ุฃูุชุฑ ุนุดุงู ุฃูุฏุฑ ุฃุณุงุนุฏูุ"

# ================== WEBHOOK ==================
@app.route("/webhook", methods=["GET"])
def verify():
    if request.args.get("hub.verify_token") == VERIFY_TOKEN:
        return request.args.get("hub.challenge")
    return "failed", 403

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()
    if data.get("object") == "page":
        for entry in data.get("entry", []):
            for ev in entry.get("messaging", []):
                sender = ev["sender"]["id"]
                if "message" in ev and "text" in ev["message"]:
                    msg_text = ev["message"]["text"]
                    reply = get_answer(sender, msg_text)
                    send_message(sender, reply)
    return "ok", 200

def send_message(user_id, text):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    payload = {"recipient": {"id": user_id}, "message": {"text": text}}
    try:
        requests.post(url, json=payload)
    except Exception as e:
        print(f"Error sending message: {e}")

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))
