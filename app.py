from flask import Flask, request, jsonify
from fuzzywuzzy import fuzz
import requests
import re
import urllib.parse
import os

app = Flask(__name__)

# --- ุงูุฅุนุฏุงุฏุงุช (ุชุฃูุฏ ูู ูุทุงุจูุชูุง ูุญุณุงุจู) ---
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
VERIFY_TOKEN = "my_secret_token"
WHATSAPP_NUMBER = "201090636076"
MENU_LINK = "https://heyzine.com/flip-book/31946f16d5.html"

def clean_arabic_text(text):
  if not text:
        return ""
    # ุชุญููู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ ุฅูู ุฅูุฌููุฒูุฉ
    arabic_numbers = 'ููกูขูฃูคูฅูฆูงูจูฉ'
    english_numbers = '0123456789'
    trans = str.maketrans(arabic_numbers, english_numbers)
    text = text.translate(trans)
    # 2. ุชูุธูู ุงููุต ูุชูุญูุฏ ุงูุญุฑูู
    text = text.strip().lower()
    text = re.sub(r"[ุฅุฃุขุง]", "ุง", text)
    text = re.sub(r"ุฉ", "ู", text)
    text = re.sub(r"ู", "ู", text)
    text = re.sub(r'[^\w\s]', '', text)
    return re.sub(r'\s+', ' ', text).strip()

# --- 1. ูุงุนุฏุฉ ุจูุงูุงุช ุงูููุชุฌุงุช (ุงูุตููุ ุงูุณุนุฑุ ุงููุฒู) ---
PRODUCTS = [
    # ุงูุฑูุฌุฉ
    {'kw': ['ุฑูุฌู ูุฏุฎูู ูุจุทุฑุฎู ูุฑููู', 'ุฑูุฌู ูุจุทุฑุฎู', 'ุฑูุฌู ูุฑููู'], 'price': '250 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ูุฏุฎูู', 'ุฑูุฌู ุนุงุฏูู'], 'price': '200 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ูุฏุฎูู 24 ููุฑุงุท', 'ุฑูุฌู 24', 'ุฑูุฌู ุนูุงุฑ 24'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู 24 ูุจุทุฑุฎู', 'ุฑูุฌู 24 ูุฑููู'], 'price': '320 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููุฒูุนู ุงูุงุญุดุงุก ูุงูููู', 'ุฑูุฌู ูุงูููู'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููููู ุจุฏูู ุฒูุช', 'ุฑูุฌู ููููู ุณุงุฏู'], 'price': '600 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููููู ุตูุต ูููู ููุงููุงุฑ'], 'price': '150 EGP', 'w': '200 G'},
    {'kw': ['ุฑูุฌู ููููู ูุงุฑู'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุฑูุฌู ููููู ุฒูุช'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุฑูุฌู ููููู ูุฏุฎูู'], 'price': '85 EGP', 'w': '125 G'},
    {'kw': ['ูุงููุงุฑ ุณุจุฑูุฏ', 'ุฑูุฌู ูุงููุงุฑ ุณุจุฑูุฏ'], 'price': '70 EGP', 'w': '200 G/130 G'},
    {'kw': ['ุจุทุงุฑุฎ ุฑูุฌู ุฒูุช ูุงููุฉ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุจุทุงุฑุฎ ุฑูุฌู ุจุฑุชูุงู', 'ุจุทุงุฑุฎ ููุฑูุณู'], 'price': '250 EGP', 'w': '250 G'},
    # ุงููุงูุฑูู
    {'kw': ['ูุงูุฑูู ูุฏุฎู ูููุญ', 'ูุงูุฑูู'], 'price': '410 EGP', 'w': '1 KG'},
    {'kw': ['ูุงูุฑูู ูุงูููู'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ูุงูุฑูู ููููู'], 'price': '800 EGP', 'w': '1 KG'},
    # ุงููุณูุฎ
    {'kw': ['ูุณูุฎ ููููู ุฒูุช', 'ูุณูุฎ ุฒูุช'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ููููู ุฏุฎุงู', 'ูุณูุฎ ูุฏุฎู'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ุณุจุฑูุฏ ุจูุฌุฑ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ุจุฏูู ุจูุชูุฑูุง', 'ูุณูุฎ ุทุจู'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ูุณูุฎ ูุจุทุฑุฎ'], 'price': '560 EGP', 'w': '1 KG'},
    {'kw': ['ุดุฑุงุฆุญ ุจูุฑู ูุฏุฎูู', 'ููููู ุจูุฑู ูุฏุฎู'], 'price': '810 EGP', 'w': '1 KG'},
    # ุงูุณูููู
    {'kw': ['ุณูููู ุญุงุฑ', 'spicy salmon'], 'price': '150 EGP', 'w': '125 G'},
    {'kw': ['ุดุฑุงุฆุญ ุณูููู ูุฏุฎูู', 'ุณูููู ููููู'], 'price': '3000 EGP', 'w': '1 KG'},
    {'kw': ['ุณุชูู ุณูููู'], 'price': '1810 EGP', 'w': '1 KG'},
    {'kw': ['ุดูุฑุจู ุณูููู'], 'price': '90 EGP', 'w': '160 G'},
    # ุงูุจุทุงุฑุฎ ูุงูุชููุฉ
    {'kw': ['ุจุทุงุฑุฎ ุจูุฑู ูููุญู', 'ุจุทุงุฑุฎ ุจูุฑู'], 'price': '2850 EGP', 'w': '1 KG'},
    {'kw': ['ุชููู ุญูุฑุงุก ููููู', 'ุชููู ุญูุฑุง'], 'price': '155 EGP', 'w': '230 G'},
    {'kw': ['ุชููู ูุทุน', ' chunks tuna'], 'price': '70 EGP', 'w': '125 G'},
    {'kw': ['ุชููู ูุทููู'], 'price': '710 EGP', 'w': '1 KG'},
    # ุฃุฎุฑู
    {'kw': ['ุงูุดูุฌู ููููู ุฒูุช', 'ุงูุดูุฌู'], 'price': '110 EGP', 'w': '125 G'},
    {'kw': ['ุณุฑุฏูู ูููุญ'], 'price': '200 EGP', 'w': '250 G'},
    {'kw': ['ุญูุดุงู ูุฏุฎู', 'ุชุนุจุงู ูุฏุฎู'], 'price': '810 EGP', 'w': '1 KG'},
]

# --- 2. ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ (FAQ) ---
FAQ = [
    {'keywords': ['ุฏูุฏ', 'ุทููููุงุช', 'ุงูุฑูุฌู ูููุง'], 'answer': "ูุง ูุง ููุฏูุ ุฏู ุทููููุงุช ูุด ุฏูุฏ. ุจุชูุฌุฏ ูู ุงูุชุฌููู ุงูุจุทูู ููุง ุชุตูุจ ุงูุฅูุณุงูุ ูุจูุชู ุงููุถุงุก ุนูููุง ุจุงูุชุฌููุฏ ุนูุฏ -40 ุฏุฑุฌุฉ ูุถูุงู ุงูุฃูุงู."},
    {'keywords': ['ุณุงูุฏูุชุดุงุช', 'ุณูุทุงุช', 'ูุฌุจุงุช'], 'answer': "ูููู ุงูุณุงูุฏูุชุดุงุช ูุงูุณูุทุงุช ุบูุฑ ูุชุงุญ ุญุงูููุง ููุง ููุฌุฏ ุชูุตูู ููุง."},
    {'keywords': ['ุงุตููู', 'ุงุฒุงู ุงุนุฑู', 'ูุฑุชููู'], 'answer': "ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ุจุชููู ูู ูุฑุงุชูู ูุด ุตูุงุฏูู ุฎุดุจุ ููููุถูู ุงูุดุฑุงุก ูู ูุฑูุนูุง ุงูุฑุณููุฉ."},
    {'keywords': ['ุชูุตูู', 'ุฏูููุฑู', 'ุดุญู'], 'answer': "ุงูุชูุตูู ูุชุงุญ ูู: (ุงููุงูุฑุฉุ ุจูุฑุณุนูุฏุ ุงูุฅุณููุฏุฑูุฉุ ุงูุบุฑุฏูุฉ). ููุทูุจุงุช: 01212166660."},
    {'keywords': ['ุฌููู', 'ุชุฌุงุฑ'], 'answer': "ููุงุณุชูุณุงุฑ ุนู ุงูุฌููุฉ ููุท: 01211113882"},
    {'keywords': ['ุชุณุฎูู', 'ูุงุฑ', 'ุงุณุฎู'], 'answer': "ูุง ูุง ููุฏูุ ุงูููุชุฌ ุฌุงูุฒ ููุฃูู ูุจุงุดุฑุฉ ููุง ููุถู ุชุนุฑุถู ูุฃู ุญุฑุงุฑุฉ."},
    {'keywords': ['ูุฑู', 'ูุฌูุฏู', 'ูุฑูุด'], 'answer': "ุงููุฌูุฏุฉ: -18 / ุตูุงุญูุฉ 3 ุดููุฑ. ุงููุฑูุด: ูู 0 ูู 4 / ุตูุงุญูุฉ ุดูุฑ."},
    {'keywords': ['ููุงุฏ ุญุงูุธู', 'ุทุจูุนู'], 'answer': "ูู ููุชุฌุงุชูุง ุทุจูุนูุฉ 100% ูุจุฏูู ุฃู ููุงุฏ ุญุงูุธุฉ."},
    {'keywords': ['ููุงุนูุฏ', 'ุจุชูุชุญูุง'], 'answer': "ูููููุง ูู 10 ุตุจุงุญูุง ุฅูู 12 ููุชุตู ุงูููู."},
    {'keywords': ['ุดุบู', 'ุชูุธูู', 'ููุฏูุจ'], 'answer': "ูููุธุงุฆู ุจุงููุงูุฑุฉ: 01210188882 (ูุงุชุณุงุจ + ุงุชุตุงู)"},
    {'keywords': ['ุชุตุฏูุฑ', 'ุฎุงุฑุฌ ูุตุฑ'], 'answer': "ููุชุตุฏูุฑ: 01272475555 ุฃ/ ุฃุญูุฏ."},
    {'keywords': ['ููุงุฑุฏ ุจุดุฑูู', 'hr'], 'answer': "ุฅุฏุงุฑุฉ ุงูู HR: 01200056103"},
    {'keywords': ['ูููู', 'ุงุณุนุงุฑูู', 'ุจูุงู'], 'answer': f"ุฃููุงู ุจู! ุชูุถู ุงููููู ุงููุงูู ุจุงูุฃุณุนุงุฑ ูู ููุง:\n{MENU_LINK}"}
]

def get_answer(user_question):
    q = clean_arabic_text(user_question)
      # 1. ุงูุชุญูู ูู ูุฌูุฏ "ุณุนุฑ" ุฃู "ุจูุงู" + "ุงุณู ุตูู"
    price_words = ['ุจูุงู', 'ุณุนุฑ', 'ุงุณุนุงุฑ', 'ูููู', 'ุชูููู','ูู','ุนูุฏูู','ุนูุฏูู','ููุฌูุฏ','ููู','ุจุชุจูุนู']
    is_asking_price = any(pw in q for pw in price_words)
    #  ุงูุจุญุซ ูู ุงูููุชุฌุงุช
    for prod in PRODUCTS:
        for kw in prod['kw']:
            if clean_arabic_text(kw) in q:
                return f"ุทูุจ ุญุถุฑุชู ูุชุงุญ: {prod['kw'][0]}\n๐ฐ ุงูุณุนุฑ: {prod['price']}\nโ๏ธ ุงููุฒู: {prod['w']}\n\nุชูุถู ุงููููู ุงููุงูู: {MENU_LINK}"
   
    # 12. ุฅุฐุง ุณุฃู "ุจูุงู" ุฃู "ุณุนุฑ" ุจุดูู ุนุงู (ุจุฏูู ุชุญุฏูุฏ ุตูู)
    if is_asking_price or any(kw in q for kw in ['ูููู', 'ูุงุฆูู', 'ุงุตูุงู','ุงูุงุณุนุงุฑ']):
        return f"ุฃููุงู ุจู! ุชูุถู ุงููููู ุงููุญุฏุซ ุจุฌููุน ููุชุฌุงุชูุง ูู ููุง:\n{MENU_LINK}"
    
    # 2. ุงูุจุญุซ ูู ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ
    for item in FAQ:
        for kw in item['keywords']:
            if clean_arabic_text(kw) in q:
                return item['answer']

    # 3. ุงูุชุญูุงุช
    if any(word in q for word in ['ุณูุงู', 'ููู', 'ุงุฒูู', 'ุตุจุงุญ', 'ูุณุงุก']):
        return "ุฃููุงู ุจู ูู ุฃุจู ุงูุณูุฏุ ููู ูููููุง ูุณุงุนุฏุชู ุ"

    # 4. ุงูุฑุฏ ุงูุงูุชุฑุงุถู
    return f"ุนุฐุฑุงูุ ูู ุฃููู ุทูุจู ุจุฏูุฉ. ููููู ุงูุงุทูุงุน ุนูู ุงููููู ุจุฌููุน ุงูุฃุณุนุงุฑ ูู ููุง:\n{MENU_LINK}\nุฃู ุงูุชูุงุตู ูุน ุฃุญุฏ ููุซูู ุฎุฏูุฉ ุงูุนููุงุก ุนู ุทุฑูู ุงููุงุชุณุงุจ: https://wa.me/{WHATSAPP_NUMBER} \n ุฃู ููููู ุงูุณุคุงู ุจุดูู ุฃูุถุญ ุญุชู ุฃุณุชุทูุน ูุณุงุนุฏุชู"

@app.route('/webhook', methods=['GET'])
def verify():
    if request.args.get("hub.mode") == "subscribe" and request.args.get("hub.challenge"):
        if request.args.get("hub.verify_token") == VERIFY_TOKEN:
            return request.args["hub.challenge"], 200
        return "Verification token mismatch", 403
    return "Bot Online", 200

@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.get_json()
    if data.get("object") == "page":
        for entry in data.get("entry", []):
            for messaging_event in entry.get("messaging", []):
                if messaging_event.get("message"):
                    sender_id = messaging_event["sender"]["id"]
                    text = messaging_event["message"].get("text")
                    if text:
                        response = get_answer(text)
                        send_message(sender_id, response)
    return "ok", 200

def send_message(recipient_id, message_text):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    payload = {"recipient": {"id": recipient_id}, "message": {"text": message_text}}
    requests.post(url, json=payload)

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 8080))
    app.run(host='0.0.0.0', port=port)



