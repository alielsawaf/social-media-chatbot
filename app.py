import os
import requests
from flask import Flask, request

app = Flask(__name__)

# ================== CONFIG (ุชุฃูุฏ ูู ูุถุน ูุฐู ุงูููู ูู ุฑูููุงู) ==================
PAGE_ACCESS_TOKEN = os.environ.get("PAGE_ACCESS_TOKEN")
VERIFY_TOKEN = os.environ.get("VERIFY_TOKEN")
GROQ_API_KEY = os.environ.get("GROQ_API_KEY")

# ================== DATA (ุญุงูุธูุง ุนูู ูู ุจูุงูุงุชู) ==================
FAQ_MAP = {
    "ุงูุฑูุฌุฉ ูููุง ุฏูุฏ": "ููุฏู ุฏู ูุด ุฏูุฏุ ุฏู ุจูููู ุทููููุงุช... (ููุณ ุงููุต ุงููู ุนูุฏู)",
    "ูููู": "ุฏู ูููู ูููู ุงูููุชุฌุงุช ุจุชุงุนุชูุง: https://heyzine.com/flip-book/31946f16d5.html",
    "ุงุฒุงู ุงุชุฃูุฏ ุงู ุงูุฑูุฌุฉ ุฏู ุฑูุฌุฉ ุงุจู ุงูุณูุฏ": "ุญุถุฑุชู ุญุงูู ุดุฑุงุก ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ูู ูุตุงุฏุฑ ููุซููุฉ ูุถูุงู ุญุตููู ุนูู ุงูููุชุฌ ุงูุฃุตูู.",
    "ุงูุฌููุฉ ุงู ุงุณุนุงุฑ ุงูุฌููุฉ": "ููุงุณุชูุณุงุฑ ูุทูุจ ุงููุณุงุนุฏุฉ ูุฑุฌู ุงูุงุชุตุงู ุนูู ุฃุฑูุงู ุงููุตูุน: 01211113882",
    "ุงูุณูุฏูุชุดุงุช": "ูููู ุงูุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ ุบูุฑ ูุชุงุญ ุญุงููุงู ููุง ููุฌุฏ ุชูุตูู ููุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ.",
    "ุงูุณูุทุฉ": "ูููู ุงูุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ ุบูุฑ ูุชุงุญ ุญุงููุงู ููุง ููุฌุฏ ุชูุตูู ููุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ.",
    "ููุงุนูุฏ ุงููุฑูุน": "ููุงุนูุฏ ุงูุนูู ูู ุงูุณุงุนุฉ 10 ุตุจุงุญุงู ุญุชู ุงูุณุงุนุฉ 12 ููุชุตู ุงูููู.",
    "ุงูุชุตุฏูุฑ": "ุญุถุฑุชู ุชูุงุตู ูุงุชุณุงุจ ูุน ุงูุฃุณุชุงุฐ ุฃุญูุฏ ุนูู ุฑูู 01272475555 ููู ููุณุงุนุฏ ุญุถุฑุชู.",
    "ุฑูู ุงุฏุงุฑุฉ ุงููุดุชุฑูุงุช": "ุฑูู ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช: 01223066445",
    "ุงูุชูุธูู": "ุฑูู ุฅุฏุงุฑุฉ ุงูู HR ูู ุจูุฑุณุนูุฏ: 01200056103",
    "ูููู ุงุดูู ุงูุฑูุฌุฉ": "ูุง ููุฌุฏ ุฑูุฌุฉ ููุดูู ููุง ุชุชุนุฑุถ ูุฃู ุญุฑุงุฑุฉุ ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ุฌุงูุฒุฉ ููุฃูู ูุจุงุดุฑุฉ ููุง ูููู ุฏูููุง ุจุงูุฒูุช.",
    "ุงููุฑู ุจูู ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ูุงููุฑูุด": "ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ุชุญูุธ ูู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ -18 ูุตูุงุญูุชูุง 3 ุดููุฑ ููุชู ุญูุธูุง ูู ุงูุชุฌููุฏ. ุงูุฑูุฌุฉ ุงููุฑูุด ุชุญูุธ ูู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ูู 0 ุฅูู 4 ูุตูุงุญูุชูุง ุดูุฑ ููุชู ุญูุธูุง ูู ุงูุชุจุฑูุฏ.",
    "ูุฒู ูุฑุชููุฉ ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ": "ูุฒู ูุฑุชููุฉ ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ุจูููู ูู 7.5 ุฅูู 8 ูููู ูุง ููุฏู.",
    "ุงููุฑู ุจูู ุงูููุณ ุงูุงุณูุฏ ูุงูุฌููุฏ ูุงูููู ูู ุงููุณูุฎ": "ุงูุฃุญุฌุงู ุงูุตุบูุฑุฉ ุจุชููู ูู ุงูุชุบููู ุงูุฌููุฏ ูุงูููู ุจุญุฏ ุฃูุตู 600 ุฌุฑุงูุ ูุงูุฃุญุฌุงู ุงูุฃูุจุฑ ุจุชููู ูู ุงูุชุบููู ุงูุฃุณูุฏ ููููู ุชูุตู ููููู ุฃู ูููู ู200 ุฃู 800 ุฌุฑุงู.",
    "ุงููุฑู ุจูู ุงูุฑูุฌุฉ ุงูุนุงุฏูุฉ ูุนูุงุฑ 24": "ุนูุงุฑ 24 ุนุฏุฏ ุณุงุนุงุช ุงูุชุฏุฎูู ููู ุฃุทููุ ุญุฌู ุงูุณููุฉ ุฃุตุบุฑุ ูุทุนู ุงูุชุฏุฎูู ูุนุฒุฒ ุฃูุซุฑ ุจุณุจุจ ุฒูุงุฏุฉ ุณุงุนุงุช ุงูุชุฏุฎูู.",
    "ููููุฉ ุงูุงุญุชูุงุธ ุจุงูุฑูุฌุฉ ุจุนุฏ ุงูุดุฑุงุก": "ููุถู ุญูุธ ุงูุฑูุฌุฉ ูู ุงููุฑูุฒุฑ ุจุนุฏ ุงูุดุฑุงุก.",
    "ูุนูู ุงูู ุฑูุฌุฉ ูุงูููู": "ุฑูุฌุฉ ูุบููุฉ ูู ุนุจูุงุช ููุฑุบุฉ ุงูููุงุก.",
    "ุงููุณูุฎ ุจูุชููุญ ุงุฒุงู": "ุงููุณูุฎ ูุชู ุชุตููุนู ูู ุณูู ุงูุจูุฑูุ ูุชู ุชูููุญู ูุฑูุด ูููู ุงูููู ุงูุจูุชูุฑูุ ุชูููุญ ุฌุงูุ ููุญูุธ ูู ุซูุงุฌุงุช ุจุฏุฑุฌุงุช ุญุฑุงุฑุฉ ูู 0 ุฅูู 4.",
    "ุงููุฑู ุจูู ูุญู ุงูุชููุฉ ุงูุงุจูุถ ูุงูุงุญูุฑ": "ุงููุญู ุงูุฃุจูุถ ุฃูุชุญ ูู ุงูุฃุญูุฑ ูุฃู ุงูููู ุงูุฃุญูุฑ ูุงุชุฌ ุนู ุงููููุฌููุจูู ูุงูููููุฌููุจููุ ูุงููุญู ุงูุฃุญูุฑ ูุญุชูู ุนูู ูุณุจุฉ ุจุฑูุชูู ุฃุนูู ููููู ุทุฑู ุฃูุซุฑ.",
    "ููู ุงููุณูุฎ ุจูููู ูู ุฏู": "ุงูุณููุฉ ุฌุงูุฒุฉ ููุฃููุ ูุงูุฏู ุจูููู ูุชูุฌุฉ ุงูุชูููุญ ุงููุฑูุด ูุงูุชุฌููุฏุ ูุนูุฏ ูู ุงูุชุฌููุฏ ุจุชุธูุฑ ุงูุณูุงุฆู.",
    "ููู ุงูุฑูุฌุฉ ุงูููููู ูุงุดูุฉ": "ุงูุฑูุฌุฉ ุงูููููู ุจุชููู ูุฎููุฉ ูุจุชุงุฎุฏ 3 ุทุจูุงุช ุชุฏุฎูู ูุชุนุฒูุฒ ุงูุทุนู ูุฏู ุจูุฎูููุง ุฃูุดู ุดููุฉ.",
    "ุงููุฑู ุจูู ุงูุฑูุฌุฉ ุงูููููู ูุงูุนุงุฏูุฉ": "ุงูููููู ูุฎููุฉ ูุชูุฑ ุจูุฑุงุญู ุชูููุญ ูุชุฏุฎูู ููุซู ู3 ุทุจูุงุช ุณูููุ ูุจุชููู ุฃูุดู ูุทุนููุง ูุฎุชูู.",
    "ูุฏูุฑ ุงูุญุณุงุจุงุช": "ุงูุฃุณุชุงุฐ ูุญูุฏ ุงูุดูุงุน ูุฏูุฑ ุงูุญุณุงุจุงุชุ ุฑูู ุงูุชูุงุตู: 01204464066",
    "ุชูุฑูุฏ ููููุงุฏู ูุงููุทุงุนู": "ุงูุฃุณุชุงุฐ ุจูุงู ูุณุคูู ุงูุชูุฑูุฏุ ุฑูู ุงูุชูุงุตู: 01221093951",
    "ุงููุฑู ุจูู ุงูุณูููู ุงููุงูููู ูุงูููุณ ุงูุงุณูุฏ": "ุงูุงุฎุชูุงู ูู ููู ุงููุญู ุจุณุจุจ ุทุฑููุฉ ุงูุชุฏุฎูู ูุงูุชูููุญ ูุงูุทูู ูุฏู ุจูุฃุซุฑ ุนูู ุงูุทุนู.",
    "ุงูุชููุฉ ูุณุชูุฑุฏุฉ ููุง ูุตุฑู": "ุงููุงูุฒ ูุณุชูุฑุฏ ููู ุงูุชููุฉ ููุณูุง ูุตุฑูุฉ ููุชู ุตูุฏูุง ูู ุงูุจุญุฑ ุงูุฃุจูุถ ุงููุชูุณุท.",
    "ููู ุงูููุชุฌุงุช ุบุงููุฉ": "ูุฃููุง ุจูุถูู ุฌูุฏุฉ ุนุงููุฉ ูุทุฑููุฉ ุชูููุญ ูุชุฏุฎูู ูุฎุชููุฉ.",
    "ูุนูู ุงูู ูุงูููู": "ูุบูู ูู ุนุจูุงุช ููุฑุบุฉ ุงูููุงุก.",
    "ููุน ุงูุชููุฉ": "ุชููุฉ ูููููู.",
    "ุจุชุตุทุงุฏูุง ุงูุชููุฉ ูููู": "ูู ูุตุฑ ูู ุงูุจุญุฑ ุงูุฃุจูุถ ุงููุชูุณุท.",
    "ุงูุชููุฉ ุฒูุช ููุง ููุงู": "ูู ุงูุชููุฉ ูุนุจุฃุฉ ูู ุฒูุช ูุจุงุชู ููุท.",
    "ูู ูู ููุงุฏ ุญุงูุธุฉ": "ูู ููุชุฌุงุชูุง ุจุฏูู ููุงุฏ ุญุงูุธุฉ.",
    "ูู ูููู ุงุณุฎู ุงูุฑูุฌุฉ": "ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ูุง ูููู ุชุณุฎูููุง ุฃู ุทูููุงุ ูู ุฌุงูุฒุฉ ููุฃูู.",
    "ุชูุงุจู ุงููุงูุฑูู ุงูููููู": "ูููู ุฃุณูุฏ ููููู ุฃุจูุถ.",
    "ุจุทุงุฑุฎ ุงูุจูุฑู ุจุงูุฒุจุฏุฉ": "ุจุชููู ุจุทุงุฑุฎ ุจูุถุงุก ูุดู.",
    "ุงููุงุน ุจุทุงุฑุฎ ุงูุฑูุฌุฉ": "ููุน ูุฑููุฉ ููุฑูุณุฉ ูููุน ูุฑููุฉ ูุงููุฉ.",
    "ูู ุงูุชููุฉ ุงููุทููุฉ ุฌุงูุฒุฉ ููุงูู": "ุงูุชููุฉ ุงููุทููุฉ ุฌุงูุฒุฉ ููุฃูู ุจุฏูู ุฒูุช ุฃู ููุงู ููุญููุธุฉ ูุงูููู ูุจุฃูุฒุงู ูุฎุชููุฉ.",
    "ูู ูู ุณูู ูุฌูุฏ ุจุฏูู ุชุตููุน": "ูุง ููุฌุฏ ุณูู ูุฌูุฏ ุจุฏูู ุชุตููุน ูู ุงููุตูุน.",
    "ููุน ุงูุณูููู ููุทูู": "ุงูุณูููู ุงูููููู ุงููู."
}

PRODUCT_MAP = {
    "Smoked Herring": "๐ฐ ุณุนุฑ ุฑูุฌุฉ ูุฏุฎูุฉ: 1 KG ุจู 200 EGP โจ",
    "Salted Mullet without Bacteria": "๐ฐ ุณุนุฑ ูุณูุฎ ุจุฏูู ุจูุชูุฑูุง: 1 KG ุจู 460 EGP โจ",
    "Salted Mullet with Roe": "๐ฐ ุณุนุฑ ูุณูุฎ ูุจุทุฑุฎ: 1 KG ุจู 560 EGP โจ",
    # ... ุจุงูู ุงูููุชุฌุงุช ูู ุงูููุฏ ุงูุงุตูู ูุฎุฒูุฉ ุฏุงุฎููุงู ...
}

# ================== AI LOGIC (Groq) ==================
def get_ai_answer(user_text):
    # ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูููุชุงุญ ูู ุงูุณูุฑูุฑ
    api_key = os.environ.get("GROQ_API_KEY")
    if not api_key: 
        return None
        
    try:
        url = "https://api.groq.com/openai/v1/chat/completions"
        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }
        payload = {
            "model": "llama-3.1-70b-versatile",
            "messages": [
                {
                    "role": "system", 
                    "content": f"ุฃูุช ุฎุฏูุฉ ุนููุงุก ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ุจูุฑุณุนูุฏ. ุงููุนูููุงุช ุงููุชุงุญุฉ ูู: {list(FAQ_MAP.values())}. ุฑุฏ ุจููุฌุฉ ูุตุฑูุฉ ุจูุฑุณุนูุฏูุฉ ุฎูููุฉุ ูู ูุฏูุฏุงู ุฌุฏุงู ููุฑุญุงู ูุดุฌุน ุงูุนููู ุนูู ุงูุทูุจ."
                },
                {"role": "user", "content": user_text}
            ],
            "temperature": 0.7
        }
        response = requests.post(url, json=payload, timeout=10)
        res_data = response.json()
        return res_data['choices'][0]['message']['content']
    except Exception as e:
        print(f"Error in Groq: {e}")
        return None

# ================== MAIN LOGIC ==================
def normalize(text):
    return (
        text.lower()
        .replace("ุฉ", "ู")
        .replace("ุฃ", "ุง")
        .replace("ุฅ", "ุง")
        .replace("ุข", "ุง")
        .strip()
    )

def get_answer(text):
    q = normalize(text)
    
    # 1. ุงูุดูุงูู ุงูุญุณุงุณุฉ (ุฃููููุฉ ูุตูู ูุฏููุงู)
    if any(w in q for w in ["ุฏูุฏ", "ูุฏูุฏ", "ุทููููุงุช"]):
        return FAQ_MAP["ุงูุฑูุฌุฉ ูููุง ุฏูุฏ"]

    # 2. ุงููููุงุช ุงููู ุชุฏู ุนูู ุฏุฑุฏุดุฉ ุฃู ุทูุจ ุฑุฃู ุฃู ุทุฑููุฉ (ุชุฑูุญ ููู AI ููุฑุงู)
    chat_keywords = ["ุงุฒุงู", "ุทุฑููุฉ", "ุงุนูู", "ูุตูุฉ", "ุฑุงูู", "ููู", "ูุฑู", "ุงูููุง", "ุงุญูู", "ุงูุถู", "ุงูู ุงูู"]
    if any(w in q for w in chat_keywords):
        ai_reply = get_ai_answer(text)
        if ai_reply:
            return ai_reply

    # 3. ุงูุฃุณุฆูุฉ ุงููู ุฅุฌุงุจุชูุง ูุชุทุงุจูุฉ ุชูุงูุงู ูู ุงูู FAQ_MAP
    for key in FAQ_MAP.keys():
        if normalize(key) == q:
            return FAQ_MAP[key]

    # 4. ุฑุฏูุฏ ุงูุฃุณุนุงุฑ ุงููุฏููุฉ (ูู ูููุงุด ุฏุฑุฏุดุฉ)
    if "ูุณูุฎ" in q:
        return (
            f"๐ฐ ุฃุณุนุงุฑ ุงููุณูุฎ ูุงูุจูุฑู:\n"
            f"- {PRODUCT_MAP.get('Salted Mullet without Bacteria', '460 EGP')}\n"
            f"- {PRODUCT_MAP.get('Salted Mullet with Roe', '560 EGP')}\n"
            f"ุชุญุจ ุชุนุฑู ุชูุงุตูู ุฃูุชุฑ ุนู ุงูุฃุญุฌุงูุ"
        )
    
    if "ุฑูุฌ" in q:
        return (
            f"๐ฐ ุชุดูููุฉ ุงูุฑูุฌุฉ ุงููุชุงุญุฉ:\n"
            f"- {PRODUCT_MAP.get('Smoked Herring', '200 EGP')}\n"
            f"ุฏู ูููู ุงููููู ุงููุงูู ููุฃุณุนุงุฑ: {FAQ_MAP['ูููู']}"
        )

    # 5. ุงูููุงุฐ ุงูุฃุฎูุฑ: ุงุชุฑู ุงูู AI ูุญุงูู ููู ุฃู ุดูุก ุขุฎุฑ
    ai_reply = get_ai_answer(text)
    if ai_reply:
        return ai_reply

    return "ูุง ูุณุงุก ุงููุฑุฏ! ููุฑุช ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ๐ ุฃุคูุฑูู ูุง ุบุงูู ุญุงุจุจ ุชุนุฑู ุงูุฃุณุนุงุฑ ููุง ุงูููููุ"

# ================== WEBHOOK & SERVER ==================
@app.route("/webhook", methods=["GET"])
def verify():
    if request.args.get("hub.verify_token") == VERIFY_TOKEN:
        return request.args.get("hub.challenge"), 200
    return "failed", 403

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()
    if data.get("object") == "page":
        for entry in data.get("entry", []):
            for ev in entry.get("messaging", []):
                sender = ev["sender"]["id"]
                if "message" in ev and "text" in ev["message"]:
                    msg_text = ev["message"]["text"]
                    reply = get_answer(msg_text)
                    send_message(sender, reply)
    return "ok", 200

def send_message(user_id, text):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    payload = {"recipient": {"id": user_id}, "message": {"text": text}}
    try:
        requests.post(url, json=payload, timeout=10)
    except:
        pass

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port)
