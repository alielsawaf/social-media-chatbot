from flask import Flask, request, jsonify
from fuzzywuzzy import fuzz

# --------------------------------------------------------------------------------
# ╪╣┘Д╪з┘Е╪й ╪к╪г┘Г┘К╪п ┘В╪▒╪з╪б╪й ╪з┘Д┘Г┘И╪п ╪з┘Д╪м╪п┘К╪п
print(">>> CODE VERSION 3.1: PRICING ONLY LOADED <<<")
# --------------------------------------------------------------------------------

app = Flask(__name__)
# --------------------------------------------------------------------------------
# ┘В╪з╪╣╪п╪й ╪и┘К╪з┘Ж╪з╪к ╪з┘Д╪г╪│╪ж┘Д╪й ┘И╪з┘Д╪г╪м┘И╪и╪й (FAQ Knowledge Base)
# --------------------------------------------------------------------------------

FAQ = [
┬а ┬а {
┬а ┬а ┬а ┬а 'questions': [
┬а ┬а ┬а ┬а ┬а ┬а '╪з┘Д╪г╪│╪╣╪з╪▒ ╪║╪з┘Д┘К╪й', '┘Е┘Ж╪к╪м╪з╪к┘Г┘Е ╪│╪╣╪▒┘З╪з ╪╣╪з┘Д┘К', '┘Д┘К┘З ╪и╪к╪и┘К╪╣┘И╪з ╪г╪║┘Д┘Й ┘Е┘Ж ╪║┘К╪▒┘Г┘Е╪Я',
┬а ┬а ┬а ┬а ┬а ┬а '╪з┘Д╪│╪╣╪▒ ┘Е╪и╪з┘Д╪║ ┘Б┘К┘З ╪┤┘И┘К╪й', '╪з┘Д╪г╪│╪╣╪з╪▒ ┘Ж╪з╪▒', '┘Е╪з ┘З┘И ╪│╪и╪и ╪з╪▒╪к┘Б╪з╪╣ ╪г╪│╪╣╪з╪▒ ┘Е┘Ж╪к╪м╪з╪к┘Г┘Е╪Я',
┬а ┬а ┬а ┬а ┬а ┬а '┘Д┘К┘З ╪з┘Д┘Е┘Ж╪к╪м╪з╪к ╪и╪к╪з╪╣╪к┘Г┘И╪з ╪║╪з┘Д┘К╪й╪Я', '╪з╪│╪╣╪з╪▒┘Г┘Е ╪║╪з┘Д┘К┘З ╪м╪п╪з',
┬а ┬а ┬а ┬а ┬а ┬а '╪г╪│╪╣╪з╪▒┘Г┘Е ╪г╪╣┘Д┘Й ┘Е┘Ж ╪з┘Д┘Е┘Ж╪з┘Б╪│┘К┘Ж ╪и┘Г╪к┘К╪▒╪М ╪е┘К┘З ╪з┘Д╪│╪и╪и╪Я',
┬а ┬а ┬а ┬а ┬а ┬а '┘З┘Д ┘К┘Е┘Г┘Ж ╪┤╪▒╪н ╪│╪и╪и ╪з┘Д┘Б╪з╪▒┘В ┘Б┘К ╪з┘Д╪г╪│╪╣╪з╪▒ ╪╣┘Ж ╪и╪з┘В┘К ╪з┘Д╪┤╪▒┘Г╪з╪к╪Я',
┬а ┬а ┬а ┬а ┬а ┬а '╪з┘Д┘Б┘Д┘И╪│ ╪з┘Д┘Г╪к┘К╪▒ ╪п┘К ┘Е┘В╪з╪и┘Д ╪е┘К┘З ┘Б┘К ╪з┘Д╪м┘И╪п╪й╪Я',
┬а ┬а ┬а ┬а ┬а ┬а '┘Е╪з ┘З┘К ╪з┘Д┘В┘К┘Е╪й ╪з┘Д┘Е╪╢╪з┘Б╪й ╪з┘Д╪к┘К ╪к╪и╪▒╪▒ ┘З╪░╪з ╪з┘Д╪│╪╣╪▒ ╪з┘Д┘Е╪▒╪к┘Б╪╣╪Я',
┬а ┬а ┬а ┬а ┬а ┬а '┘З┘Д ┘Е┘Ж╪к╪м╪з╪к┘Г┘Е ╪к╪│╪к╪з┘З┘Д ╪з┘Д╪│╪╣╪▒ ╪п┘З╪Я', '╪│╪╣╪▒┘Г┘Е ┘Б┘К ╪з┘Д┘Е┘Ж╪к╪м ╪п┘З ┘Е╪и╪з┘Д╪║ ┘Б┘К┘З ╪г┘И┘К',
┬а ┬а ┬а ┬а ┬а ┬а '╪з┘Д╪з╪│╪╣╪з╪▒ ┘Е╪и╪з┘Д╪║ ┘Б┘К┘З╪з', '┘З┘К ╪з┘Д╪з╪│╪╣╪з╪▒ ╪п┘К ╪и╪м╪п', '╪и╪м╪п ╪з┘Д┘Е┘Ж╪к╪м ╪п┘З ╪│╪╣╪▒┘З ┘Г╪п┘З╪Я',
┬а ┬а ┬а ┬а ┬а ┬а '╪з┘Д╪│╪╣╪▒ ╪п┘З ┘Е╪┤ ┘Г╪к┘К╪▒ ╪н╪и╪к┘К┘Ж╪Я', '╪и╪╡╪▒╪з╪н╪й╪М ╪┤╪з┘К┘Б┘К┘Ж ╪е┘Ж ╪│╪╣╪▒┘Г┘Е ╪╣╪з┘Д┘К ╪┤┘И┘К╪й',
┬а ┬а ┬а ┬а ┬а ┬а '╪е┘К┘З ╪з┘Д╪н┘Г╪з┘К╪й ┘Б┘К ╪з┘Д╪г╪│╪╣╪з╪▒ ╪п┘К╪Я', '┘Д┘Е╪з╪░╪з ╪к╪и╪п┘И ╪г╪│╪╣╪з╪▒┘Г┘Е ╪║┘К╪▒ ╪к┘Ж╪з┘Б╪│┘К╪й╪Я',
┬а ┬а ┬а ┬а ┬а ┬а '┘Д┘К┘З ╪п╪з┘К┘Е╪з┘Л ┘Б┘К ╪▓┘К╪з╪п╪й ╪г╪│╪╣╪з╪▒╪Я', '┘Д┘К┘З ╪з┘Д╪▒┘Ж╪м╪й ╪и╪к╪з╪к┘Г┘Е ╪║╪з┘Д┘К┘З',
┬а ┬а ┬а ┬а ┬а ┬а 'Lih el as3ar de', 'Are these prices final', 'I think your prices are inflated',
┬а ┬а ┬а ┬а ┬а ┬а 'Why is this product so costly', "What's the reason for the high cost",
┬а ┬а ┬а ┬а ┬а ┬а 'Msh 3aref eh sabab en el as3ar keda', 'As3arko 3alya leih',
┬а ┬а ┬а ┬а ┬а ┬а 'Leh el montagat bta3tko ghalya'
┬а ┬а ┬а ┬а ],
┬а ┬а ┬а ┬а 'answer': (
┬а ┬а ┬а ┬а ┬а ┬а "╪з┘З┘Д╪з ╪и╪н╪╢╪▒╪к┘Г ╪│╪╣╪п╪з╪б ╪и╪к┘И╪з╪╡┘Д┘Г ┘Е╪╣┘Ж╪з ┘И╪м╪з┘З╪▓┘К┘Ж ╪п╪з┘К┘Е╪з ┘Д┘Д╪▒╪п ╪╣┘Д┘К ╪з╪│╪к┘Б╪│╪з╪▒╪з╪к┘Г ╪з╪н┘Ж╪з ╪з╪│╪╣╪з╪▒┘Ж╪з ╪║╪з┘Д┘К┘З ┘Д╪з╪з┘Ж┘Ж╪з ╪и┘Ж╪╢┘Е┘Ж┘Д┘Г ╪м┘И╪п╪й ┘Е┘Ж╪к╪м ┘К╪з ┘Б┘Ж╪п┘Е ╪н┘К╪л ╪з┘Ж ╪╖╪▒┘К┘В╪й ╪з┘Д╪к┘Е┘Д┘К╪н ┘И ╪з┘Д╪к╪п╪о┘К┘Ж ┘Е╪о╪к┘Д┘Б╪й. "
┬а ┬а ┬а ┬а ┬а ┬а "╪з╪н┘Ж╪з ╪и┘Ж┘Е┘Д╪н ╪│┘Е┘Г ╪з┘Д╪▒┘Ж╪м╪й ╪и┘Е╪н┘Д┘И┘Д ╪и╪▒╪з┘К┘Ж ┘И ╪и┘К╪к┘Е ╪к╪п╪о┘К┘Ж ╪з┘Д╪│┘Е┘Г ╪╣┘Д┘К ╪з┘Д╪и╪з╪▒╪п ╪и┘Ж╪┤╪з╪▒╪й ╪г┘Д┘Е╪з┘Ж┘К╪М "
┬а ┬а ┬а ┬а ┬а ┬а "╪╣╪┤╪з┘Ж ┘Ж╪╢┘Е┘Ж ┘Д╪н╪╢╪▒╪к┘Г ┘Е┘Ж╪к╪м ╪╡╪н┘К ┘Е╪п╪о┘Ж ╪и╪┤┘Г┘Д ╪╡╪н┘К╪н ╪м╪з┘З╪▓ ╪╣┘Д┘К ╪з┘Д╪г┘Г┘Д."
┬а ┬а ┬а ┬а )
┬а ┬а }
]

# --------------------------------------------------------------------------------
# ╪з┘Д╪п╪з┘Д╪й ╪з┘Д╪▒╪ж┘К╪│┘К╪й ┘Д┘Д╪и╪н╪л ┘И╪з┘Д┘Е┘В╪з╪▒┘Ж╪й (╪и╪з╪│╪к╪о╪п╪з┘Е FuzzyWuzzy)
# --------------------------------------------------------------------------------

def get_answer(user_question):
┬а ┬а """
┬а ┬а ┘К╪и╪н╪л ╪╣┘Ж ╪з┘Д╪е╪м╪з╪и╪й ╪з┘Д╪г┘В╪▒╪и ┘Д╪│╪д╪з┘Д ╪з┘Д┘Е╪│╪к╪о╪п┘Е ┘Б┘К ┘В╪з╪╣╪п╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к FAQ.
┬а ┬а :param user_question: ╪│╪д╪з┘Д ╪з┘Д╪╣┘Е┘К┘Д.
┬а ┬а :return: ╪з┘Д╪е╪м╪з╪и╪й ╪з┘Д┘Е╪╖╪з╪и┘В╪й ╪г┘И ╪▒╪│╪з┘Д╪й ╪╣╪п┘Е ┘И╪м┘И╪п ╪к╪╖╪з╪и┘В.
┬а ┬а """
┬а ┬а best_match_score = 0
┬а ┬а best_answer = None

┬а ┬а # ╪к╪╖╪и┘К╪╣ ┘И╪к╪н╪╢┘К╪▒ ╪│╪д╪з┘Д ╪з┘Д┘Е╪│╪к╪о╪п┘Е ┘Д┘Д╪и╪н╪л
┬а ┬а normalized_query = user_question.strip().lower()

┬а ┬а for item in FAQ:
┬а ┬а ┬а ┬а for question_phrase in item['questions']:
┬а ┬а ┬а ┬а ┬а ┬а # ┘Ж╪н╪│╪и ╪п╪▒╪м╪й ╪з┘Д╪к╪┤╪з╪и┘З ╪и╪з╪│╪к╪о╪п╪з┘Е fuzzywuzzy.ratio
┬а ┬а ┬а ┬а ┬а ┬а score = fuzz.ratio(normalized_query, question_phrase.lower())
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а # ╪е╪░╪з ┘Г╪з┘Ж╪к ╪п╪▒╪м╪й ╪з┘Д╪к╪┤╪з╪и┘З ╪г╪╣┘Д┘Й ┘Е┘Ж ╪г┘Б╪╢┘Д ╪п╪▒╪м╪й ╪│╪з╪и┘В╪й╪М ┘Ж┘В┘И┘Е ╪и╪к╪н╪п┘К╪л┘З╪з
┬а ┬а ┬а ┬а ┬а ┬а if score > best_match_score:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а best_match_score = score
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а best_answer = item['answer']
┬а ┬а┬а
┬а ┬а # ╪к╪н╪п┘К╪п ╪з┘Д╪н╪п ╪з┘Д╪г╪п┘Ж┘Й ┘Д╪п╪▒╪м╪й ╪з┘Д╪к╪┤╪з╪и┘З ╪з┘Д┘Е┘В╪и┘И┘Д╪й
┬а ┬а MATCH_THRESHOLD = 75┬а

┬а ┬а if best_match_score >= MATCH_THRESHOLD:
┬а ┬а ┬а ┬а return {
┬а ┬а ┬а ┬а ┬а ┬а 'answer': best_answer,
┬а ┬а ┬а ┬а ┬а ┬а 'confidence_score': best_match_score
┬а ┬а ┬а ┬а }
┬а ┬а else:
┬а ┬а ┬а ┬а # ╪▒╪│╪з┘Д╪й ╪з┘Д╪▒╪п ┘Б┘К ╪н╪з┘Д╪й ╪╣╪п┘Е ┘И╪м┘И╪п ╪к╪╖╪з╪и┘В ┘В┘И┘К
┬а ┬а ┬а ┬а return {
┬а ┬а ┬а ┬а ┬а ┬а 'answer': (
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а "╪г┘З┘Д╪з ╪и╪н╪╢╪▒┘Г. "
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а "┘Д┘В╪п ╪к┘Е ╪з╪▒╪│╪з┘Д ╪з╪│╪к┘Б╪│╪з╪▒┘Г ┘Д╪г╪н╪п ┘Е┘Е╪л┘Д┘К ╪о╪п┘Е╪й ╪з┘Д╪╣┘Е┘Д╪з╪б ┘И╪│┘И┘Б ┘К╪к┘Е ╪з┘Д╪к┘И╪з╪╡┘Д ┘Е╪╣┘Г┘Е."
┬а ┬а ┬а ┬а ┬а ┬а ),
┬а ┬а ┬а ┬а ┬а ┬а 'confidence_score': best_match_score
┬а ┬а ┬а ┬а }

# --------------------------------------------------------------------------------
# ЁЯЪи ╪з┘Д┘Е╪│╪з╪▒ ╪з┘Д╪м╪п┘К╪п ┘Д┘Д╪к╪н┘В┘В ┘Е┘Ж Webhook (┘К╪│╪к┘В╪и┘Д GET)
# --------------------------------------------------------------------------------
@app.route('/webhook', methods=['GET'])
def webhook_verification():
    # тЪая╕П ┘К╪м╪и ╪к╪║┘К┘К╪▒ ┘З╪░╪з ╪з┘Д╪к┘И┘Г┘Ж ┘Д┘К╪к╪╖╪з╪и┘В ┘Е╪╣ ╪з┘Д╪к┘И┘Г┘Ж ╪з┘Д╪░┘К ┘И╪╢╪╣╪к┘З ┘Б┘К ┘Е┘Ж╪╡╪й ╪з┘Д┘Е╪▒╪з╪│┘Д╪й тЪая╕П
    VERIFY_TOKEN = "161019" 
    
    # ╪з╪│╪к╪о╪▒╪з╪м ╪з┘Д╪и╪з╪▒╪з┘Е╪к╪▒╪з╪к ┘Е┘Ж ╪╖┘Д╪и GET
    mode = request.args.get("hub.mode")
    token = request.args.get("hub.verify_token")
    challenge = request.args.get("hub.challenge")
    
    # ╪з┘Д╪к╪н┘В┘В ┘Е┘Ж ╪з┘Д╪и╪з╪▒╪з┘Е╪к╪▒╪з╪к
    if mode and token:
        if mode == "subscribe" and token == VERIFY_TOKEN:
            # ┘Ж╪м╪з╪н ╪з┘Д╪к╪н┘В┘В: ╪з┘Д╪▒╪п ╪и┘В┘К┘Е╪й challenge
            print("Webhook Verified Successfully!")
            return challenge, 200
        else:
            # ┘Б╪┤┘Д ╪з┘Д╪к╪н┘В┘В
            return jsonify({'error': 'Verification token mismatch'}), 403
    
    return jsonify({'error': 'Missing verification parameters'}), 400


# --------------------------------------------------------------------------------
# ЁЯЪи ╪з┘Д┘Е╪│╪з╪▒ ╪з┘Д╪м╪п┘К╪п ┘Д╪к┘Д┘В┘К ╪з┘Д╪▒╪│╪з╪ж┘Д ╪з┘Д┘И╪з╪▒╪п╪й (┘К╪│╪к┘В╪и┘Д POST)
# --------------------------------------------------------------------------------
@app.route('/webhook', methods=['POST'])
def webhook_inbound():
    data = request.get_json()
    
    # ┘З┘Ж╪з ┘К╪м╪и ╪г┘Ж ╪к╪│╪к╪о┘Д╪╡ ╪▒╪│╪з┘Д╪й ╪з┘Д╪╣┘Е┘К┘Д ┘Е┘Ж ╪з┘Д┘А data ╪з┘Д┘Е╪▒╪│┘Д╪й ┘Е┘Ж ┘Е┘Ж╪╡╪й ╪з┘Д┘Е╪▒╪з╪│┘Д╪й
    # ╪и┘Е╪з ╪г┘Ж┘Ж╪з ┘Д╪з ┘Ж╪╣╪▒┘Б ╪┤┘Г┘Д ╪з┘Д┘А JSON ╪и╪з┘Д╪к╪н╪п┘К╪п╪М ╪│┘Ж┘Г╪к┘Б┘К ╪и╪з┘Д╪▒╪п ╪и╪▒╪│╪з┘Д╪й ╪з┘Д┘Ж╪м╪з╪н ┘Б┘В╪╖ ┘Д╪к╪м┘Ж╪и ╪к╪╣┘Д┘К┘В ╪з┘Д┘И┘К╪и ┘З┘И┘Г.
    
    # ┘К┘Е┘Г┘Ж┘Г ┘И╪╢╪╣ ╪з┘Д┘Г┘И╪п ╪з┘Д╪о╪з╪╡ ╪и┘А get_answer ┘З┘Ж╪з ┘Д╪з╪н┘В╪з┘Л ╪╣┘Ж╪п┘Е╪з ╪к╪╣╪▒┘Б ╪┤┘Г┘Д ╪з┘Д╪и┘К╪з┘Ж╪з╪к:
    # user_message = ╪з╪│╪к╪о┘Д╪з╪╡_╪з┘Д╪▒╪│╪з┘Д╪й(data) 
    # result = get_answer(user_message)
    # ╪▒╪п_╪╣┘Д┘Й_┘Е┘Ж╪╡╪й_╪з┘Д┘Е╪▒╪з╪│┘Д╪й(result['answer'])

    # ╪з┘Д╪▒╪п ┘К╪м╪и ╪г┘Ж ┘К┘Г┘И┘Ж ╪п╪з╪ж┘Е╪з┘Л 200 OK ┘Д┘Е┘Ж╪╡╪й ╪з┘Д┘Е╪▒╪з╪│┘Д╪й ╪н╪к┘Й ┘Д╪з ┘К╪к┘Е ╪е┘К┘В╪з┘Б ╪з┘Д┘А webhook
    return "EVENT_RECEIVED", 200 

# --------------------------------------------------------------------------------
# ┘Е╪│╪з╪▒ /ask ╪з┘Д┘В╪п┘К┘Е ┘Д┘Д╪з╪о╪к╪и╪з╪▒ ╪з┘Д┘К╪п┘И┘К (┘К┘Е┘Г┘Ж ╪к╪▒┘Г┘З ╪г┘И ╪н╪░┘Б┘З)
# --------------------------------------------------------------------------------
@app.route('/ask', methods=['POST'])
def ask_chatbot_manual():
    data = request.get_json()
    user_query = data.get('question', '')
    
    if not user_query:
        return jsonify({'error': '╪з┘Д╪▒╪м╪з╪б ╪е╪▒╪│╪з┘Д ╪з┘Д╪│╪д╪з┘Д ┘Б┘К ╪н┘В┘Д "question"'}), 400

    result = get_answer(user_query)
    
    return jsonify(result)

# --------------------------------------------------------------------------------
# ╪к╪┤╪║┘К┘Д ╪з┘Д╪к╪╖╪и┘К┘В
# --------------------------------------------------------------------------------

if __name__ == '__main__':
    # ┘Д╪к╪┤╪║┘К┘Д ╪з┘Д╪к╪╖╪и┘К┘В ╪╣┘Д┘Й localhost:5000 
    app.run(debug=True)

