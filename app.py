from flask import Flask, request, jsonify
from fuzzywuzzy import fuzz

# --------------------------------------------------------------------------------
# ╪╣┘Д╪з┘Е╪й ╪к╪г┘Г┘К╪п ┘В╪▒╪з╪б╪й ╪з┘Д┘Г┘И╪п ╪з┘Д╪м╪п┘К╪п
print(">>> CODE VERSION 3.2: SYNTAX CLEANED AND PRICING ONLY LOADED <<<")
# --------------------------------------------------------------------------------

app = Flask(__name__)

# --------------------------------------------------------------------------------
# ┘В╪з╪╣╪п╪й ╪и┘К╪з┘Ж╪з╪к ╪з┘Д╪г╪│╪ж┘Д╪й ┘И╪з┘Д╪г╪м┘И╪и╪й (FAQ Knowledge Base)
# --------------------------------------------------------------------------------

# тЪая╕П ╪к┘Е ╪к╪╡╪н┘К╪н ╪з┘Д┘Е╪│╪з┘Б╪з╪к ┘И╪з┘Д╪н╪▒┘И┘Б ┘Б┘К ┘З╪░╪з ╪з┘Д╪м╪▓╪б ┘Д╪к╪м┘Ж╪и ╪о╪╖╪г ╪з┘Д╪│╪╖╪▒ 15
FAQ = [
    {
        'questions': [
            '╪з┘Д╪г╪│╪╣╪з╪▒ ╪║╪з┘Д┘К╪й', '┘Е┘Ж╪к╪м╪з╪к┘Г┘Е ╪│╪╣╪▒┘З╪з ╪╣╪з┘Д┘К', '┘Д┘К┘З ╪и╪к╪и┘К╪╣┘И╪з ╪г╪║┘Д┘Й ┘Е┘Ж ╪║┘К╪▒┘Г┘Е╪Я',
            '╪з┘Д╪│╪╣╪▒ ┘Е╪и╪з┘Д╪║ ┘Б┘К┘З ╪┤┘И┘К╪й', '╪з┘Д╪г╪│╪╣╪з╪▒ ┘Ж╪з╪▒', '┘Е╪з ┘З┘И ╪│╪и╪и ╪з╪▒╪к┘Б╪з╪╣ ╪г╪│╪╣╪з╪▒ ┘Е┘Ж╪к╪м╪з╪к┘Г┘Е╪Я',
            '┘Д┘К┘З ╪з┘Д┘Е┘Ж╪к╪м╪з╪к ╪и╪к╪з╪╣╪к┘Г┘И╪з ╪║╪з┘Д┘К╪й╪Я', '╪з╪│╪╣╪з╪▒┘Г┘Е ╪║╪з┘Д┘К┘З ╪м╪п╪з',
            '╪г╪│╪╣╪з╪▒┘Г┘Е ╪г╪╣┘Д┘Й ┘Е┘Ж ╪з┘Д┘Е┘Ж╪з┘Б╪│┘К┘Ж ╪и┘Г╪к┘К╪▒╪М ╪е┘К┘З ╪з┘Д╪│╪и╪и╪Я',
            '┘З┘Д ┘К┘Е┘Г┘Ж ╪┤╪▒╪н ╪│╪и╪и ╪з┘Д┘Б╪з╪▒┘В ┘Б┘К ╪з┘Д╪г╪│╪╣╪з╪▒ ╪╣┘Ж ╪и╪з┘В┘К ╪з┘Д╪┤╪▒┘Г╪з╪к╪Я',
            '╪з┘Д┘Б┘Д┘И╪│ ╪з┘Д┘Г╪к┘К╪▒ ╪п┘К ┘Е┘В╪з╪и┘Д ╪е┘К┘З ┘Б┘К ╪з┘Д╪м┘И╪п╪й╪Я',
            '┘Е╪з ┘З┘К ╪з┘Д┘В┘К┘Е╪й ╪з┘Д┘Е╪╢╪з┘Б╪й ╪з┘Д╪к┘К ╪к╪и╪▒╪▒ ┘З╪░╪з ╪з┘Д╪│╪╣╪▒ ╪з┘Д┘Е╪▒╪к┘Б╪╣╪Я',
            '┘З┘Д ┘Е┘Ж╪к╪м╪з╪к┘Г┘Е ╪к╪│╪к╪з┘З┘Д ╪з┘Д╪│╪╣╪▒ ╪п┘З╪Я', '╪│╪╣╪▒┘Г┘Е ┘Б┘К ╪з┘Д┘Е┘Ж╪к╪м ╪п┘З ┘Е╪и╪з┘Д╪║ ┘Б┘К┘З ╪г┘И┘К',
            '╪з┘Д╪з╪│╪╣╪з╪▒ ┘Е╪и╪з┘Д╪║ ┘Б┘К┘З╪з', '┘З┘К ╪з┘Д╪з╪│╪╣╪з╪▒ ╪п┘К ╪и╪м╪п', '╪и╪м╪п ╪з┘Д┘Е┘Ж╪к╪м ╪п┘З ╪│╪╣╪▒┘З ┘Г╪п┘З╪Я',
            '╪з┘Д╪│╪╣╪▒ ╪п┘З ┘Е╪┤ ┘Г╪к┘К╪▒ ╪н╪и╪к┘К┘Ж╪Я', '╪и╪╡╪▒╪з╪н╪й╪М ╪┤╪з┘К┘Б┘К┘Ж ╪е┘Ж ╪│╪╣╪▒┘Г┘Е ╪╣╪з┘Д┘К ╪┤┘И┘К╪й',
            '╪е┘К┘З ╪з┘Д╪н┘Г╪з┘К╪й ┘Б┘К ╪з┘Д╪г╪│╪╣╪з╪▒ ╪п┘К╪Я', '┘Д┘Е╪з╪░╪з ╪к╪и╪п┘И ╪г╪│╪╣╪з╪▒┘Г┘Е ╪║┘К╪▒ ╪к┘Ж╪з┘Б╪│┘К╪й╪Я',
            '┘Д┘К┘З ╪п╪з┘К┘Е╪з┘Л ┘Б┘К ╪▓┘К╪з╪п╪й ╪г╪│╪╣╪з╪▒╪Я', '┘Д┘К┘З ╪з┘Д╪▒┘Ж╪м╪й ╪и╪к╪з╪к┘Г┘Е ╪║╪з┘Д┘К┘З',
            'Lih el as3ar de', 'Are these prices final', 'I think your prices are inflated',
            'Why is this product so costly', "What's the reason for the high cost",
            'Msh 3aref eh sabab en el as3ar keda', 'As3arko 3alya leih',
            'Leh el montagat bta3tko ghalya'
        ],
        'answer': (
            "╪з┘З┘Д╪з ╪и╪н╪╢╪▒╪к┘Г ╪│╪╣╪п╪з╪б ╪и╪к┘И╪з╪╡┘Д┘Г ┘Е╪╣┘Ж╪з ┘И╪м╪з┘З╪▓┘К┘Ж ╪п╪з┘К┘Е╪з ┘Д┘Д╪▒╪п ╪╣┘Д┘К ╪з╪│╪к┘Б╪│╪з╪▒╪з╪к┘Г ╪з╪н┘Ж╪з ╪з╪│╪╣╪з╪▒┘Ж╪з ╪║╪з┘Д┘К┘З ┘Д╪з╪з┘Ж┘Ж╪з ╪и┘Ж╪╢┘Е┘Ж┘Д┘Г ╪м┘И╪п╪й ┘Е┘Ж╪к╪м ┘К╪з ┘Б┘Ж╪п┘Е ╪н┘К╪л ╪з┘Ж ╪╖╪▒┘К┘В╪й ╪з┘Д╪к┘Е┘Д┘К╪н ┘И ╪з┘Д╪к╪п╪о┘К┘Ж ┘Е╪о╪к┘Д┘Б╪й. "
            "╪з╪н┘Ж╪з ╪и┘Ж┘Е┘Д╪н ╪│┘Е┘Г ╪з┘Д╪▒┘Ж╪м╪й ╪и┘Е╪н┘Д┘И┘Д ╪и╪▒╪з┘К┘Ж ┘И ╪и┘К╪к┘Е ╪к╪п╪о┘К┘Ж ╪з┘Д╪│┘Е┘Г ╪╣┘Д┘К ╪з┘Д╪и╪з╪▒╪п ╪и┘Ж╪┤╪з╪▒╪й ╪г┘Д┘Е╪з┘Ж┘К╪М "
            "╪╣╪┤╪з┘Ж ┘Ж╪╢┘Е┘Ж ┘Д╪н╪╢╪▒╪к┘Г ┘Е┘Ж╪к╪м ╪╡╪н┘К ┘Е╪п╪о┘Ж ╪и╪┤┘Г┘Д ╪╡╪н┘К╪н ╪м╪з┘З╪▓ ╪╣┘Д┘К ╪з┘Д╪г┘Г┘Д."
        )
    }
]

# --------------------------------------------------------------------------------
# ╪з┘Д╪п╪з┘Д╪й ╪з┘Д╪▒╪ж┘К╪│┘К╪й ┘Д┘Д╪и╪н╪л ┘И╪з┘Д┘Е┘В╪з╪▒┘Ж╪й (╪и╪з╪│╪к╪о╪п╪з┘Е FuzzyWuzzy)
# --------------------------------------------------------------------------------

def get_answer(user_question):
    """
    ┘К╪и╪н╪л ╪╣┘Ж ╪з┘Д╪е╪м╪з╪и╪й ╪з┘Д╪г┘В╪▒╪и ┘Д╪│╪д╪з┘Д ╪з┘Д┘Е╪│╪к╪о╪п┘Е ┘Б┘К ┘В╪з╪╣╪п╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к FAQ.
    """
    best_match_score = 0
    best_answer = None

    normalized_query = user_question.strip().lower()

    for item in FAQ:
        for question_phrase in item['questions']:
            score = fuzz.ratio(normalized_query, question_phrase.lower())
            
            if score > best_match_score:
                best_match_score = score
                best_answer = item['answer']
    
    MATCH_THRESHOLD = 75 

    if best_match_score >= MATCH_THRESHOLD:
        return {
            'answer': best_answer,
            'confidence_score': best_match_score
        }
    else:
        return {
            'answer': (
                "╪г┘З┘Д╪з ╪и╪н╪╢╪▒┘Г. "
                "┘Д┘В╪п ╪к┘Е ╪з╪▒╪│╪з┘Д ╪з╪│╪к┘Б╪│╪з╪▒┘Г ┘Д╪г╪н╪п ┘Е┘Е╪л┘Д┘К ╪о╪п┘Е╪й ╪з┘Д╪╣┘Е┘Д╪з╪б ┘И╪│┘И┘Б ┘К╪к┘Е ╪з┘Д╪к┘И╪з╪╡┘Д ┘Е╪╣┘Г┘Е."
            ),
            'confidence_score': best_match_score
        }

# --------------------------------------------------------------------------------
# ЁЯЪи ┘Е╪│╪з╪▒ Webhook: ┘Д┘Д╪к╪н┘В┘В (GET) ┘И╪к┘Д┘В┘К ╪з┘Д╪▒╪│╪з╪ж┘Д (POST)
# --------------------------------------------------------------------------------
@app.route('/webhook', methods=['GET'])
def webhook_verification():
    # тЪая╕П ┘К╪м╪и ╪з┘Д╪к╪г┘Г╪п ╪г┘Ж ┘З╪░╪з ╪з┘Д╪к┘И┘Г┘Ж ┘К╪к╪╖╪з╪и┘В ┘Е╪╣ ╪з┘Д╪к┘И┘Г┘Ж ┘Б┘К ┘Е┘Ж╪╡╪й Meta
    VERIFY_TOKEN = "161019" 
    
    mode = request.args.get("hub.mode")
    token = request.args.get("hub.verify_token")
    challenge = request.args.get("hub.challenge")
    
    if mode and token:
        if mode == "subscribe" and token == VERIFY_TOKEN:
            print("Webhook Verified Successfully!")
            return challenge, 200
        else:
            return jsonify({'error': 'Verification token mismatch'}), 403
    
    return jsonify({'error': 'Missing verification parameters'}), 400


@app.route('/webhook', methods=['POST'])
def webhook_inbound():
    # ┘З╪░╪з ┘З┘И ╪з┘Д┘Е╪│╪з╪▒ ╪з┘Д╪░┘К ╪│┘К╪к┘Д┘В┘Й ╪▒╪│╪з╪ж┘Д ╪з┘Д┘Е╪│╪к╪о╪п┘Е┘К┘Ж ╪з┘Д┘Б╪╣┘Д┘К╪й
    data = request.get_json()
    
    # ┘К╪м╪и ╪з╪│╪к╪о┘Д╪з╪╡ ╪з┘Д╪▒╪│╪з┘Д╪й ┘Е┘Ж ╪з┘Д┘А JSON ┘З┘Ж╪з ┘Б┘К ┘Е╪▒╪н┘Д╪й ┘Д╪з╪н┘В╪й
    # ╪е╪░╪з ┘Г╪з┘Ж ╪з┘Д╪к╪н┘В┘В ┘Ж╪з╪м╪н┘Л╪з╪М ┘Б╪│┘К╪╡┘Д ┘З┘Ж╪з ╪з┘Д┘А JSON ╪и╪▒╪│╪з╪ж┘Д ╪з┘Д┘Е╪│╪к╪о╪п┘Е
    
    return "EVENT_RECEIVED", 200 

# --------------------------------------------------------------------------------
# ┘Е╪│╪з╪▒ /ask ╪з┘Д┘В╪п┘К┘Е ┘Д┘Д╪з╪о╪к╪и╪з╪▒ ╪з┘Д┘К╪п┘И┘К 
# --------------------------------------------------------------------------------
@app.route('/ask', methods=['POST'])
def ask_chatbot_manual():
    data = request.get_json()
    user_query = data.get('question', '')
    
    if not user_query:
        return jsonify({'error': '╪з┘Д╪▒╪м╪з╪б ╪е╪▒╪│╪з┘Д ╪з┘Д╪│╪д╪з┘Д ┘Б┘К ╪н┘В┘Д "question"'}), 400

    result = get_answer(user_query)
    
    return jsonify(result)

# --------------------------------------------------------------------------------
# ╪к╪┤╪║┘К┘Д ╪з┘Д╪к╪╖╪и┘К┘В
# --------------------------------------------------------------------------------

if __name__ == '__main__':
    # ╪к╪┤╪║┘К┘Д ╪з┘Д╪к╪╖╪и┘К┘В ┘Е╪н┘Д┘К╪з┘Л 
    app.run(debug=True)
