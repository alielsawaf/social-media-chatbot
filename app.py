from flask import Flask, request
from fuzzywuzzy import fuzz
import requests
import re
import os

app = Flask(__name__)

# ================== CONFIG ==================
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
VERIFY_TOKEN = "my_secret_token"

USER_CONTEXT = {} 

# ================== UTILS ==================
def clean(text):
    if not text: return ""
    text = str(text).lower().strip()
    text = text.translate(str.maketrans("ููกูขูฃูคูฅูฆูงูจูฉ", "0123456789"))
    text = re.sub(r"[ุฅุฃุขุง]", "ุง", text)
    text = re.sub(r"ุฉ", "ู", text)
    text = re.sub(r"ู", "ู", text)
    text = re.sub(r"[^\w\s\d]", " ", text)
    return re.sub(r"\s+", " ", text).strip()

# ================== DATA (ุชุฑุชูุจ ุฏููู) ==================
PRODUCTS = [
    # ุงูุฑูุฌุฉ
    {'kw': ['ุฑูุฌู ูุฏุฎูู ูุจุทุฑุฎู ูุฑููู', 'ุฑูุฌู ูุจุทุฑุฎู', 'ุฑูุฌู ูุฑููู'], 'price': '250 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ูุฏุฎูู', 'ุฑูุฌู ุนุงุฏูู'], 'price': '200 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ูุฏุฎูู 24 ููุฑุงุท', 'ุฑูุฌู 24', 'ุฑูุฌู ุนูุงุฑ 24'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู 24 ูุจุทุฑุฎู', 'ุฑูุฌู 24 ูุฑููู'], 'price': '320 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููุฒูุนู ุงูุงุญุดุงุก ูุงูููู', 'ุฑูุฌู ูุงูููู'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููููู ุจุฏูู ุฒูุช', 'ุฑูุฌู ููููู ุณุงุฏู'], 'price': '600 EGP', 'w': '1 KG'},
    {'kw': ['ุฑูุฌู ููููู ุตูุต ูููู ููุงููุงุฑ'], 'price': '150 EGP', 'w': '200 G'},
    {'kw': ['ุฑูุฌู ููููู ูุงุฑู'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุฑูุฌู ููููู ุฒูุช'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุฑูุฌู ููููู ูุฏุฎูู'], 'price': '85 EGP', 'w': '125 G'},
    {'kw': ['ูุงููุงุฑ ุณุจุฑูุฏ', 'ุฑูุฌู ูุงููุงุฑ ุณุจุฑูุฏ'], 'price': '70 EGP', 'w': '200 G/130 G'},
    {'kw': ['ุจุทุงุฑุฎ ุฑูุฌู ุฒูุช ูุงููุฉ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ุจุทุงุฑุฎ ุฑูุฌู ุจุฑุชูุงู', 'ุจุทุงุฑุฎ ููุฑูุณู'], 'price': '250 EGP', 'w': '250 G'},
    # ุงููุงูุฑูู
    {'kw': ['ูุงูุฑูู ูุฏุฎู ูููุญ', 'ูุงูุฑูู'], 'price': '410 EGP', 'w': '1 KG'},
    {'kw': ['ูุงูุฑูู ูุงูููู'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ูุงูุฑูู ููููู'], 'price': '800 EGP', 'w': '1 KG'},
    # ุงููุณูุฎ
    {'kw': ['ูุณูุฎ ููููู ุฒูุช', 'ูุณูุฎ ุฒูุช'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ููููู ุฏุฎุงู', 'ูุณูุฎ ูุฏุฎู'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ุณุจุฑูุฏ ุจูุฌุฑ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ูุณูุฎ ุจุฏูู ุจูุชูุฑูุง', 'ูุณูุฎ ุทุจู'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ูุณูุฎ ูุจุทุฑุฎ'], 'price': '560 EGP', 'w': '1 KG'},
    {'kw': ['ุดุฑุงุฆุญ ุจูุฑู ูุฏุฎูู', 'ููููู ุจูุฑู ูุฏุฎู'], 'price': '810 EGP', 'w': '1 KG'},
    # ุงูุณูููู
    {'kw': ['ุณูููู ุญุงุฑ', 'spicy salmon'], 'price': '150 EGP', 'w': '125 G'},
    {'kw': ['ุดุฑุงุฆุญ ุณูููู ูุฏุฎูู', 'ุณูููู ููููู'], 'price': '3000 EGP', 'w': '1 KG'},
    {'kw': ['ุณุชูู ุณูููู'], 'price': '1810 EGP', 'w': '1 KG'},
    {'kw': ['ุดูุฑุจู ุณูููู'], 'price': '90 EGP', 'w': '160 G'},
    # ุงูุจุทุงุฑุฎ ูุงูุชููุฉ
    {'kw': ['ุจุทุงุฑุฎ ุจูุฑู ูููุญู', 'ุจุทุงุฑุฎ ุจูุฑู'], 'price': '2850 EGP', 'w': '1 KG'},
    {'kw': ['ุชููู ุญูุฑุงุก ููููู', 'ุชููู ุญูุฑุง'], 'price': '155 EGP', 'w': '230 G'},
    {'kw': ['ุชููู ูุทุน', ' chunks tuna'], 'price': '70 EGP', 'w': '125 G'},
    {'kw': ['ุชููู ูุทููู'], 'price': '710 EGP', 'w': '1 KG'},
    # ุฃุฎุฑู
    {'kw': ['ุงูุดูุฌู ููููู ุฒูุช', 'ุงูุดูุฌู'], 'price': '110 EGP', 'w': '125 G'},
    {'kw': ['ุณุฑุฏูู ูููุญ'], 'price': '200 EGP', 'w': '250 G'},
    {'kw': ['ุญูุดุงู ูุฏุฎู', 'ุชุนุจุงู ูุฏุฎู'], 'price': '810 EGP', 'w': '1 KG'}
]

FAQ = [
    {
        "keywords": ["ุฏูุฏ", "ุทููููุงุช", "ุฏูุฏู", "ูุฏูุฏู", "ุญุงุฌู ูู ุจุทููุง"],
        "answer": "ููุฏู ุฏู ูุด ุฏูุฏ ุฏู ุจูููู ุทููููุงุช.. ุงูุทููููุงุช ูู ุณููู ุงูุฑูุฌู ุชูุฌุฏ ูู ุงูุชุฌููู ุงูุจุทูู ูุฃููุง ุชุฏุฎู ูู ุนูููุงุช ุงูุงูุชุตุงุต ูุงูุชูุซูู ุงูุบุฐุงุฆู ููุณููู ููู ูุง ุชุตูุจ ุงูุฅูุณุงู ู ุฒูุงุฏู ูู ุงูููุงูู ูุชู ุชุฌููุฏ ุงูุฃุณูุงู ุนูุฏ ุฏุฑุฌู ูู 35 ุงูู 40 ุชุญุช ุงูุตูุฑ ูุชุตุจุญ ุงูุทููููุงุช ุฌุฒุก ูู ุงูุฃูุนุงุก ููุง ุชุคุซุฑ ุนูู ุขูููุง. ุงูุฏูุฏ ุฏู ูู ุญู ููููู ูุฏู ูู ุฎุทุฑ ุนูู ุตุญุฉ ุงูุงูุณุงู ู ุงูุณููู ุบูุฑ ุตุงูุญุฉ ููุงุณุชููุงู ... ุญุจูู ููุถุญ ุงูุชู ูููู ูู ุฏูุฏ ุญู ูู ุงูุณููู ู ุจูุฌู ูููู ... ุงูุณูู ุฒู ุงูุฅูุณุงู ููุง ุจูููุช ุจููุฑ ุจูุฑุงุญู ูุจู ูุง ููุตู ุงู ูููู ูู ุฏูุฏ ูุงุฒู ูููู ููุชูุฎ ู ุจุนุฏูู ูุชุนูู ู ุจุนุฏูุง ูุชูุชู ู ุจุนุฏูุง ูููู ูู ุฏูุฏ ุญู ... ู ุงูุณููู ุทุงููุง ูุด ููุชูุฎู ุงู ูุชุนููู ุงู ูุชูุชูู ู ููููุงุด ูู ุงูุงุณุจุงุจ ุงูุชู ุชุคุฏู ูุธููุฑ ุฏูุฏ ุญู ูุฏู ุทููููุงุช ุจูุชุบุฐู ุนูููุง ุงูุณูู"
    },
    {
        "keywords": ["ูููู", "ุงุณุนุงุฑ", "ุงููุชุงููุฌ", "ูุงุฆูู ุงูุทุนุงู", "ูููู ุงููููู"],
        "answer": "ุฏุง ูููู ูููู ุงูููุชุฌุงุช ุจุชุงุนุชูุง https://heyzine.com/flip-book/31946f16d5.html"
    },
    {
        "keywords": ["ุงุชุงูุฏ ูููู", "ุงูุงุตูู", "ุชูููุฏ", "ุฑูุฌู ุงุจู ุงูุณูุฏ ุงูุงุตููู"],
        "answer": "ุงููุตุฏุฑ: ุญุงูู ุดุฑุงุก ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ูู ูุตุงุฏุฑ ููุซููุฉ ูุถูุงู ุญุตููู ุนูู ุงูููุชุฌ ุงูุฃุตูู"
    },
    {
        "keywords": ["ุฌููู", "ุงุณุนุงุฑ ุงูุฌููู", "ูููุงุช", "ุชุงุฌุฑ", "ุนุงูุฒ ูููู"],
        "answer": "ููุงุณุชูุณุงุฑ ู ุทูุจ ุงููุณุงุนุฏุฉ ูุฑุฌู ุงูุงุชุตุงู ุนูู ุงุฑูุงู ุงููุตูุน : 01211113882"
    },
    {
        "keywords": ["ุณูุฏูุชุดุงุช", "ุณุงูุฏูุชุด", "ุณูุงุทู", "ุชูุตูู ุณูุฏูุชุดุงุช"],
        "answer": "ูููู ุงูุณุงูุฏููุชุดุงุช ู ุงูุณูุทุฉ ุบูุฑ ูุชุงุญ ุญุงููุง ููุง ููุฌุฏ ุชูุตูู ููุณุงูุฏููุชุดุงุช ู ุงูุณูุทุฉ"
    },
    {
        "keywords": ["ููุงุนูุฏ ุงููุฑูุน", "ุจุชูุชุญูุง ุงูุชู", "ุดุบุงููู ููุณุงุนู ูุงู", "ูู ูุงู ููุงู"],
        "answer": "ูู ูกู ุตุจุงุญุง ููุณุงุนู ูกูข ููุชุตู ุงูููู"
    },
    {
        "keywords": ["ุชุตุฏูุฑ", "ุจุฑุง ูุตุฑ", "ุดุญู ุฏููู", "ุงุญูุฏ ุจุชุงุน ุงูุชุตุฏูุฑ"],
        "answer": "01272475555 ุงุณุชุงุฐ ุงุญูุฏ ุญุถุฑุชู ุชูุงุตู ูุนุงู ูุงุชุณุงุจ ููุณุงุนุฏ ุญุถุฑุชู"
    },
    {
        "keywords": ["ูุดุชุฑูุงุช", "ุฑูู ุงููุดุชุฑูุงุช", "ุงุฏุงุฑู ุงููุดุชุฑูุงุช"],
        "answer": "ุฑูู ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช : 01223066445"
    },
    {
        "keywords": ["ุชูุธูู", "ุดุบู", "ูุธุงุฆู", "ุงุชุด ุงุฑ", "hr"],
        "answer": "ุฑูู ุงุฏุงุฑุฉ ุงูHR ูู ุจูุฑุณุนูุฏ : 01200056103"
    },
    {
        "keywords": ["ุงุดูู", "ูุงุฑ", "ุงุณุฎู", "ุชุณุฎูู", "ุจูุชุงุฌุงุฒ", "ุดูู"],
        "answer": "ูุง ููุฌุฏ ุฑูุฌุฉ ููุดูู ููุง ุชุชุนุฑุถ ูุงู ุญุฑุงุฑุฉ ุงูุฑูุฌุฉ ูุฏููุง ุฌุงูุฒุฉ ููุงูู ูุจุงุดุฑุฉ ููุง ูููู ุฏูููุง ุจุงูุฒูุช"
    },
    {
        "keywords": ["ุงููุฑู ุจูู ุงููุฌูุฏู ูุงููุฑูุด", "ูุฌูุฏู", "ูุฑูุด", "ุตูุงุญูู"],
        "answer": "ุงููุฑู ุจูู ุงูุฑูุฌุฉ ุงููุฌูุฏุฉ ู ุงูุฑูุฌุฉ ุงููุฑูุด: ุงูุฑูุฌู ุงููุฌูุฏู .. ุชุญูุธ ูู ุฏุฑุฌู ุญุฑุงุฑู -18ุ ุตูุงุญูู 3 ุดููุฑุ ุชุญูุธ ูู ุงูุชุฌููุฏ ู ููุณ ุงูุชุจุฑูุฏ. ุงูุฑูุฌู ุงููุฑูุด.. ุชุญูุธ ูู ุฏุฑุฌู ุญุฑุงุฑู 0 ุงูู 4ุ ุตูุงุญูู ุดูุฑุ ุชุญูุธ ูู ุงูุชุจุฑูุฏ (ุฏุฑุฌู ุญุฑุงุฑู ุงูุซูุงุฌู)"
    },
    {
        "keywords": ["ูุฒู ุงููุฑุชููู", "ูุฑุชููู ุงูุฑูุฌู ูุงู ูููู"],
        "answer": "ูุฒู ูุฑุชููุฉ ุงูุฑูุฌุฉ ุงููุฌูุฏู ุงููุฑุชููู ุจุชููู ูู 7.5 ู 8 ูููู ูุง ููุฏู"
    },
    {
        "keywords": ["ุงูููุณ ุงูุงุณูุฏ ูุงูุฌููุฏ", "ูุงูููู ุฌููุฏ", "ุชุบููู"],
        "answer": "ุงูุญุฌู ุงูุตุบูุฑ ุจุชููู ูู ุงูุชุบููู ุงูุฌููุฏ ( ุงููุงูููู ) ุงูุตู ุญุฌู ุจุชููู 600 ุฌุฑุงู - ุงูุญุฌู ุงูุงูุจุฑ ุจุชููู ูู ุงูุชุบููู ุงูุงุณูุฏ ูููู ุชูุตู ุญุฌููุง ููููู ุงู ูููู ู 200 ุงู 800 ุฌุฑุงู ูุง ููุฏู"
    },
    {
        "keywords": ["ุงููุฑู ุจูู ุงูุนุงุฏูู ู 24", "ูุนูู ุงูู 24", "ููุฒู 24"],
        "answer": "- ูู ุนูุงุฑ 24 ุนุฏุฏ ุณุงุนุงุช ุงูุชุฏุฎูู ุงุทูู ูู ุงูุนุงุฏูุฉ - ูู ุนูุงุฑ 24 ุญุฌู ุงูุณููุฉ ุงุตุบุฑ ูู ุญุฌู ุงูุณููุฉ ุงูุนุงุฏูุฉ - ูู ุนูุงุฑ 24 ุทุนู ุงูุชุฏุฎูู ุจูููู ูุนุฒุฒ ุงูุซุฑ ูุงู ุนุฏุฏ ุณุงุนุงุช ุงูุชุฏุฎูู ุจุชููู ุงุฒูุฏ ูู ุนุฏุฏ ุณุงุนุงุช ุงูุชุฏุฎูู ูู ุงูุณููุฉ ุงูุนุงุฏูุฉ"
    },
    {
        "keywords": ["ุงุญูุธูุง ุงุฒุงู", "ุชุฎุฒูู", "ุงููุฑูุฒุฑ ููุง ุงูุซูุงุฌู", "ุดูู ุงูุฑูุฌู"],
        "answer": "ููุถู ุงู ุชุญูุธ ูู ุงููุฑูุฒุฑ ุจุนุฏ ุงูุดุฑุงุก"
    },
    {
        "keywords": ["ูุนูู ุงูู ูุงูููู", "ุชุบููู ููุฑุบ"],
        "answer": "ุฑูุฌุฉ ูู ุนุจูุงุช ููุฑุบุฉ ุงูููุงุก"
    },
    {
        "keywords": ["ุชูููุญ ุงููุณูุฎ", "ุจูุชููุญ ุงุฒุงู", "ุจูุฑู ูุณูุฎ"],
        "answer": "ูุชู ุนูู ุงููุณูุฎ ูู ุณูู ุงูุจูุฑู *ูุชู ุชูููุญ ุงููุณูุฎ ูุฑูุด ูุงููุงู ุงูููู ุงูุจูุชูุฑู *ูุชู ุชูููุญ ุงููุณูุฎ ุชูููุญ ุฌุงู *ูุญูุธ ุงููุณูุฎ ุฏุงุฎู ุซูุงุฌุงุช ุจุฏุฑุฌุงุช ุญุฑุงุฑุฉ ูู 0 ุงูู 4 ูุงููุงู ุงูููู ุงูุจูุชูุฑู"
    },
    {
        "keywords": ["ุชููู ุจูุถุงุก ูุญูุฑุงุก", "ุงููุฑู ุจูู ูุญู ุงูุชููู"],
        "answer": "ุงููุญู ุงูุงุจูุถ ุงูุชุญ ูู ุงููุญู ุงูุงุญูุฑ ูุงู ุงูููู ุงูุฃุญูุฑ ูู ูุญู ุงูุชููู ุจูุฌู ูู ุงููููุบููุจูู ูุงูููููุฌููุจูู ุ ุงููููุบููุจูู ูู ุจุฑูุชูู ูุญูู ุงูุฃูุณุฌูู ูุฐูู ูููู ุงููุญู ุงูุงุญูุฑ ูู ุงูุชููุฉ ูุณุจุฉ ุงูุจุฑูุชูู ุงูููุฌูุฏู ููู ุงุนูู ูู ุงูุชููู ุงูุจูุถุงุก ูุญู ุงูุชููุฉ ุงูุงุญูุฑ ุจูููู ุทุฑู ุงูุซุฑ ูู ูุญู ุงูุชููุฉ ุงูุงุจูุถ ุจุณุจุจ ุฒูุงุฏุฉ ูุณุจุฉ ุงูุจุฑูุชูู ููู"
    },
    {
        "keywords": ["ุฏู ูู ุงููุณูุฎ", "ุงููุณูุฎ ููู ุฏู", "ุณูุงุฆู ุญูุฑุงุก"],
        "answer": "ูุง ููุฏู ุงูุณููู ุฌุงูุฒู ุนูู ุงูุงูู ู ุงูุฏู ุฏู ุจูููู ุจุณุจุจ ุงู ุงูุณููู ุจุชุชููุญ ูุฑูุด ู ุจูุชู ุญูุธูุง ุจุนุฏ ุนูููุฉ ุงูุชูููุญ ูู ุงูุชุฌููุฏ ู ุนูุฏ ุงูุดุฑุงุก ุจุชุฎุฑุฌ ูู ูุฑุญูู ุงูุชุฌููุฏ ู ุงูุณููู ุจุชูู ุนุดุงู ูุฏู ูู ุงูุณูุงุฆู (ุฏู)"
    },
    {
        "keywords": ["ููููู ูุงุดูู", "ุงูุฑูุฌู ุงูููููู ูุงุดูู"],
        "answer": "ุงูุฑูุฌุฉ ุงูููููุฉ ุจุชููู ูุฎููุฉ ููุงุฎุฏู 3 ุทุจูุงุช ุณููู ูุชุนุฒูุฒ ุทุนู ุงูุชุฏุฎูู ูููุง ุนุดุงู ูุฏู ุจุชููู ุงูุดู ุดููู ูู ุงูุฑูุฌุฉ ุงูุนุงุฏูู"
    },
    {
        "keywords": ["ุญุณุงุจุงุช", "ูุงููุงุช", "ุจููู", "ูุญูุฏ ุงูุดูุงุน"],
        "answer": "01204464066 ุงุณุชุงุฐ ูุญูุฏ ุงูุดูุงุน ูุฏูุฑ ุงูุญุณุงุจุงุช ูููู ูุณุงุนุฏ ุญุถุฑุชู"
    },
    {
        "keywords": ["ููุงุฏู", "ูุทุงุนู", "ุชูุฑูุฏ", "ุงุณุชุงุฐ ุจูุงู"],
        "answer": "ุฏุฉ ุฑูู ุงูุงุณุชุงุฐ ุจูุงู ูุงููุฏู ูุณุคู ุงูุชูุฑูุฏ ุชูุฏุฑ ุชุชูุงุตู ูุนุงุฉ ู ููุณุงุนุฏ ุญุถุฑุชู 01221093951"
    },
    {
        "keywords": ["ุชููู ูุตุฑู", "ุชููู ูุณุชูุฑุฏู"],
        "answer": "ุงููุงูุฒ ุงูุชููุฉ ุจูููู ูุณุชูุฑุฏ ู ูุทุจูุน ู ุฏุง ุงููุงู ููุณู ูุด ุงูุณููุฉ ููู ุงูุชููุฉ ุงูู ุนูุฏูุง ูุด ูุณุชูุฑุฏุฉ ุชููุฉ ูุตุฑูุฉ ู ุจูุตุทุงุฏูุง ูู ุงูุจุญุฑ ุงูุงุจูุถ ุงููุชูุณุท"
    },
    {
        "keywords": ["ููู ุบุงููู", "ุงูุงุณุนุงุฑ ุบุงููู", "ุบุงููู ููู"],
        "answer": "ูุงููุง ุจูุถูููู ุฌูุฏุฉ ููุชุฌ ูุง ููุฏู ุญูุซ ุงู ุทุฑููุฉ ุงูุชูููุญ ู ุงูุชุฏุฎูู ูุฎุชูููุ ุงุญูุง ุจูููุญ ุณูู ุงูุฑูุฌุฉ ุจูุญููู ุจุฑุงูู ู ุจูุชู ุชุฏุฎูู ุงูุณูู ุนูู ุงูุจุงุฑุฏ ุจูุดุงุฑุฉ ุงููุงูู ุนุดุงู ูุถูู ูุญุถุฑุชู ููุชุฌ ุตุญู ูุฏุฎู ุจุดูู ุตุญูุญ ุฌุงูุฒ ุนูู ุงูุงูู"
    },
    {
        "keywords": ["ููุน ุงูุชููู", "ุจุชุณุชุฎุฏููุง ุชููู ุงูู"],
        "answer": "ุชููุฉ ูููููู"
    },
    {
        "keywords": ["ููุงุฏ ุญุงูุธู"],
        "answer": "ูู ุงูููุชุฌุงุช ุนูุฏูุง ุจุฏูู ููุงุฏ ุญุงูุธุฉ"
    }
]

# ================== CORE LOGIC ==================
def get_answer(user_id, text):
    try:
        q_clean = clean(text)
        
        # 1. ุงูุชุฑุญูุจ
        if any(w in q_clean for w in ['ุงููุง', 'ุณูุงู', 'ุงุฒูู']):
            return "ุฃููุงู ุจู ูู ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ๐ ููุฑุชูุง.. ุญุงุจุจ ุชุนุฑู ุฃุณุนุงุฑูุง ุงูููุงุฑุฏุฉุ"

        # 2. ุงูุจุญุซ ุนู ุงูููุชุฌ (ุจุงููุทุงุจูุฉ ุงููุจุงุดุฑุฉ)
        detected_p = None
        for p in PRODUCTS:
            for k in p["kw"]:
                if clean(k) in q_clean:
                    detected_p = p
                    break
            if detected_p: break

        # 3. ุชุญุฏูุซ ุงูุฐุงูุฑุฉ ูู ููู ููุชุฌ ุฌุฏูุฏ
        if detected_p:
            USER_CONTEXT[user_id] = detected_p

        # 4. ุงูู FAQ
        for f in FAQ:
            if any(clean(kw) in q_clean for kw in f["keywords"]):
                return f["answer"]

        # 5. ููุทู ุงูุณุนุฑ ูุงูุชุฃููุฏ
        is_price_req = any(x in q_clean for x in ["ุณุนุฑ", "ุจูุงู", "ูุงู", "ุจูู"])
        is_confirm = any(word == q_clean for word in ['ุงู', 'ุงููู', 'ุชูุงู', 'ูุงุฑูุช'])

        if is_price_req or is_confirm:
            p = detected_p or USER_CONTEXT.get(user_id)
            if p:
                return f"๐ฐ ุณุนุฑ {p['name']}:\nุงููุฒู: {p['w']}\nุงูุณุนุฑ: {p['price']} โจ"
            return "ุฏุง ูููู ูููู ุงูุฃุณุนุงุฑ ูุงูููุชุฌุงุช: https://heyzine.com/flip-book/31946f16d5.html"

        # 6. ูู ุฐูุฑ ุงูุตูู ููุท
        if detected_p:
            return f"๐ {detected_p['name']} ูุชุงุญ ูุง ููุฏู. ุชุญุจ ุชุนุฑู ุงูุณุนุฑุ"

        return "ููุฑุชูุง ูู ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ๐.. ุงุคูุฑูุง ูุญุชุงุฌ ุชุณุฃู ุนู ุฅููุ (ุฑูุฌุฉุ ูุณูุฎุ ุจุทุงุฑุฎุ ุชููุฉ)"

    except Exception:
        return "ููุฑุชูุง ูุง ููุฏูุ ุงุคูุฑูุง ูุญุชุงุฌ ุชุณุฃู ุนู ุฅููุ โจ"

# ================== WEBHOOK ==================
@app.route("/webhook", methods=["GET"])
def verify():
    if request.args.get("hub.verify_token") == VERIFY_TOKEN:
        return request.args.get("hub.challenge")
    return "failed", 403

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()
    if data.get("object") == "page":
        for entry in data.get("entry", []):
            for ev in entry.get("messaging", []):
                sender = ev["sender"]["id"]
                if "message" in ev and "text" in ev["message"]:
                    reply = get_answer(sender, ev["message"]["text"])
                    send_message(sender, reply)
    return "ok", 200

def send_message(user_id, text):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    payload = {"recipient": {"id": user_id}, "message": {"text": text}}
    requests.post(url, json=payload)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))
