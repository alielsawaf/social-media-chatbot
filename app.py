from flask import Flask, request, jsonify
import os
import requests 

app = Flask(__name__)

# --- 1. قراءة متغيرات البيئة من Railway ---
# يجب التأكد من وجود هذه المتغيرات في Railway (Variables)
VERIFY_TOKEN = os.environ.get('VERIFY_TOKEN')
PAGE_ACCESS_TOKEN = os.environ.get('PAGE_ACCESS_TOKEN')

# --- 2. قائمة الأسئلة الشائعة والإجابات (FAQ) المحدثة ---
# تم تحديث هذا القاموس بالمعلومات الخاصة بمنتجات أبو السيد
FAQ = {
    "هل يوجد توصيل": "خدمة التوصيل...\nالقاهره: خدمة توصيل أبو السيد متاحة الآن في مدينتي اربيسك والتجمع الأول والتجمع الخامس والتجمع الثالث وويست جيت أكتوبر فقط.\nللطلبات خارج هذه المناطق، نوفر لك سائقًا خاصًا لكن برسوم توصيل إضافية.\nخدمه التوصيل متوفره فى بورسعيد و القاهره و اسكندريه والغردقه فقط.",
    "ازاي اتأكد ان الرنجة دي رنجة ابو السيِد": "المصدر: حاول شراء رنجة أبو السيد من مصادر موثوقة لضمان حصولك على المنتج الأصلي.\nوالرنجه الخاصة بنا تكون في كراتين وليس صناديق خشب.",
    "صناديق خشب": "الرنجة الخاصة بنا تكون في كراتين وليس صناديق خشب.", # مفتاح منفصل للصناديق
    "ساندوتشات و السلطة": "منيو الساندويتشات و السلطة غير متاح حاليا ولا يوجد توصيل للساندويتشات و السلطة.",
    "الفروع المتاح بها الساندوتشات و السلطة": "منيو الساندويتشات و السلطة غير متاح حاليا ولا يوجد توصيل للساندويتشات و السلطة.",
    "منيو المنتجات": "مساء الخير دا لينك منيو المنتجات بتاعتنا:\nhttps://heyzine.com/flip-book/31946f16d5.html",
    "ليه الرنجه بتاعتكو غاليه": "لاننا بنضمنلك جودة منتج يا فندم حيث ان طريقة التمليح و التدخين مختلفة.\nاحنا بنملح سمك الرنجة بمحلول براين و بيتم تدخين السمك علي البارد بنشارة الماني عشان نضمن لحضرتك منتج صحي مدخن بشكل صحيح جاهز علي الاكل.",
    "ليه المنتجات بتاعتكوا غالية": "لاننا بنضمنلك جودة منتج يا فندم حيث ان طريقة التمليح و التدخين مختلفة.",
    "هل الكانز بتاعة التونة مستورده ولا مصري": "الكانز التونة بيكون مستورد و مطبوع و دا الكان نفسه مش السمكة.\nلكن التونة الي عندنا مش مستوردة، هي تونة مصرية و بنصطادها من البحر الابيض المتوسط.",
    "الفرق بين السلمون الشراح في الفاكيوم": "الفرق بيكون في لون اللحم، في الطبق بيكون افتح من الي في الكيس بسبب طريقة التدخين و طريقة التمليح و طريقة طهي المنتج و ده بيؤدي الي ان المنتجين بيكون في بينهم اختلاف في الطعم.",
    "مسؤل توريد للفنادق والمطاعم": "دة رقم الاستاذ بلال يافندم مسؤل التوريد تقدر تتواصل معاه و هيساعد حضرتك: 01221093951",
    "عدم الرد علي تليفون الفروع": "ممكن حضرتك تتواصل تاني عشان للاسف في ضغط علي الفروع.",
    "مدير الحسابات": "01204464066 استاذ محمد الشماع مدير الحسابات ممكن يساعد حضرتك.",
    "الفرق بين الرنجة الفيليه و الرنجة العادية": "الرنجة الفيليه بتيجي مخلية و بيتم عليها عملية التصنيع بداية من التمليح للتدخين و بتاخد 3 طبقات تدخين لتعزيز طعم التدخين فيها. عشان كدا بتكون انشف من الرنجة العادية و الفص طعمه مختلف.",
    "ليه الرنجة الفيليه بتكون ناشفة": "الرنجة الفيليه بتكون مخلية وواخده 3 طبقات سموك لتعزيز طعم التدخين فيها، عشان كده بتكون انشف شويه من الرنجة العاديه.",
    "ليه الفسيخ بيكون في دم": "يا فندم السمكه جاهزه علي الاكل و الدم ده بيكون بسبب ان السمكه بتتملح فريش و بيتم حفظها بعد عملية التمليح في التجميد. و عند الشراء بتخرج من مرحله التجميد ف السمكه بتفك عشان كده في السوائل (دم).",
    "الفرق بين لحم التونة الابيض و لحم التونة الاحمر": "اللحم الابيض افتح من اللحم الاحمر لان اللون الأحمر في لحم التونه بيجي من الميوغلوبين والهيموجلوبين. الميوغلوبين هو بروتين يحمل الأكسجين لذلك يكون اللحم الاحمر في التونة نسبة البروتين الموجودة فيه اعلي من التونة البيضاء. لحم التونة الاحمر بيكون طري اكثر من لحم التونة الابيض بسبب زيادة نسبة البروتين فيه.",
    "معلومات عن سمكة الفسيخ": "يتم عمل الفسيخ من سمك البوري. يتم تمليح الفسيخ فريش لايقاف النمو البكتيري. يتم تمليح الفسيخ تمليح جاف. يحفظ الفسيخ داخل ثلاجات بدرجات حرارة من 0 الي 4 لايقاف النمو البكتيري.",
    "كيفية الاحتفاظ بالرنجة بعد الشراء": "يفضل ان تحفظ في الفريزر بعد الشراء.",
    "الفرق بين الرنجة العادية و الرنجة عيار 24": "في عيار 24 عدد ساعات التدخين اطول من العادية، و حجم السمكة اصغر من حجم السمكة العادية، و طعم التدخين بيكون معزز اكثر لان عدد ساعات التدخين بتكون ازيد من عدد ساعات التدخين في السمكة العادية.",
    "طلب اوردر اونلاين": "غير متاح حاليا الطلب اونلاين يا فندم. لعمل اوردر بيكون عن طريق الإتصال على: 01212166660",
    "وزن كرتونة الرنجه المجمده": "وزن كرتونة الرنجة المجمده الكرتونه بتكون من 7.5 ل 8 كيلو يا فندم. ده مش جمله ده قطاعى عادى.",
    "الفرق بين الرنجه المجمده و الفريش": "الرنجه المجمده: تحفظ في درجه حراره -18، صلاحيه 3 شهور، وتحفظ في التجميد و ليس التبريد. الرنجه الفريش: تحفظ في درجه حراره 0 الي 4، صلاحيه شهر، وتحفظ في التبريد (درجه حراره الثلاجه)."
}

# --- 3. دالة البحث عن الإجابة ---
def get_answer(user_message):
    """تبحث عن إجابة مطابقة للسؤال أو عن كلمة مفتاحية."""
    user_message_lower = user_message.lower()
    
    for question_key, answer in FAQ.items():
        # بحث بسيط عن الكلمات المفتاحية
        if question_key in user_message_lower or user_message_lower in question_key.lower():
            return answer
    
    return None # لم يتم العثور على إجابة

# --- 4. دالة إرسال الرد إلى فيسبوك ماسنجر ---
def send_message(recipient_id, message_text):
    """تستخدم Access Token لإرسال رسالة إلى المستخدم."""
    params = {
        "access_token": PAGE_ACCESS_TOKEN
    }
    headers = {
        "Content-Type": "application/json"
    }
    data = {
        "recipient": {
            "id": recipient_id
        },
        "message": {
            "text": message_text
        }
    }
    # إرسال طلب POST إلى API فيسبوك
    response = requests.post(
        "https://graph.facebook.com/v19.0/me/messages", # تأكد من تحديث نسخة API
        params=params,
        headers=headers,
        json=data
    )
    # هذا السطر مهم جداً لتشخيص فشل الرد!
    if response.status_code != 200:
        print(f"Failed to send message: {response.text}")
        print(f"Status Code: {response.status_code}") # إضافة حالة الكود للمساعدة في التشخيص

# --- 5. نقطة نهاية الويب (Webhook Endpoint) ---
@app.route('/webhook', methods=['GET', 'POST'])
def webhook():
    # --- كود التحقق الأولي لفيسبوك (GET Request) ---
    if request.method == 'GET':
        mode = request.args.get('hub.mode')
        token = request.args.get('hub.verify_token')
        challenge = request.args.get('hub.challenge')
        
        # التأكد من تطابق الرمز
        if mode == 'subscribe' and token == VERIFY_TOKEN:
            return challenge, 200 # نجاح التحقق
        else:
            return "Verification token mismatch", 403

    # --- كود معالجة الرسائل العادي (POST Request) ---
    if request.method == 'POST':
        data = request.json
        
        # تصفح بيانات فيسبوك لاستخراج الرسالة
        try:
            for entry in data['entry']:
                for messaging_event in entry['messaging']:
                    if messaging_event.get('message'):
                        sender_id = messaging_event['sender']['id']
                        message_text = messaging_event['message']['text']
                        
                        # 1. البحث في الأسئلة الشائعة
                        response_text = get_answer(message_text)
                        
                        if response_text:
                            # 2. إجابة آلية جاهزة
                            send_message(sender_id, response_text)
                        else:
                            # 3. تحويل للمشرف البشري
                            # تم تعديل الرسالة لتعكس تحويل المكالمة بشكل واضح
                            handoff_message = "عذراً، لم أجد إجابة محددة. تم تحويل استفسارك إلى فريق الدعم لدينا، وسيرد عليك أحد الموظفين في أقرب وقت ممكن!"
                            send_message(sender_id, handoff_message)
                            print(f"*** تنبيه: تم تحويل السؤال التالي للمشرف: {message_text} ***")
        except Exception as e:
            # طباعة الخطأ في السجلات لمزيد من التشخيص
            print(f"Error processing message: {e}")
            
        return jsonify({"status": "ok"}), 200

if __name__ == '__main__':
    app.run(debug=True)
