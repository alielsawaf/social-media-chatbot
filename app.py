from flask import Flask, request, send_file, abort
from fuzzywuzzy import fuzz
import requests
import re
import os

app = Flask(__name__)

# ================== 1: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ==================
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
VERIFY_TOKEN = "my_secret_token"
WHATSAPP_NUMBER = "201090636076"
MENU_LINK = "https://heyzine.com/flip-book/31946f16d5.html"

GREETINGS = ['Ø§Ù‡Ù„Ø§','Ø³Ù„Ø§Ù…','Ù‡Ø§ÙŠ','Ù‡Ù„Ø§','Ù…Ø±Ø­Ø¨Ø§','ØµØ¨Ø§Ø­','Ù…Ø³Ø§Ø¡','Ø§Ø²ÙŠÙƒ','ÙŠØ§ ÙÙ†Ø¯Ù…','Ù†ÙˆØ±ØªÙˆÙ†Ø§']

# ================== 2: Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ==================
def clean_arabic_text(text):
    if not text: return ""
    text = text.lower().strip()
    text = re.sub(r"[Ø¥Ø£Ø¢Ø§]", "Ø§", text)
    text = re.sub(r"Ø©", "Ù‡", text)
    text = re.sub(r"Ù‰", "ÙŠ", text)
    text = re.sub(r"[^\w\s]", "", text)
    return re.sub(r"\s+", " ", text)

def smart_similarity(user_text, target_text):
    s1 = fuzz.token_set_ratio(user_text, target_text)
    s2 = fuzz.partial_ratio(user_text, target_text)
    return max(s1, s2)

# ================== 3: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø£Ø³Ø¹Ø§Ø±) ==================
PRODUCTS = [
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ø¯Ø®Ù†Ù‡ Ù…Ø¨Ø·Ø±Ø®Ù‡ Ù…Ø±Ù…Ù„Ù‡', 'Ø±Ù†Ø¬Ù‡ Ù…Ø¨Ø·Ø±Ø®Ù‡', 'Ø±Ù†Ø¬Ù‡ Ù…Ø±Ù…Ù„Ù‡'], 'price': '250 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ø¯Ø®Ù†Ù‡', 'Ø±Ù†Ø¬Ù‡ Ø¹Ø§Ø¯ÙŠÙ‡'], 'price': '200 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ø¯Ø®Ù†Ù‡ 24 Ù‚ÙŠØ±Ø§Ø·', 'Ø±Ù†Ø¬Ù‡ 24', 'Ø±Ù†Ø¬Ù‡ Ø¹ÙŠØ§Ø± 24'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ 24 Ù…Ø¨Ø·Ø±Ø®Ù‡', 'Ø±Ù†Ø¬Ù‡ 24 Ù…Ø±Ù…Ù„Ù‡'], 'price': '320 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ Ù…Ù†Ø²ÙˆØ¹Ù‡ Ø§Ù„Ø§Ø­Ø´Ø§Ø¡ ÙØ§ÙƒÙŠÙˆÙ…', 'Ø±Ù†Ø¬Ù‡ ÙØ§ÙƒÙŠÙˆÙ…'], 'price': '300 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø¨Ø¯ÙˆÙ† Ø²ÙŠØª', 'Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø³Ø§Ø¯Ù‡'], 'price': '600 EGP', 'w': '1 KG'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ ØµÙˆØµ ÙÙ„ÙÙ„ ÙˆÙƒØ§ÙÙŠØ§Ø±'], 'price': '150 EGP', 'w': '200 G'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ ÙƒØ§Ø±ÙŠ'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø²ÙŠØª'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['Ø±Ù†Ø¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ù…Ø¯Ø®Ù†Ù‡'], 'price': '85 EGP', 'w': '125 G'},
    {'kw': ['ÙƒØ§ÙÙŠØ§Ø± Ø³Ø¨Ø±ÙŠØ¯', 'Ø±Ù†Ø¬Ù‡ ÙƒØ§ÙÙŠØ§Ø± Ø³Ø¨Ø±ÙŠØ¯'], 'price': '70 EGP', 'w': '200 G/130 G'},
    {'kw': ['Ø¨Ø·Ø§Ø±Ø® Ø±Ù†Ø¬Ù‡ Ø²ÙŠØª ÙƒØ§Ù…Ù„Ø©'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['Ø¨Ø·Ø§Ø±Ø® Ø±Ù†Ø¬Ù‡ Ø¨Ø±ØªÙ‚Ø§Ù„', 'Ø¨Ø·Ø§Ø±Ø® Ù…Ù‡Ø±ÙˆØ³Ù‡'], 'price': '250 EGP', 'w': '250 G'},
    # Ø§Ù„Ù…Ø§ÙƒØ±ÙŠÙ„
    {'kw': ['Ù…Ø§ÙƒØ±ÙŠÙ„ Ù…Ø¯Ø®Ù† Ù…Ù…Ù„Ø­', 'Ù…Ø§ÙƒØ±ÙŠÙ„'], 'price': '410 EGP', 'w': '1 KG'},
    {'kw': ['Ù…Ø§ÙƒØ±ÙŠÙ„ ÙØ§ÙƒÙŠÙˆÙ…'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['Ù…Ø§ÙƒØ±ÙŠÙ„ ÙÙŠÙ„ÙŠÙ‡'], 'price': '800 EGP', 'w': '1 KG'},
    # Ø§Ù„ÙØ³ÙŠØ®
    {'kw': ['ÙØ³ÙŠØ® ÙÙŠÙ„ÙŠÙ‡ Ø²ÙŠØª', 'ÙØ³ÙŠØ® Ø²ÙŠØª'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ÙØ³ÙŠØ® ÙÙŠÙ„ÙŠÙ‡ Ø¯Ø®Ø§Ù†', 'ÙØ³ÙŠØ® Ù…Ø¯Ø®Ù†'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ÙØ³ÙŠØ® Ø³Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ø¬Ø±'], 'price': '250 EGP', 'w': '250 G'},
    {'kw': ['ÙØ³ÙŠØ® Ø¨Ø¯ÙˆÙ† Ø¨ÙƒØªÙŠØ±ÙŠØ§', 'ÙØ³ÙŠØ® Ø·Ø¨ÙŠ'], 'price': '460 EGP', 'w': '1 KG'},
    {'kw': ['ÙØ³ÙŠØ® Ù…Ø¨Ø·Ø±Ø®'], 'price': '560 EGP', 'w': '1 KG'},
    {'kw': ['Ø´Ø±Ø§Ø¦Ø­ Ø¨ÙˆØ±ÙŠ Ù…Ø¯Ø®Ù†Ù‡', 'ÙÙŠÙ„ÙŠÙ‡ Ø¨ÙˆØ±ÙŠ Ù…Ø¯Ø®Ù†'], 'price': '810 EGP', 'w': '1 KG'},
    # Ø§Ù„Ø³Ù„Ù…ÙˆÙ†
    {'kw': ['Ø³Ù„Ù…ÙˆÙ† Ø­Ø§Ø±', 'spicy salmon'], 'price': '150 EGP', 'w': '125 G'},
    {'kw': ['Ø´Ø±Ø§Ø¦Ø­ Ø³Ù„Ù…ÙˆÙ† Ù…Ø¯Ø®Ù†Ù‡', 'Ø³Ù„Ù…ÙˆÙ† ÙÙŠÙ„ÙŠÙ‡'], 'price': '3000 EGP', 'w': '1 KG'},
    {'kw': ['Ø³ØªÙŠÙƒ Ø³Ù„Ù…ÙˆÙ†'], 'price': '1810 EGP', 'w': '1 KG'},
    {'kw': ['Ø´ÙˆØ±Ø¨Ù‡ Ø³Ù„Ù…ÙˆÙ†'], 'price': '90 EGP', 'w': '160 G'},
    # Ø§Ù„Ø¨Ø·Ø§Ø±Ø® ÙˆØ§Ù„ØªÙˆÙ†Ø©
    {'kw': ['Ø¨Ø·Ø§Ø±Ø® Ø¨ÙˆØ±ÙŠ Ù…Ù…Ù„Ø­Ù‡', 'Ø¨Ø·Ø§Ø±Ø® Ø¨ÙˆØ±ÙŠ'], 'price': '2850 EGP', 'w': '1 KG'},
    {'kw': ['ØªÙˆÙ†Ù‡ Ø­Ù…Ø±Ø§Ø¡ ÙÙŠÙ„ÙŠÙ‡', 'ØªÙˆÙ†Ù‡ Ø­Ù…Ø±Ø§'], 'price': '155 EGP', 'w': '230 G'},
    {'kw': ['ØªÙˆÙ†Ù‡ Ù‚Ø·Ø¹', ' chunks tuna'], 'price': '70 EGP', 'w': '125 G'},
    {'kw': ['ØªÙˆÙ†Ù‡ Ù…Ø·Ù‡ÙŠÙ‡'], 'price': '710 EGP', 'w': '1 KG'},
    # Ø£Ø®Ø±Ù‰
    {'kw': ['Ø§Ù†Ø´ÙˆØ¬Ù‡ ÙÙŠÙ„ÙŠÙ‡ Ø²ÙŠØª', 'Ø§Ù†Ø´ÙˆØ¬Ù‡'], 'price': '110 EGP', 'w': '125 G'},
    {'kw': ['Ø³Ø±Ø¯ÙŠÙ† Ù…Ù…Ù„Ø­'], 'price': '200 EGP', 'w': '250 G'},
    {'kw': ['Ø­Ù†Ø´Ø§Ù† Ù…Ø¯Ø®Ù†', 'ØªØ¹Ø¨Ø§Ù† Ù…Ø¯Ø®Ù†'], 'price': '810 EGP', 'w': '1 KG'}]

# ================== 4: Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© (Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª) ==================
FAQ = [
    # ------------------ 2: Ø§Ù„Ø·ÙÙŠÙ„ÙŠØ§Øª/Ø§Ù„Ø¯ÙˆØ¯ ------------------
    {
        'keywords': ['Ø¯ÙˆØ¯', 'Ø·ÙÙŠÙ„ÙŠØ§Øª', 'Ø­Ø§Ø¬Ø© ØºØ±ÙŠØ¨Ø©', 'Ù…Ø¯ÙˆØ¯Ø©', 'Ø¨Ø§ÙŠØ¸Ø©'],
        'answer': (
            "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ÙŠØ§ ÙÙ†Ø¯Ù…ØŒ Ø§Ù„Ù„ÙŠ Ø¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø³Ù…ÙƒØ© Ø¯ÙŠ Ù…Ø´ Ø¯ÙˆØ¯ØŒ Ø¯ÙŠ Ø¨ØªÙƒÙˆÙ† Ø·ÙÙŠÙ„ÙŠØ§Øª ØªÙˆØ¬Ø¯ ÙÙŠ Ø§Ù„ØªØ¬ÙˆÙŠÙ Ø§Ù„Ø¨Ø·Ù†ÙŠ Ù„Ù„Ø±Ù†Ø¬Ø©. "
            "ÙˆÙ‡ÙŠ Ù„Ø§ ØªØµÙŠØ¨ Ø§Ù„Ø¥Ù†Ø³Ø§Ù† ØªÙ…Ø§Ù…Ø§Ù‹ØŒ ÙˆØ²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©ØŒ Ø¨Ù†Ø¬Ù…Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ Ø¹Ù†Ø¯ Ø¯Ø±Ø¬Ø© -40 ØªØ­Øª Ø§Ù„ØµÙØ± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªØ§Ù… "
            "ÙˆØªØµØ¨Ø­ Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ù…Ø¹Ø§Ø¡ ÙˆÙ„Ø§ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµØ­Ø©."
        )
    },
    # ------------------ 3: ÙŠØ¹Ù†ÙŠ Ø§ÙŠÙ‡ ÙØ§ÙƒÙŠÙˆÙ… ------------------
    {
        'keywords': ['ÙŠØ¹Ù†ÙŠ Ø§ÙŠÙ‡ ÙØ§ÙƒÙŠÙˆÙ…', 'ÙØ§ÙƒÙŠÙˆÙ…', 'vacuum', 'ØªØºÙ„ÙŠÙ'],
        'answer': "ÙØ§ÙƒÙŠÙˆÙ… ÙŠØ¹Ù†ÙŠ Ù…ØºÙ„Ù ÙÙŠ Ø¹Ø¨ÙˆØ§Øª Ù…ÙØ±ØºØ© Ø§Ù„Ù‡ÙˆØ§Ø¡ ØªÙ…Ø§Ù…Ø§Ù‹ØŒ ÙˆØ¯Ù‡ Ø¨ÙŠØ³Ø§Ø¹Ø¯ Ø¥Ù† Ø§Ù„Ù…Ù†ØªØ¬ ÙŠÙØ¶Ù„ Ø·Ø§Ø²Ø¬ ÙˆØµØ­ÙŠ Ù„Ø£Ø·ÙˆÙ„ ÙØªØ±Ø© Ù…Ù…ÙƒÙ†Ø©."
    },
    # ------------------ 4 & 5: Ø§Ù„Ù…Ù†Ø´Ø£ (Ù…ØµØ±ÙŠ ÙˆÙ„Ø§ Ù…Ø³ØªÙˆØ±Ø¯) ------------------
    {
        'keywords': ['Ù…ØµØ±ÙŠ ÙˆÙ„Ø§ Ù…Ø³ØªÙˆØ±Ø¯', 'Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£', 'Ø¨ØªØµÙ†Ø¹Ùˆ ÙÙŠÙ†', 'Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ Ø³ØªØ§Ø±', 'ØµÙ†Ø§Ø¹Ø©'],
        'answer': (
            "Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§ Ù…ØµØ±ÙŠØ© 100% Ø¨ÙŠØªÙ… ØªØµÙ†ÙŠØ¹Ù‡Ø§ ÙˆØªØ¹Ø¨Ø¦ØªÙ‡Ø§ ÙÙŠ Ù…ØµÙ†Ø¹Ù†Ø§ Ø¨Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ (Ù…ØµÙ†Ø¹ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ Ø³ØªØ§Ø±). "
            "ÙˆØ¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ØªÙˆÙ†Ø© Ø¨Ù†ØµØ·Ø§Ø¯Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ØªÙˆØ³Ø·ØŒ Ù„ÙƒÙ† Ø§Ù„ÙƒØ§Ù†Ø² (Ø§Ù„Ø¹Ù„Ø¨Ø© Ø§Ù„ØµÙÙŠØ­) Ù†ÙØ³Ù‡Ø§ Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªØ³ØªÙˆØ±Ø¯."
        )
    },
    # ------------------ 6 & 7: Ù†ÙˆØ¹ Ø§Ù„ØªÙˆÙ†Ø© ÙˆØ§Ù„Ø²ÙŠØª ------------------
    {
        'keywords': ['Ù†ÙˆØ¹ Ø§Ù„ØªÙˆÙ†Ø©', 'ÙŠÙ„ÙˆÙÙŠÙ†', 'yellowfin', 'Ø²ÙŠØª ÙˆÙ„Ø§ Ù…ÙŠØ§Ù‡', 'Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØª'],
        'answer': "Ø¨Ù†Ø³ØªØ®Ø¯Ù… ØªÙˆÙ†Ø© ÙŠÙ„ÙˆÙÙŠÙ† (Yellowfin Tuna) Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ ÙˆÙƒÙ„ Ø§Ù„ØªÙˆÙ†Ø© Ø¹Ù†Ø¯Ù†Ø§ Ù…Ø¹Ø¨Ø£Ø© ÙÙŠ Ø²ÙŠØª Ù†Ø¨Ø§ØªÙŠ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ù…ÙŠØ§Ù‡."
    },
    # ------------------ 8: Ù…ÙˆØ§Ø¯ Ø­Ø§ÙØ¸Ø© ------------------
    {
        'keywords': ['Ù…ÙˆØ§Ø¯ Ø­Ø§ÙØ¸Ù‡', 'Ø·Ø¨ÙŠØ¹ÙŠ', 'ÙƒÙŠÙ…Ø§ÙˆÙŠØ§Øª'],
        'answer': "ÙƒÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø£Ø¨Ùˆ Ø§Ù„Ø³ÙŠØ¯ (Ø±Ù†Ø¬Ø©ØŒ ÙØ³ÙŠØ®ØŒ ØªÙˆÙ†Ø©ØŒ Ø³Ù„Ù…ÙˆÙ†) Ø·Ø¨ÙŠØ¹ÙŠØ© 100% ÙˆØ¨Ø¯ÙˆÙ† Ø£ÙŠ Ù…ÙˆØ§Ø¯ Ø­Ø§ÙØ¸Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹."
    },
    # ------------------ 9 & 50 & 51: Ø§Ù„ØªÙˆÙ†Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© ÙˆØ§Ù„ØµØ§Ù„Ø© ------------------
    {
        'keywords': ['ØªÙˆÙ†Ø© Ù…Ø·Ù‡ÙŠØ©', 'Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§ÙƒÙ„', 'ØµØ§Ù„Ø© Ø§ÙƒÙ„', 'Ø³Ù†Ø¯ÙˆØªØ´Ø§Øª', 'Ø³Ù„Ø·Ø©'],
        'answer': (
            "Ø§Ù„ØªÙˆÙ†Ø© Ø§Ù„Ù…Ø·Ù‡ÙŠØ© (Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ ÙˆØ§Ù„Ø­Ù…Ø±Ø§Ø¡) Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø£ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙ…ÙØ±ØºØ© Ø§Ù„Ù‡ÙˆØ§Ø¡. "
            "Ù„ÙƒÙ† Ù„Ù„Ø¹Ù„Ù…: Ù…Ù†ÙŠÙˆ Ø§Ù„Ø³Ø§Ù†Ø¯ÙˆØªØ´Ø§Øª ÙˆØµØ§Ù„Ø© Ø§Ù„Ø£ÙƒÙ„ Ø¨Ø§Ù„ÙØ±ÙˆØ¹ ØºÙŠØ± Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙ‚Ø·."
        )
    },
    # ------------------ 10: Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„ØªÙˆÙ†Ø© Ø§Ù„Ø£Ø¨ÙŠØ¶ ÙˆØ§Ù„Ø£Ø­Ù…Ø± ------------------
    {
        'keywords': ['Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„ØªÙˆÙ†Ø©', 'Ø§Ù„Ù„Ø­Ù… Ø§Ù„Ø§Ø¨ÙŠØ¶', 'Ø§Ù„Ù„Ø­Ù… Ø§Ù„Ø§Ø­Ù…Ø±', 'Ø¨Ø±ÙˆØªÙŠÙ†'],
        'answer': (
            "Ø§Ù„Ù„Ø­Ù… Ø§Ù„Ø£Ø­Ù…Ø± Ø¨Ø±ÙˆØªÙŠÙ†Ù‡ Ø£Ø¹Ù„Ù‰ ÙˆØ·Ø±ÙŠ Ø£ÙƒØªØ± Ø¨Ø³Ø¨Ø¨ Ù…Ø§Ø¯Ø© Ø§Ù„Ù…ÙŠÙˆØºÙ„ÙˆØ¨ÙŠÙ†. "
            "Ø§Ù„Ù„Ø­Ù… Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø¨ÙŠÙƒÙˆÙ† Ø£ÙØªØ­ ÙÙŠ Ø§Ù„Ù„ÙˆÙ† ÙˆÙ‚ÙˆØ§Ù…Ù‡ Ù…Ø®ØªÙ„ÙØŒ ÙˆØ§Ù„Ø§Ø«Ù†ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø³Ø¨ Ø±ØºØ¨Ø© Ø­Ø¶Ø±ØªÙƒ."
        )
    },
    # ------------------ 14 & 26: Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØ§Ù„Ø·Ù„Ø¨ ------------------
    {
        'keywords': ['ØªÙˆØµÙŠÙ„', 'Ø¯Ù„ÙŠÙØ±ÙŠ', 'Ø´Ø­Ù†', 'Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'],
        'answer': (
            f"Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…ØªØ§Ø­ ÙÙŠ (Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©ØŒ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ØŒ Ø§Ù„ØºØ±Ø¯Ù‚Ø©). "
            f"Ù„Ù„Ø·Ù„Ø¨Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ­Ø¯: {WHATSAPP_NUMBER} Ø£Ùˆ 01212166660."
        )
    },
    # ------------------ 15 & 17 & 18 & 19 & 35 & 37: Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¬Ù…Ù„Ø© ------------------
    {
        'keywords': ['Ø¬Ù…Ù„Ø©', 'ØªØµØ¯ÙŠØ±', 'Ù…Ø´ØªØ±ÙŠØ§Øª', 'hr', 'ØªÙˆØ¸ÙŠÙ', 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', 'ØªÙˆØ±ÙŠØ¯'],
        'answer': (
            "Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª:\n"
            "- Ø§Ù„Ø¬Ù…Ù„Ø©: 01211113882\n"
            "- Ø§Ù„ØªØµØ¯ÙŠØ± (Ø£/ Ø£Ø­Ù…Ø¯): 01272475555\n"
            "- Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© HR: 01200056103\n"
            "- Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: 01223066445\n"
            "- Ø§Ù„ØªÙˆØ±ÙŠØ¯ (Ø£/ Ø¨Ù„Ø§Ù„): 01221093951"
        )
    },
    # ------------------ 20 & 33 & 34: Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø±Ù†Ø¬Ø© ÙˆØ§Ù„ØªØ¯Ø®ÙŠÙ† ------------------
    {
        'keywords': ['Ø¹ÙŠØ§Ø± 24', 'Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø±Ù†Ø¬Ø©', 'ØªØ¯Ø®ÙŠÙ†', 'Ù†Ø§Ø´ÙØ©', 'ÙÙŠÙ„ÙŠÙ‡'],
        'answer': (
            "Ø±Ù†Ø¬Ø© Ø¹ÙŠØ§Ø± 24 Ø­Ø¬Ù…Ù‡Ø§ Ø£ØµØºØ± ÙˆØªØ¯Ø®ÙŠÙ†Ù‡Ø§ Ø£Ø·ÙˆÙ„ ÙˆØ·Ø¹Ù…Ù‡Ø§ Ø£Ù‚ÙˆÙ‰. "
            "Ø£Ù…Ø§ Ø§Ù„ÙÙŠÙ„ÙŠÙ‡ ÙØ¨ØªØ§Ø®Ø¯ 3 Ø·Ø¨Ù‚Ø§Øª ØªØ¯Ø®ÙŠÙ† Ø¹Ø´Ø§Ù† ÙƒØ¯Ù‡ Ø¨ØªÙƒÙˆÙ† Ø£Ù†Ø´Ù Ø´ÙˆÙŠØ© ÙˆØ·Ø¹Ù…Ù‡Ø§ Ù…Ø±ÙƒØ² Ø£ÙƒØªØ±."
        )
    },
    # ------------------ 22 & 30 & 42: Ø§Ù„ØªØ³Ø®ÙŠÙ† ÙˆØ§Ù„Ù†Ø§Ø± ------------------
    {
        'keywords': ['ØªØ³Ø®ÙŠÙ†', 'Ù†Ø§Ø±', 'Ø§Ø´ÙˆÙŠ', 'Ø§Ù„Ø¨ÙˆØªØ§Ø¬Ø§Ø²', 'ÙÙƒ ØªØ¬Ù…ÙŠØ¯'],
        'answer': "Ù…Ù…Ù†ÙˆØ¹ ØªØ¹Ø±Ø¶ Ø§Ù„Ø±Ù†Ø¬Ø© Ù„Ù„Ù†Ø§Ø± Ø£Ùˆ Ø§Ù„ØªØ³Ø®ÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹Ø› Ø§Ù„Ù…Ù†ØªØ¬ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø£ÙƒÙ„. Ù„Ùˆ Ù…Ø¬Ù…Ø¯Ø© Ø³ÙŠØ¨Ù‡Ø§ ØªÙÙƒ Ø¨Ø±Ø§Ø­ØªÙ‡Ø§ ÙˆÙƒÙÙ„ Ø¨Ø§Ù„Ù‡Ù†Ø§ ÙˆØ§Ù„Ø´ÙØ§."
    },
    # ------------------ 23 & 49: Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ------------------
    {
        'keywords': ['ØµÙ„Ø§Ø­ÙŠØ©', 'ÙØ±ÙŠØ´', 'Ù…Ø¬Ù…Ø¯Ø©', 'Ù…ÙˆØ§Ø¹ÙŠØ¯', 'Ø¨ÙŠÙØªØ­Ùˆ Ø§Ù…ØªÙ‰'],
        'answer': (
            "Ø§Ù„ÙØ±ÙˆØ¹ Ø´ØºØ§Ù„Ø© Ù…Ù† 10 ØµØ¨Ø§Ø­Ø§Ù‹ Ù„Ù€ 12 Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„. "
            "Ø§Ù„Ø±Ù†Ø¬Ø© Ø§Ù„ÙØ±ÙŠØ´ ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§ Ø´Ù‡Ø± (ØªØ¨Ø±ÙŠØ¯)ØŒ ÙˆØ§Ù„Ù…Ø¬Ù…Ø¯Ø© 3 Ø´Ù‡ÙˆØ± (ØªØ¬Ù…ÙŠØ¯ -18)."
        )
    },
    # ------------------ 27 & 28: Ø§Ù„ÙØ³ÙŠØ® ÙˆØ§Ù„Ø¯Ù… ------------------
    {
        'keywords': ['Ø¯Ù… ÙÙŠ Ø§Ù„ÙØ³ÙŠØ®', 'ÙØ³ÙŠØ® Ø¨ÙˆØ±ÙŠ', 'Ù†ÙˆØ¹ Ø§Ù„Ø³Ù…Ùƒ', 'ØªÙ…Ù„ÙŠØ­'],
        'answer': (
            "Ø§Ù„ÙØ³ÙŠØ® Ø¨ÙˆØ±ÙŠ ÙØ±ÙŠØ´ØŒ ÙˆØ§Ù„Ø¯Ù… Ø§Ù„Ù„ÙŠ Ø¨ØªØ´ÙˆÙÙ‡ Ø¯Ù‡ Ø·Ø¨ÙŠØ¹ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ø£Ù†Ù‡ Ø¨ÙŠØªÙ…Ù„Ø­ ÙØ±ÙŠØ´ ÙˆÙŠØªØ¬Ù…Ø¯ ÙÙˆØ±Ø§Ù‹ØŒ "
            "ÙˆÙ„Ù…Ø§ Ø¨ÙŠÙÙƒ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø¯ÙŠ Ø¨ØªØ¸Ù‡Ø±ØŒ ÙˆØ¯Ù‡ Ø¯Ù„ÙŠÙ„ Ø¥Ù† Ø§Ù„Ø³Ù…ÙƒØ© Ø·Ø§Ø²Ø© Ù…Ø´ Ù…Ø±ÙƒÙˆÙ†Ø©."
        )
    },
    # ------------------ 39 & 48 & 54: Ø§Ù„Ø¨Ø·Ø§Ø±Ø® ------------------
    {
        'keywords': ['Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø·Ø§Ø±Ø®', 'Ù…Ø±Ù…Ù„Ø©', 'Ø®Ø±Ø²', 'Ù†Ø´Ùˆ', 'Ù…Ù‡Ø±ÙˆØ³Ø©'],
        'answer': "Ø¹Ù†Ø¯Ù†Ø§ Ù†ÙˆØ¹ÙŠÙ† Ø¨Ø·Ø§Ø±Ø®: Ù†Ø§Ø´ÙØ© (Ù…Ø±Ù…Ù„Ø©/Ø®Ø±Ø²) ÙˆØ·Ø±ÙŠÙ‚Ø© (Ù†Ø´Ùˆ). ÙˆÙ…ØªØ§Ø­ Ù…Ù†Ù‡Ø§ Ù…Ù‡Ø±ÙˆØ³Ø© ÙÙŠ Ø²ÙŠØª Ø£Ùˆ Ø¨Ø±Ø·Ù…Ø§Ù†Ø§Øª Ø¹Ø³Ù„ ÙˆØ¨Ø±ØªÙ‚Ø§Ù„."
    }
]
# ================== 5: Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¯ (Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶) ==================
def get_answer(user_text):
    q_clean = clean_arabic_text(user_text)

    # Ø£- ÙØ­Øµ Ø§Ù„Ù€ FAQ Ø£ÙˆÙ„Ø§Ù‹ (Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±)
    for item in FAQ:
        for kw in item['keywords']:
            if smart_similarity(q_clean, clean_arabic_text(kw)) >= 85:
                return {"text": f"âœ¨ {item['answer']}", "quick_replies": None}

    # Ø¨- ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ù…
    if any(w in q_clean for w in GREETINGS):
        if len(q_clean.split()) < 3:
            return {"text": f"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±Ù†Ø¬Ø© Ø£Ø¨Ùˆ Ø§Ù„Ø³ÙŠØ¯ ğŸ‘‹\nÙ„Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨: {WHATSAPP_NUMBER}\nØ­Ø§Ø¨Ø¨ ØªØ¹Ø±Ù Ø³Ø¹Ø± ØµÙ†Ù Ù…Ø¹ÙŠÙ†ØŸ", "quick_replies": None}

    # Ø¬- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø§Ù„Ø³Ø¹Ø±)
    matches = []
    # Ù„Ùˆ Ø§Ù„Ø¬Ù…Ù„Ø© ÙÙŠÙ‡Ø§ "Ø³Ø¹Ø±" Ø£Ùˆ "Ø¨ÙƒØ§Ù…" Ø¨Ù†Ù‚Ù„Ù„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø¹Ø´Ø§Ù† Ù†Ù„Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù†ØªØ¬
    is_price_req = any(x in q_clean for x in ['Ø³Ø¹Ø±', 'Ø¨ÙƒØ§Ù…', 'Ø¬Ù†ÙŠÙ‡', 'Ø¨Ù‚Ø¯ Ø§ÙŠÙ‡'])
    
    for p in PRODUCTS:
        for kw in p['kw']:
            score = smart_similarity(q_clean, clean_arabic_text(kw))
            threshold = 75 if is_price_req else 92
            if score >= threshold:
                matches.append(p)
                break

    if len(matches) > 1:
        qr = [{"content_type": "text", "title": m['kw'][0][:20], "payload": f"PRODUCT_INDEX|{PRODUCTS.index(m)}"} for m in matches[:10]]
        return {"text": "ğŸ›ï¸ Ø­Ø¶Ø±ØªÙƒ ØªÙ‚ØµØ¯ Ø£ÙŠ Ù†ÙˆØ¹ Ø¨Ø§Ù„Ø¸Ø¨Ø·ØŸ", "quick_replies": qr}

    if len(matches) == 1:
        p = matches[0]
        return {"text": f"ğŸ“Œ {p['kw'][0]}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: {p['price']}\nâš–ï¸ Ø§Ù„ÙˆØ²Ù†: {p['w']}", "quick_replies": None}

    # Ø¯- Ø§Ù„Ø±Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ø´ÙŠÙƒ
    return {
        "text": (
            "Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ Ø¨Ø¯Ù‚Ø©. âœ¨\n\n"
            "ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹:\n"
            f"ğŸ“± Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø·Ù„Ø¨Ø§Øª: {WHATSAPP_NUMBER}\n"
            f"ğŸ“„ ØªØµÙØ­ Ø§Ù„Ù…Ù†ÙŠÙˆ ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±: {MENU_LINK}\n\n"
            "Ø£Ùˆ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† (Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙØ±ÙˆØ¹ØŒ Ø§Ù„ØªÙˆØµÙŠÙ„ØŒ Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø±)."
        ),
        "quick_replies": None
    }

# ================== 6: Ø§Ù„Ù€ Webhook Ø§Ù„ÙÙ†ÙŠ ==================
@app.route('/webhook', methods=['GET'])
def verify():
    if request.args.get("hub.verify_token") == VERIFY_TOKEN:
        return request.args.get("hub.challenge")
    return "failed", 403

@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.get_json()
    if data.get("object") == "page":
        for entry in data.get("entry", []):
            for msg_event in entry.get("messaging", []):
                sender = msg_event["sender"]["id"]
                if "message" in msg_event:
                    msg = msg_event["message"]
                    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø²Ø±Ø§ÙŠØ± (Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹)
                    if "quick_reply" in msg:
                        payload = msg["quick_reply"]["payload"]
                        if "PRODUCT_INDEX" in payload:
                            idx = int(payload.split("|")[1])
                            p = PRODUCTS[idx]
                            send_message(sender, f"ğŸ“Œ {p['kw'][0]}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: {p['price']}\nâš–ï¸ Ø§Ù„ÙˆØ²Ù†: {p['w']}")
                    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                    elif "text" in msg:
                        res = get_answer(msg["text"])
                        send_message(sender, res["text"], res.get("quick_replies"))
    return "ok", 200

def send_message(user_id, text, quick_replies=None):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    payload = {"recipient": {"id": user_id}, "message": {"text": text}}
    if quick_replies:
        payload["message"]["quick_replies"] = quick_replies
    requests.post(url, json=payload)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))
