from flask import Flask, request
import requests
import os
import re

app = Flask(__name__)

# ================== CONFIG ==================
PAGE_ACCESS_TOKEN = "EAARosZC3fHjUBQNm1eADUNlWqXKJZAtNB4w9upKF3sLLcZCdz14diiyFFeSipgiEi4Vx1PZAvu9b46xPcHv2wjIekD8LZAhDuAqgSOcrAiqzZBXr3Unk5k269G26dSMZB1wsiCvazanjVWcgdoh8M6AzkPn4xzQUUUQ8o3XLJ0V5s7MfnZAyZAzWF3VBDvP4IWFX5050XCmWWGQZDZD"
VERIFY_TOKEN = "my_secret_token"

user_context = {}

# ================== DATA BANK (ูู ุงูุฃุณุฆูุฉ ูุงูููุชุฌุงุช) ==================

# 1. ุงูุฃุณุฆูุฉ ุงูุนุงูุฉ ูุงูุฅุฏุงุฑูุฉ
FAQ_MAP = {
    "ุฏูุฏ": "ูุง ููุฏู ุฏู ูุด ุฏูุฏุ ุฏู ุจูููู ุทููููุงุช. ุงูุทููููุงุช ูู ุณููุฉ ุงูุฑูุฌุฉ ุชูุฌุฏ ูู ุงูุชุฌููู ุงูุจุทูู ูุฃููุง ุชุฏุฎู ูู ุนูููุงุช ุงูุงูุชุตุงุต ูุงูุชูุซูู ุงูุบุฐุงุฆู ููุณููุฉ ููู ูุง ุชุตูุจ ุงูุฅูุณุงู ุชูุงูุงูุ ูุฒูุงุฏุฉ ูู ุงูููุงูุฉ ูุชู ุชุฌููุฏ ุงูุฃุณูุงู ุนูุฏ ุฏุฑุฌุฉ ูู 35 ุฅูู 40 ุชุญุช ุงูุตูุฑ ูุชุตุจุญ ุงูุทููููุงุช ุฌุฒุก ูู ุงูุฃูุนุงุก ููุง ุชุคุซุฑ ุนูู ุขูููุง...",
    "ูููู": "ุฏู ูููู ูููู ุงูููุชุฌุงุช ุจุชุงุนุชูุง ูุงูู ุจุงูุฃุณุนุงุฑ: https://heyzine.com/flip-book/31946f16d5.html",
    "ุชุฃูุฏ": "ุญุถุฑุชู ุญุงูู ุดุฑุงุก ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ูู ูุตุงุฏุฑ ููุซููุฉ ูุถูุงู ุญุตููู ุนูู ุงูููุชุฌ ุงูุฃุตูู.",
    "ุฌููู": "ููุงุณุชูุณุงุฑ ูุทูุจ ุงููุณุงุนุฏุฉ ูุฑุฌู ุงูุงุชุตุงู ุนูู ุฃุฑูุงู ุงููุตูุน: 01211113882",
    "ุณูุฏูุชุด": "ูููู ุงูุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ ุบูุฑ ูุชุงุญ ุญุงููุงู ููุง ููุฌุฏ ุชูุตูู ููุณุงูุฏููุชุดุงุช ูุงูุณูุทุฉ.",
    "ููุงุนูุฏ": "ููุงุนูุฏ ุงูุนูู ูู ุงูุณุงุนุฉ 10 ุตุจุงุญุงู ุญุชู ุงูุณุงุนุฉ 12 ููุชุตู ุงูููู.",
    "ุชุตุฏูุฑ": "ุญุถุฑุชู ุชูุงุตู ูุงุชุณุงุจ ูุน ุงูุฃุณุชุงุฐ ุฃุญูุฏ ุนูู ุฑูู 01272475555 ููู ููุณุงุนุฏ ุญุถุฑุชู.",
    "ูุดุชุฑูุงุช": "ุฑูู ุฅุฏุงุฑุฉ ุงููุดุชุฑูุงุช: 01223066445",
    "ุชูุธูู": "ุฑูู ุฅุฏุงุฑุฉ ุงูู HR ูู ุจูุฑุณุนูุฏ: 01200056103",
    "ุดูู": "ูุง ููุฌุฏ ุฑูุฌุฉ ููุดูู ููุง ุชุชุนุฑุถ ูุฃู ุญุฑุงุฑุฉุ ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ุฌุงูุฒุฉ ููุฃูู ูุจุงุดุฑุฉ ููุง ูููู ุฏูููุง ุจุงูุฒูุช.",
    "ุญูุธ": "ููุถู ุญูุธ ุงูุฑูุฌุฉ ูู ุงููุฑูุฒุฑ ุจุนุฏ ุงูุดุฑุงุก ูุถูุงู ุงูุฌูุฏุฉ.",
    "ุฏู": "ุงูุฏู ุจูููู ูุชูุฌุฉ ุงูุชูููุญ ุงููุฑูุด ูุงูุชุฌููุฏุ ูุนูุฏ ูู ุงูุชุฌููุฏ ุจุชุธูุฑ ุงูุณูุงุฆู ูุฏู ุทุจูุนู ุฌุฏุงู ูุงูุณููุฉ ุฌุงูุฒุฉ ููุฃูู.",
    "ุดูุงุน": "ุงูุฃุณุชุงุฐ ูุญูุฏ ุงูุดูุงุน ูุฏูุฑ ุงูุญุณุงุจุงุชุ ุฑูู ุงูุชูุงุตู: 01204464066",
    "ุจูุงู": "ุงูุฃุณุชุงุฐ ุจูุงู ูุณุคูู ุงูุชูุฑูุฏ ููููุงุฏู ูุงููุทุงุนูุ ุฑูู ุงูุชูุงุตู: 01221093951",
    "ุบุงูู": "ูุฃููุง ุจูุถูู ุฌูุฏุฉ ุนุงููุฉ ูุทุฑููุฉ ุชูููุญ ูุชุฏุฎูู ูุฎุชููุฉ ูุตุญูุฉ ุชูุงูุงู.",
    "ููุงุฏ ุญุงูุธู": "ูู ููุชุฌุงุชูุง ุจุฏูู ููุงุฏ ุญุงูุธุฉ ุชูุงูุงู."
}

# 2. ุชูุงุตูู ุงูููุชุฌุงุช (ููุณูุฉ ููุฌููุนุงุช ูุณูููุฉ ุงูุงุณุชุฏุนุงุก)
PRODUCTS = {
    # ูุฌููุนุฉ ุงูุฑูุฌุฉ ุงูุนุงุฏูุฉ ูุงูู 24
    "ุฑูุฌู ุณุงุฏู": "๐ฐ ุฑูุฌุฉ ูุฏุฎูุฉ: 200 EGP (1KG)",
    "ุฑูุฌู ูุฑููู": "๐ฐ ุฑูุฌุฉ ูุฏุฎูุฉ ูุจุทุฑุฎุฉ ูุฑููุฉ: 250 EGP (1KG)",
    "ุฑูุฌู 24": "๐ฐ ุฑูุฌุฉ ูุฏุฎูุฉ 24 ููุฑุงุท: 300 EGP (1KG)",
    "ุฑูุฌู 24 ูุฑููู": "๐ฐ ุฑูุฌุฉ ูุฏุฎูุฉ ูุจุทุฑุฎุฉ ูุฑููุฉ 24 ููุฑุงุท: 320 EGP (1KG)",
    "ุฑูุฌู ูุงูููู": "๐ฐ ุฑูุฌุฉ ูุฏุฎูุฉ ูุงูููู: 275 EGP (1KG)",
    "ุฑูุฌู ูุงูููู ูุจุทุฑุฎู": "๐ฐ ุฑูุฌุฉ ูุจุทุฑุฎุฉ ูุฑููุฉ ูุงูููู: 300 EGP (1KG)",
    
    # ูุฌููุนุฉ ุงูููููู
    "ููููู ุณุงุฏู": "๐ฐ ุฑูุฌุฉ ููููู ุจุฏูู ุฒูุช: 600 EGP (1KG)",
    "ููููู ูููู": "๐ฐ ุฑูุฌุฉ ููููู ุจุตูุต ุงููููู ูุงููุงููุงุฑ: 150 EGP (200G)",
    "ููููู ูุงุฑู": "๐ฐ ุฑูุฌุฉ ููููู ุจุตูุต ุงููุงุฑู: 250 EGP (250G)",
    "ููููู ุณูุฑ": "๐ฐ ุฑูุฌุฉ ููููู ุจุตูุต ุงูุณูุฑ: 180 EGP (230G)",
    "ููููู ุฒูุช": "๐ฐ ุฑูุฌุฉ ููููู ุจุงูุฒูุช ุงููุจุงุชู: 250 EGP (250G)",
    
    # ูุฌููุนุฉ ุงููุณูุฎ
    "ูุณูุฎ ุณุงุฏู": "๐ฐ ูุณูุฎ ุจุฏูู ุจูุชูุฑูุง: 460 EGP (1KG)",
    "ูุณูุฎ ูุจุทุฑุฎ": "๐ฐ ูุณูุฎ ูุจุทุฑุฎ ุจุฏูู ุจูุชูุฑูุง: 560 EGP (1KG)",
    "ูุณูุฎ ุจูุฌุฑ": "๐ฐ ูุณูุฎ ุณุจุฑูุฏ ุจุตูุต ุงูุจูุฌุฑ: 250 EGP (250G)",
    "ูุณูุฎ ูุงุฑู": "๐ฐ ูุณูุฎ ุณุจุฑูุฏ ุจุตูุต ุงููุงุฑู: 250 EGP (250G)",
    
    # ูุฌููุนุงุช ุฃุฎุฑู
    "ูุงูุฑูู": "๐ฐ ูุงูุฑูู ูุฏุฎู ูููุญ: 410 EGP (1KG)",
    "ุจุทุงุฑุฎ": "๐ฐ ุจุทุงุฑุฎ ุฑูุฌุฉ ุจุงูุฒูุช ุงููุจุงุชู: 250 EGP (250G)",
    "ุณุจุฑูุฏ": "๐ฐ ุฑูุฌุฉ ูุน ูุงููุงุฑ ุณุจุฑูุฏ: 70 EGP (130G/200G)"
}

# ================== LOGIC ==================

def normalize(text):
    if not text: return ""
    arabic_digits = "ููกูขูฃูคูฅูฆูงูจูฉ"
    english_digits = "0123456789"
    text = text.translate(str.maketrans(arabic_digits, english_digits))
    text = text.lower()
    text = re.sub(r"[ุฅุฃุขุง]", "ุง", text)
    text = re.sub(r"ุฉ", "ู", text)
    text = re.sub(r"ู", "ู", text)
    text = re.sub(r'[^\w\s]', '', text)
    return " ".join(text.split())

def get_answer(user_id, text):
    q = normalize(text)
    
    # ูููุงุช ุชุฏู ุนูู ุงูุณุคุงู ุนู ุงูุณุนุฑ ุฃู ุงููุฌูุฏ
    asking_for_info = any(word in q for word in ["ุจูุงู", "ุณุนุฑ", "ุงุณุนุงุฑ", "ูุงู", "ุนูุฏูู", "ููุฌูุฏ", "ูู", "ุจุณุชูุณุฑ", "ุจุณุงู", "ุนุงูุฒ ุงุนุฑู", "ูููุณ"])

    # --- ุชุญุฏูุฏ "ุงููุฌููุนุฉ" ุงููุณุชูุฏูุฉ ---
    target_group = None
    if "ุฑูุฌ" in q: target_group = "herring"
    if "ูุณูุฎ" in q or "ุจูุฑู" in q: target_group = "feseekh"
    if "ููููู" in q: target_group = "fillet"
    if "ูุงูุฑูู" in q: target_group = "mackerel"
    if "ุจุทุงุฑุฎ" in q: target_group = "roe"

    # ุญูุธ ุงููุฌููุนุฉ ูู ุงูุฐุงูุฑุฉ
    if target_group:
        user_context[user_id] = target_group

    # --- ุงูุฑุฏ ุงูุฐูู ุจูุงุกู ุนูู ุงูุณุคุงู ---
    if asking_for_info:
        current_target = target_group or user_context.get(user_id)
        
        # 1. ูู ุญุฏุฏ ููููู (ูุฑุณู ูู ุงูููููู)
        if current_target == "fillet" or "ููููู" in q:
            res = "ุฅููู ุฃุณุนุงุฑ ุงูุฑูุฌุฉ ุงูููููู ุงููุชุงุญุฉ:\n"
            for k, v in PRODUCTS.items():
                if "ููููู" in k: res += f"- {v}\n"
            return res

        # 2. ูู ุณุฃู ุนู ุงูุฑูุฌุฉ ุจุดูู ุนุงู (ูุฑุณู ุฃููุงุน ุงูุฑูุฌุฉ ูุงูู 24)
        if current_target == "herring":
            if "24" in q: # ูู ุฎุตุต 24
                return f"ุฃุณุนุงุฑ ุฑูุฌุฉ ุนูุงุฑ 24:\n- {PRODUCTS['ุฑูุฌู 24']}\n- {PRODUCTS['ุฑูุฌู 24 ูุฑููู']}"
            res = "ุฅููู ุฃููุงุน ูุฃุณุนุงุฑ ุงูุฑูุฌุฉ ุงููุชููุฑุฉ:\n"
            for k, v in PRODUCTS.items():
                if "ุฑูุฌู" in k: res += f"- {v}\n"
            return res

        # 3. ูู ุณุฃู ุนู ุงููุณูุฎ
        if current_target == "feseekh":
            res = "ุฃุณุนุงุฑ ุงููุณูุฎ ุจุฏูู ุจูุชูุฑูุง:\n"
            for k, v in PRODUCTS.items():
                if "ูุณูุฎ" in k: res += f"- {v}\n"
            return res

        # 4. ูู ูู ูุญุฏุฏ ุตูู (ุฑุฏ ุนุงู)
        if not current_target:
            return "ุชุญุช ุฃูุฑู ูุง ููุฏูุ ุญุงุจุจ ุชุนุฑู ุฃุณุนุงุฑ ุฅููุ ุนูุฏูุง (ุฑูุฌุฉุ ูุณูุฎุ ูููููุ ูุงูุฑููุ ุจุทุงุฑุฎ) ุฃู ูููู ุชุดูู ุงููููู ููุง: " + FAQ_MAP["ูููู"]

    # --- ุงูุจุญุซ ูู ุงูุฃุณุฆูุฉ ุงูุนุงูุฉ FAQ ---
    if any(w in q for w in ["ุฏูุฏ", "ุทููููุงุช"]): return FAQ_MAP["ุฏูุฏ"]
    if "ูููู" in q: return FAQ_MAP["ูููู"]
    if "ููุงุนูุฏ" in q or "ูุฑุน" in q: return FAQ_MAP["ููุงุนูุฏ"]
    if "ุดูู" in q or "ูุณุฎู" in q: return FAQ_MAP["ุดูู"]
    if "ุฏู" in q: return FAQ_MAP["ุฏู"]
    if "ุฌููู" in q: return FAQ_MAP["ุฌููู"]
    if "ุชุตุฏูุฑ" in q: return FAQ_MAP["ุชุตุฏูุฑ"]
    if "ูุดุชุฑูุงุช" in q: return FAQ_MAP["ูุดุชุฑูุงุช"]
    if "ุชูุธูู" in q: return FAQ_MAP["ุชูุธูู"]
    if "ุจูุงู" in q: return FAQ_MAP["ุจูุงู"]
    if "ุดูุงุน" in q: return FAQ_MAP["ุดูุงุน"]

    # --- ุงูุชุฑุญูุจ ---
    if any(w in q for w in ["ุงููุง", "ุณูุงู", "ุงุฒูู", "ูุงู"]):
        return "ุฃููุงู ุจู ูู ุฑูุฌุฉ ุฃุจู ุงูุณูุฏ ๐ ุฃุตู ุงูุฑูุฌุฉ ูุงููุณูุฎ.. ุชุญุจ ุฃุจุนุชูู ุงููููู ููุง ุญุงุจุจ ุชุณุชูุณุฑ ุนู ุณุนุฑ ุตูู ูุนููุ"

    return "ุชุญุช ุฃูุฑู ูุง ููุฏูุ ูููู ุชูุถุญ ุณุคุงููุ ูู ุจุชุณุชูุณุฑ ุนู ุณุนุฑ ููุชุฌ ูุนูู ุฃู ููุงุนูุฏ ุงููุฑูุนุ"

# ================== WEBHOOK ==================

@app.route("/webhook", methods=["GET", "POST"])
def webhook():
    if request.method == "GET":
        if request.args.get("hub.verify_token") == VERIFY_TOKEN:
            return request.args.get("hub.challenge")
        return "failed", 403
    
    data = request.get_json()
    if data.get("object") == "page":
        for entry in data.get("entry", []):
            for ev in entry.get("messaging", []):
                sender_id = ev["sender"]["id"]
                if "message" in ev and "text" in ev["message"]:
                    if ev["message"].get("is_echo"): continue
                    reply = get_answer(sender_id, ev["message"]["text"])
                    send_message(sender_id, reply)
    return "ok", 200

def send_message(user_id, text):
    url = f"https://graph.facebook.com/v12.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    requests.post(url, json={"recipient": {"id": user_id}, "message": {"text": text}})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))
